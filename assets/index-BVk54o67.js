const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/DashboardView-yNVYhqHW.js","assets/vue-B-cAkLc6.js","assets/vendor-C7jwa7K6.js","assets/DashboardView-D1D3HgxO.css","assets/LoginView-doxgsLQ-.js","assets/LoginView-Le-ML0Z5.css","assets/CRMListView-B9MBn_zV.js","assets/CRMListView-BQNjGP9A.css","assets/CRMDetailView-fJ7vZiky.js","assets/CRMDetailView-BG4aKxMd.css","assets/ProjectListView-Ch4-oZJt.js","assets/ProjectDetailView-C-b3pcKq.js","assets/ProjectDetailView-CWf49nOI.css","assets/ProjectListView-BFoi-uq7.css","assets/InventoryView-BrDAfUmR.js","assets/InventoryView-U51k3zaL.css","assets/AccountingView-D2cGG6yQ.js","assets/AccountingView-BPzt1JRj.css","assets/EmployeeView-DQZ0FROp.js","assets/EmployeeView-C3m8j_-6.css","assets/SupplierView-BTHlGQDT.js","assets/SupplierView-zPfCcM0x.css","assets/SettingsView-iPUbgfAX.js","assets/SettingsView-iQT32yoK.css","assets/NotFoundView-BclCt5CO.js","assets/NotFoundView-CHNnA2bW.css"])))=>i.map(i=>d[i]);
import{d as e,r as t,c as a,a as r,u as n,b as s,s as i,e as l,f as o,o as c,g as u,F as d,h as p,i as m,n as h,w as v,j as y,t as f,k as _,l as g,m as w,R as b,p as I,q as A,v as P,x as E}from"./vue-B-cAkLc6.js";import{c as R,_ as j}from"./vendor-C7jwa7K6.js";function O(e,t){var a;return e="object"==typeof(a=e)&&null!==a?e:Object.create(null),new Proxy(e,{get:(e,a,r)=>"key"===a?Reflect.get(e,a,r):Reflect.get(e,a,r)||Reflect.get(t,a,r)})}function L(e,{storage:t,serializer:a,key:r,debug:n}){try{const n=null==t?void 0:t.getItem(r);n&&e.$patch(null==a?void 0:a.deserialize(n))}catch(s){}}function D(e,{storage:t,serializer:a,key:r,paths:n,debug:s}){try{const s=Array.isArray(n)?function(e,t){return t.reduce((t,a)=>{const r=a.split(".");return function(e,t,a){return t.slice(0,-1).reduce((e,t)=>/^(__proto__)$/.test(t)?{}:e[t]=e[t]||{},e)[t[t.length-1]]=a,e}(t,r,function(e,t){return t.reduce((e,t)=>null==e?void 0:e[t],e)}(e,r))},{})}(e,n):e;t.setItem(r,a.serialize(s))}catch(i){}}!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var S=function(e={}){return t=>{const{auto:a=!1}=e,{options:{persist:r=a},store:n,pinia:s}=t;if(!r)return;if(!(n.$id in s.state.value)){const e=s._s.get(n.$id.replace("__hot:",""));return void(e&&Promise.resolve().then(()=>e.$persist()))}const i=(Array.isArray(r)?r.map(t=>O(t,e)):[O(r,e)]).map(function(e,t){return a=>{var r;try{const{storage:n=localStorage,beforeRestore:s,afterRestore:i,serializer:l={serialize:JSON.stringify,deserialize:JSON.parse},key:o=t.$id,paths:c=null,debug:u=!1}=a;return{storage:n,beforeRestore:s,afterRestore:i,serializer:l,key:(null!=(r=e.key)?r:e=>e)("string"==typeof o?o:o(t.$id)),paths:c,debug:u}}catch(n){return a.debug,null}}}(e,n)).filter(Boolean);n.$persist=()=>{i.forEach(e=>{D(n.$state,e)})},n.$hydrate=({runHooks:e=!0}={})=>{i.forEach(a=>{const{beforeRestore:r,afterRestore:s}=a;e&&(null==r||r(t)),L(n,a),e&&(null==s||s(t))})},i.forEach(e=>{const{beforeRestore:a,afterRestore:r}=e;null==a||a(t),L(n,e),null==r||r(t),n.$subscribe((t,a)=>{D(a,e)},{detached:!0})})}}();const q=R("https://yuyxhxsrvbpauvadrppc.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1eXhoeHNydmJwYXV2YWRycHBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODQzNTQsImV4cCI6MjA2ODY2MDM1NH0.VLz_X7N2gisz59c2taxxT-WN_TNT2ayfaIYUAj_yS4A",{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"},global:{headers:{"X-Client-Info":"supabase-js-web"}},db:{schema:"public"}}),k={1:"employee",2:"manager",3:"accounting",4:"inventory_manager"},V=e("auth",()=>{const e=t(null),r=t(null),n=a(()=>!!r.value),s=a(()=>{var t;return(null==(t=e.value)?void 0:t.role)&&k[e.value.role]||null});let i=!1;return setTimeout(()=>{i||(i=!0,q.auth.onAuthStateChange(async(t,a)=>{if("INITIAL_SESSION"!==t)if("SIGNED_OUT"===t)r.value=null,e.value=null;else if("SIGNED_IN"===t&&a){r.value=a;try{const{data:t}=await q.from("staff").select("*").eq("mail",a.user.email).single();t&&(e.value=t)}catch(n){}}else"TOKEN_REFRESHED"===t&&a&&(r.value=a)}))},1e3),{user:e,session:r,isAuthenticated:n,userRole:s,login:async(t,a)=>{const{data:n,error:s}=await q.auth.signInWithPassword({email:t,password:a});if(s)throw new Error(`登入失敗：${s.message}`);if(!n.user||!n.session)throw new Error("登入失敗：未能取得使用者資料");r.value=n.session;try{const{data:a,error:n}=await q.from("staff").select("*").eq("mail",t).is("deleted_at",null).single();if(n||!a)throw await q.auth.signOut(),r.value=null,new Error("找不到員工資料，請聯繫系統管理員");e.value=a}catch(i){throw await q.auth.signOut(),r.value=null,i}return n},logout:async()=>{await q.auth.signOut(),e.value=null,r.value=null,localStorage.removeItem("auth-store")},checkAuth:async()=>{if(r.value&&e.value){const e=Date.now()/1e3;if((r.value.expires_at||0)>e)return!0}try{const{data:{session:a},error:n}=await q.auth.getSession();if(n)return!(!r.value&&!e.value||n.message.includes("invalid"))||(r.value=null,e.value=null,!1);if(a){if(r.value=a,!e.value)try{const t=a.user.email,{data:r,error:n}=await q.from("staff").select("*").eq("mail",t).is("deleted_at",null).single();!n&&r&&(e.value=r)}catch(t){}return!0}return r.value=null,e.value=null,!1}catch(a){return a.message&&a.message.includes("invalid")?(r.value=null,e.value=null,!1):!(!r.value&&!e.value)}}}},{persist:{key:"auth-store",storage:localStorage,paths:["user","session"],serializer:{serialize:e=>{var t;const a={...e};if(null==(t=a.session)?void 0:t.expires_at){const e=1e3*a.session.expires_at;Date.now()>e&&(a.session=null,a.user=null)}return JSON.stringify(a)},deserialize:e=>{var t;try{const a=JSON.parse(e);if(null==(t=a.session)?void 0:t.expires_at){const e=1e3*a.session.expires_at;Date.now()>e&&(a.session=null,a.user=null)}return a}catch(a){return{user:null,session:null}}}}}});function T(){const e=t(!1),a=t(null),r=async t=>{e.value=!0,a.value=null;try{const{data:e,error:r}=await t();return r?(a.value=r.message||"發生未知錯誤",null):e}catch(r){return a.value=r instanceof Error?r.message:"發生未知錯誤",null}finally{e.value=!1}},n=async(e,t,a)=>r(async()=>{let r=q.from(e).select(t||"*");return a&&Object.entries(a).forEach(([e,t])=>{r=r.eq(e,t)}),r}),s=async(e,t)=>r(()=>q.from(e).insert(t).select().single()),i=async(e,t,a)=>r(()=>q.from(e).update(a).eq("id",t).select().single()),l=async(e,t)=>null!==await r(()=>q.from(e).delete().eq("id",t));return{loading:e,error:a,query:n,insert:s,update:i,remove:l,getReminders:async()=>n("reminders","*",{completed:!1}),markReminderDone:async(e,t)=>i("reminders",t,{completed:!0,completed_at:(new Date).toISOString()}),callAPI:async e=>{const{table:t,action:a,data:r,filters:o,select:c}=e;switch(a){case"create":return s(t,r);case"read":return n(t,c,o);case"update":if(!(null==r?void 0:r.id))throw new Error("Update action requires data.id");const{id:e,...u}=r;return i(t,e,u);case"delete":if(!(null==r?void 0:r.id))throw new Error("Delete action requires data.id");return l(t,r.id);default:throw new Error(`Unsupported action: ${a}`)}}}}const N=e("data",()=>{const e=T(),a=t([]),r=t([]),n=t(null),s=t([]),i=t(null),l=t([]),o=t([]),c=t([]),u=t([]),d=t([]),p=t([]),m=async()=>{try{const t=await e.callAPI({table:"reminder",action:"read"});t&&(a.value=t)}catch(t){}},h=async()=>{try{const t=await e.callAPI({table:"crm",action:"read"});t&&(r.value=t)}catch(t){}},v=async()=>{try{const t=await e.callAPI({table:"project",action:"read"});t&&(s.value=t)}catch(t){}},y=async()=>{try{const t=await e.callAPI({table:"inventory",action:"read"});t&&(l.value=t)}catch(t){}},f=async()=>{try{const t=await e.callAPI({table:"account_receivable",action:"read"});t&&(o.value=t)}catch(t){}},_=async()=>{try{const t=await e.callAPI({table:"account_payable",action:"read"});return t&&(c.value=t),t||[]}catch(t){return[]}},g=f,w=async()=>{try{const t=await e.callAPI({table:"supplier",action:"read"});t&&(u.value=t)}catch(t){}},b=async()=>{var t,a;try{const t=await e.callAPI({table:"staff",action:"read"});t&&(d.value=t)}catch(r){((null==(t=r.message)?void 0:t.includes("401"))||(null==(a=r.message)?void 0:a.includes("Unauthorized")))&&(d.value=[])}},I=async()=>{try{const t=await e.callAPI({table:"tag",action:"read"});t&&(p.value=t)}catch(t){}};return{reminders:a,crmList:r,currentCRM:n,projectList:s,currentProject:i,inventoryList:l,paymentRequests:o,accountPayable:c,supplier:u,employee:d,tags:p,refreshReminders:m,markReminderComplete:async(t,r)=>{await e.markReminderDone(t,r)&&(a.value=a.value.filter(e=>{var a;return!(e.type===t&&(null==(a=e.modal_payload)?void 0:a.id)===r)}))},fetchCRMList:h,createCRM:async t=>{try{const a=await e.callAPI({table:"crm",action:"create",data:t});return a?(r.value.push(a),a):null}catch(a){return null}},updateCRM:async(t,a)=>{try{const n=await e.callAPI({table:"crm",action:"update",data:{id:t,...a}});if(n){const e=r.value.findIndex(e=>e.id===t);return-1!==e&&(r.value[e]=n),n}return null}catch(n){return null}},fetchProjectList:v,createProject:async t=>{try{const a=await e.callAPI({table:"project",action:"create",data:t});return a?(s.value.push(a),a):null}catch(a){return null}},fetchInventoryList:y,updateInventory:async(t,a,r,n)=>{try{const n=l.value.find(e=>e.id===t);if(!n)return!1;const s="out"===r?-a:a,i=(n.total_stock||0)+s,o=await e.callAPI({table:"inventory",action:"update",data:{id:t,total_stock:i,updated_at:(new Date).toISOString()}});return o&&(await e.callAPI({table:"inventory_adjustment",action:"create",data:{inventory_id:t,type:r,adjust_quantity:s,created_at:(new Date).toISOString()}}),await y()),!!o}catch(s){return!1}},fetchAccountReceivable:f,fetchAccountPayable:_,createAccountReceivable:async t=>{try{const a=await e.callAPI({table:"account_receivable",action:"create",data:t});return a?(o.value.push(a),a):null}catch(a){return null}},updateAccountReceivable:async(t,a)=>{try{const r=await e.callAPI({table:"account_receivable",action:"update",data:{id:t,...a}});if(r){const e=o.value.findIndex(e=>e.id===t);-1!==e&&(o.value[e]=r)}return r}catch(r){return null}},fetchPaymentRequests:g,createPaymentRequest:async t=>{try{const a=await e.callAPI({table:"payment_request",action:"create",data:t});return a&&await g(),a}catch(a){throw a}},refreshData:async()=>{try{await Promise.all([h(),v(),y(),f(),_(),w(),b(),I(),m()])}catch(e){}},fetchSupplierList:w,fetchEmployeeList:b,fetchTagList:I}},{persist:{key:"data-store",storage:localStorage,paths:["crmList","projectList","inventoryList","supplier","employee","tags"]}}),z={class:"top-navigation"},x={class:"nav-container"},C={class:"nav-items"},M={class:"nav-label"},$={key:0,class:"nav-badge"},J={class:"user-section"},U={class:"user-info"},X={class:"user-name"},Y={class:"user-email"},F=(e,t)=>{const a=e.__vccOpts||e;for(const[r,n]of t)a[r]=n;return a},H=F(r({__name:"BottomNavigation",setup(e){const t=n(),r=s(),g=V(),w=N(),{user:b}=i(g),I=a(()=>{var e,t;return(null==(t=null==(e=w.reminders)?void 0:e.filter(e=>!e.completed))?void 0:t.length)||0}),A=a(()=>[{path:"/",label:"工作台",badge:I.value>0?I.value:void 0},{path:"/crm",label:"客戶管理"},{path:"/project",label:"專案管理"},{path:"/inventory",label:"庫存管理"},{path:"/employee",label:"員工資料"},{path:"/supplier",label:"供應商"},{path:"/accounting",label:"會計財務"},{path:"/settings",label:"設定"}]),P=async()=>{try{await g.logout(),r.push("/login")}catch(e){}};return(e,a)=>{var r,n;const s=l("router-link");return c(),o("nav",z,[u("div",x,[u("div",C,[(c(!0),o(d,null,p(A.value,e=>{return c(),m(s,{key:e.path,to:e.path,class:h(["nav-item",{"nav-item--active":(a=e.path,"/"===a?"/"===t.path:t.path.startsWith(a))}])},{default:v(()=>[u("span",M,f(e.label),1),e.badge?(c(),o("div",$,f(e.badge),1)):y("",!0)]),_:2},1032,["to","class"]);var a}),128))]),u("div",J,[u("div",U,[u("span",X,f(null==(r=_(b))?void 0:r.name),1),u("span",Y,f(null==(n=_(b))?void 0:n.mail),1)]),u("button",{onClick:P,class:"logout-btn"}," 登出 ")])])])}}}),[["__scopeId","data-v-d83beb97"]]),W={id:"app"},B=r({__name:"App",setup(e){const t=n(),r=V();g(async()=>{await new Promise(e=>setTimeout(e,100));try{await r.checkAuth()}catch(e){}});const s=a(()=>{const e=["/login"].some(e=>t.path.startsWith(e));return(r.isAuthenticated||r.session||r.user)&&!e});return(e,t)=>(c(),o("div",W,[w(_(b)),s.value?(c(),m(H,{key:0})):y("",!0)]))}}),G=I({history:A("/es/"),routes:[{path:"/",name:"dashboard",component:()=>j(()=>import("./DashboardView-yNVYhqHW.js"),__vite__mapDeps([0,1,2,3])),meta:{requiresAuth:!0}},{path:"/login",name:"login",component:()=>j(()=>import("./LoginView-doxgsLQ-.js"),__vite__mapDeps([4,1,2,5])),meta:{requiresAuth:!1}},{path:"/crm",name:"crm-list",component:()=>j(()=>import("./CRMListView-B9MBn_zV.js"),__vite__mapDeps([6,1,2,7])),meta:{requiresAuth:!0}},{path:"/crm/:id",name:"crm-detail",component:()=>j(()=>import("./CRMDetailView-fJ7vZiky.js"),__vite__mapDeps([8,1,2,9])),meta:{requiresAuth:!0}},{path:"/project",name:"project-list",component:()=>j(()=>import("./ProjectListView-Ch4-oZJt.js"),__vite__mapDeps([10,1,11,2,12,13])),meta:{requiresAuth:!0}},{path:"/project/:id",name:"project-detail",component:()=>j(()=>import("./ProjectDetailView-C-b3pcKq.js"),__vite__mapDeps([11,1,2,12])),meta:{requiresAuth:!0}},{path:"/inventory",name:"inventory",component:()=>j(()=>import("./InventoryView-BrDAfUmR.js"),__vite__mapDeps([14,1,2,15])),meta:{requiresAuth:!0}},{path:"/accounting",name:"accounting",component:()=>j(()=>import("./AccountingView-D2cGG6yQ.js"),__vite__mapDeps([16,1,2,17])),meta:{requiresAuth:!0}},{path:"/employee",name:"employee",component:()=>j(()=>import("./EmployeeView-DQZ0FROp.js"),__vite__mapDeps([18,1,2,19])),meta:{requiresAuth:!0}},{path:"/supplier",name:"supplier",component:()=>j(()=>import("./SupplierView-BTHlGQDT.js"),__vite__mapDeps([20,1,2,21])),meta:{requiresAuth:!0}},{path:"/settings",name:"settings",component:()=>j(()=>import("./SettingsView-iPUbgfAX.js"),__vite__mapDeps([22,1,2,23])),meta:{requiresAuth:!0}},{path:"/:pathMatch(.*)*",name:"not-found",component:()=>j(()=>import("./NotFoundView-BclCt5CO.js"),__vite__mapDeps([24,1,2,25]))}]});G.beforeEach(async(e,t,a)=>{try{const t=V();if(e.meta.requiresAuth&&!t.isAuthenticated&&(t.session||t.user||await new Promise(e=>setTimeout(e,50)),await t.checkAuth()),e.meta.requiresAuth&&!t.isAuthenticated)return void a("/login");if("login"===e.name&&t.isAuthenticated)return void a("/");if(e.meta.roles&&t.user){const r=t.user.role;if(!e.meta.roles.includes(r))return void a("/")}a()}catch(r){"login"!==e.name&&"test"!==e.name?a("/login"):a()}});const Q=P(B),Z=E();Z.use(S),Q.use(Z),Q.use(G),Q.mount("#app");export{F as _,N as a,T as b,q as s,V as u};
