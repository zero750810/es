import{a as e,v as a,r as l,c as t,B as u,j as r,e as s,f as o,i as n,z as i,A as c,C as v,F as d,g as p,l as m,E as y,t as b,y as f,k as g,n as _,u as h,x as j,o as w}from"./vue-CVAoqndi.js";import{a as k,b as C,_ as x}from"./index-__4lFO6p.js";import A from"./ProjectDetailView-CilzQUyt.js";import"./vendor-C7jwa7K6.js";const L={class:"project-list"},S={class:"page-header"},V={class:"filters"},U=["value"],D=["value"],P=["value"],N={key:0,class:"loading"},T={key:1,class:"empty-state"},q={key:2,class:"project-list-container"},E={class:"project-list-body"},F=["onClick"],M={class:"row-name"},z={class:"project-title"},B={key:0,class:"project-tag"},Y={class:"row-date"},$={class:"row-customer"},I={class:"row-executor"},R={class:"row-status"},W={class:"row-amount"},G={class:"modal-header"},H={class:"form-group"},J={class:"form-group"},K={class:"searchable-select"},O={key:0,class:"dropdown-list"},Q=["onMousedown"],X={key:0,class:"dropdown-empty"},Z={class:"form-group"},ee=["value"],ae={class:"form-group"},le=["value"],te={class:"form-group"},ue=["value"],re={class:"form-group"},se={class:"form-group"},oe={class:"modal-actions"},ne=["disabled"],ie={class:"modal-header"},ce={class:"modal-body detail-modal-body"},ve=x(e({__name:"ProjectListView",setup(e){const x=h(),ve=j(),de=k(),pe=C(),{projectList:me,crmList:ye,tags:be}=a(de),{loading:fe}=pe,ge=l(""),_e=l(""),he=l(""),je=l(""),we=l(""),ke=l(!1),Ce=l(!1),xe=l(!1),Ae=l(null),Le=t(()=>de.employee||[]),Se=t(()=>{if(!be||!be.value)return[];return(be.value||[]).filter(e=>"project"===e.type)}),Ve=t(()=>{if(!be||!be.value)return[];return(be.value||[]).filter(e=>"project_state"===e.type)}),Ue=l(""),De=l(!1),Pe=l(null),Ne=t(()=>{if(!ye||!ye.value)return[];const e=ye.value||[];return Ue.value?e.filter(e=>e.name.toLowerCase().includes(Ue.value.toLowerCase())):e}),Te=t(()=>{try{const e=new Set;if(!me||!me.value||!Array.isArray(me.value))return[];return me.value.forEach(a=>{a&&a.tag_course&&e.add(a.tag_course)}),Array.from(e).sort()}catch(e){return[]}}),qe=t(()=>{try{const e=new Set;if(!me||!me.value||!Array.isArray(me.value))return[];return me.value.forEach(a=>{if(a&&a.created_at){const l=new Date(a.created_at).getFullYear();e.add(l)}}),Array.from(e).sort((e,a)=>a-e)}catch(e){return[]}}),Ee=l({project_name:"",crm_id:"",tag_course:"",project_state:"",executor_id:"",receivable:0,final:""}),Fe=t(()=>{try{if(!me||!me.value||!Array.isArray(me.value))return[];let e=me.value.filter(e=>{if(!e)return!1;const a=!!e.project_name&&e.project_name.toLowerCase().includes(ge.value.toLowerCase()),l=!_e.value||e.state===_e.value,t=!he.value||e.executor_id===he.value,u=!je.value||e.tag_course===je.value;let r=!0;if(we.value&&e.created_at){r=new Date(e.created_at).getFullYear()===Number(we.value)}return a&&l&&t&&u&&r});return e.sort((e,a)=>e.created_at&&a.created_at?new Date(a.created_at).getTime()-new Date(e.created_at).getTime():0),e}catch(e){return[]}}),Me=e=>{try{if(!e)return"未指定";if(!ye||!ye.value||!Array.isArray(ye.value))return"未指定";const a=ye.value.find(a=>a&&a.id==Number(e));return(null==a?void 0:a.name)||"未指定"}catch(a){return"未指定"}},ze=e=>{try{if(!e)return"未指定";if(!Le||!Le.value||!Array.isArray(Le.value))return"未指定";const a=Le.value.find(a=>a&&a.id==e);return a?a.name:e}catch(a){return"未指定"}},Be=e=>{try{if(!e)return"";if(!be||!be.value||!Array.isArray(be.value))return e.toString();const a=be.value;if("number"==typeof e||/^\d+$/.test(e.toString())){const l=a.find(a=>a&&a.id===Number(e));return l?l.name:e.toString()}return e.toString()}catch(a){return e?e.toString():""}},Ye=l([{value:0,name:"接洽中",description:"與客戶進行初步接觸洽談",color:"#6b7280",cssClass:"status-negotiating"},{value:1,name:"執行中",description:"專案正在執行進行中",color:"#3b82f6",cssClass:"status-executing"},{value:2,name:"執行中(出貨)",description:"專案執行中，準備出貨",color:"#f59e0b",cssClass:"status-shipping"},{value:3,name:"待請款",description:"專案完成，等待請款",color:"#10b981",cssClass:"status-billing"},{value:4,name:"結案",description:"專案已完成並結案",color:"#059669",cssClass:"status-completed"},{value:5,name:"未接成",description:"專案未能達成協議",color:"#ef4444",cssClass:"status-failed"}]),$e=e=>{const a=e.state||0,l=Ye.value.find(e=>e.value===a);return l?l.cssClass:"status-negotiating"},Ie=e=>{const a=e.state||0,l=Ye.value.find(e=>e.value===a);return l?l.name:"接洽中"},Re=()=>{setTimeout(()=>{De.value=!1,Pe.value||(Ue.value="",Ee.value.crm_id="")},200)},We=()=>{ke.value=!1,Ce.value=!1,Ee.value={project_name:"",crm_id:"",tag_course:"",project_state:"",executor_id:"",receivable:0,final:""},Ue.value="",Pe.value=null,De.value=!1,Ae.value=null},Ge=async()=>{xe.value=!0;try{ke.value?await de.createProject(Ee.value):Ae.value&&(await pe.update("project",Ae.value.id,Ee.value),await de.fetchProjectList()),We()}catch(e){}finally{xe.value=!1}},He=l(!1),Je=l(null),Ke=e=>{Je.value=e,He.value=!0},Oe=()=>{He.value=!1,Je.value=null},Qe=async()=>{await de.fetchProjectList(),Oe()},Xe=()=>{const e=x.query.id||x.query.project;if(e&&me.value){const a=me.value.find(a=>a.id.toString()===e.toString());a&&(Ke(a),ve.replace({path:x.path}))}};return u(()=>x.query,()=>{me.value&&me.value.length>0&&Xe()},{immediate:!0}),u(()=>me.value,e=>{e&&e.length>0&&Xe()}),r(async()=>{try{await Promise.all([de.fetchProjectList(),de.fetchCRMList(),de.fetchEmployeeList(),de.fetchTagList()])}catch(e){}}),(e,a)=>(w(),s("div",L,[o("div",S,[a[16]||(a[16]=o("h1",null,"專案管理",-1)),o("button",{onClick:a[0]||(a[0]=e=>ke.value=!0),class:"btn btn-primary"}," 新增專案 ")]),o("div",V,[i(o("input",{"onUpdate:modelValue":a[1]||(a[1]=e=>ge.value=e),type:"text",placeholder:"搜尋專案名稱...",class:"search-input"},null,512),[[c,ge.value]]),i(o("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>_e.value=e),class:"filter-select"},a[17]||(a[17]=[o("option",{value:""},"所有狀態",-1),o("option",{value:"planning"},"規劃中",-1),o("option",{value:"executing"},"執行中",-1),o("option",{value:"completed"},"已完成",-1)]),512),[[v,_e.value]]),i(o("select",{"onUpdate:modelValue":a[3]||(a[3]=e=>he.value=e),class:"filter-select"},[a[18]||(a[18]=o("option",{value:""},"所有負責人",-1)),(w(!0),s(d,null,p(Le.value,e=>(w(),s("option",{key:e.id,value:e.id},b(e.name),9,U))),128))],512),[[v,he.value]]),i(o("select",{"onUpdate:modelValue":a[4]||(a[4]=e=>je.value=e),class:"filter-select"},[a[19]||(a[19]=o("option",{value:""},"所有專案標籤",-1)),(w(!0),s(d,null,p(Te.value,e=>(w(),s("option",{key:String(e),value:String(e)},b(Be(e)),9,D))),128))],512),[[v,je.value]]),i(o("select",{"onUpdate:modelValue":a[5]||(a[5]=e=>we.value=e),class:"filter-select"},[a[20]||(a[20]=o("option",{value:""},"所有年份",-1)),(w(!0),s(d,null,p(qe.value,e=>(w(),s("option",{key:Number(e),value:Number(e)},b(e),9,P))),128))],512),[[v,we.value]])]),m(fe)?(w(),s("div",N,"載入中...")):0===Fe.value.length?(w(),s("div",T,a[21]||(a[21]=[o("div",{class:"empty-icon"},"📂",-1),o("p",null,"尚無專案資料",-1)]))):(w(),s("div",q,[a[22]||(a[22]=y('<div class="project-list-header" data-v-ad75b6b0><div class="header-name" data-v-ad75b6b0>專案名稱</div><div class="header-date" data-v-ad75b6b0>活動日期</div><div class="header-customer" data-v-ad75b6b0>客戶</div><div class="header-executor" data-v-ad75b6b0>負責人</div><div class="header-status" data-v-ad75b6b0>狀態</div><div class="header-amount" data-v-ad75b6b0>應收金額</div></div>',1)),o("div",E,[(w(!0),s(d,null,p(Fe.value,e=>{return w(),s("div",{key:e.id,class:"project-row",onClick:a=>Ke(e)},[o("div",M,[o("div",z,b(e.project_name),1),e.tag_course?(w(),s("div",B,b(Be(e.tag_course)),1)):n("",!0)]),o("div",Y,b((a=e.d_day,a?new Date(a).toLocaleDateString("zh-TW"):"未設定")),1),o("div",$,b(Me(e.crm_id)),1),o("div",I,b(ze(e.executor_id)),1),o("div",R,[o("span",{class:_(["status-badge",$e(e)])},b(Ie(e)),3)]),o("div",W,"NT$ "+b(e.receivable.toLocaleString()),1)],8,F);var a}),128))])])),ke.value||Ce.value?(w(),s("div",{key:3,class:"modal-overlay",onClick:We},[o("div",{class:"modal",onClick:a[14]||(a[14]=f(()=>{},["stop"]))},[o("div",G,[o("h2",null,b(ke.value?"新增專案":"編輯專案"),1),o("button",{onClick:We,class:"close-btn"},"×")]),o("form",{onSubmit:f(Ge,["prevent"]),class:"modal-body"},[o("div",H,[a[23]||(a[23]=o("label",null,"專案名稱 *",-1)),i(o("input",{"onUpdate:modelValue":a[6]||(a[6]=e=>Ee.value.project_name=e),type:"text",required:""},null,512),[[c,Ee.value.project_name]])]),o("div",J,[a[24]||(a[24]=o("label",null,"客戶 *",-1)),o("div",K,[i(o("input",{"onUpdate:modelValue":a[7]||(a[7]=e=>Ue.value=e),onFocus:a[8]||(a[8]=e=>De.value=!0),onBlur:Re,type:"text",placeholder:"輸入客戶名稱搜尋...",required:""},null,544),[[c,Ue.value]]),De.value?(w(),s("div",O,[(w(!0),s(d,null,p(Ne.value,e=>(w(),s("div",{key:e.id,onMousedown:a=>(e=>{Pe.value=e,Ee.value.crm_id=e.id,Ue.value=e.name,De.value=!1})(e),class:"dropdown-item"},b(e.name),41,Q))),128)),0===Ne.value.length?(w(),s("div",X," 找不到符合的客戶 ")):n("",!0)])):n("",!0)])]),o("div",Z,[a[26]||(a[26]=o("label",null,"活動類型",-1)),i(o("select",{"onUpdate:modelValue":a[9]||(a[9]=e=>Ee.value.tag_course=e)},[a[25]||(a[25]=o("option",{value:""},"請選擇活動類型",-1)),(w(!0),s(d,null,p(Se.value,e=>(w(),s("option",{key:e.id,value:e.id},b(e.name),9,ee))),128))],512),[[v,Ee.value.tag_course]])]),o("div",ae,[a[28]||(a[28]=o("label",null,"專案狀態",-1)),i(o("select",{"onUpdate:modelValue":a[10]||(a[10]=e=>Ee.value.project_state=e)},[a[27]||(a[27]=o("option",{value:""},"請選擇專案狀態",-1)),(w(!0),s(d,null,p(Ve.value,e=>(w(),s("option",{key:e.id,value:e.id},b(e.name),9,le))),128))],512),[[v,Ee.value.project_state]])]),o("div",te,[a[30]||(a[30]=o("label",null,"負責人",-1)),i(o("select",{"onUpdate:modelValue":a[11]||(a[11]=e=>Ee.value.executor_id=e)},[a[29]||(a[29]=o("option",{value:""},"請選擇負責人",-1)),(w(!0),s(d,null,p(Le.value,e=>(w(),s("option",{key:e.id,value:e.id},b(e.name),9,ue))),128))],512),[[v,Ee.value.executor_id]])]),o("div",re,[a[31]||(a[31]=o("label",null,"應收金額",-1)),i(o("input",{"onUpdate:modelValue":a[12]||(a[12]=e=>Ee.value.receivable=e),type:"number",min:"0"},null,512),[[c,Ee.value.receivable,void 0,{number:!0}]])]),o("div",se,[a[32]||(a[32]=o("label",null,"最終狀態",-1)),i(o("textarea",{"onUpdate:modelValue":a[13]||(a[13]=e=>Ee.value.final=e),rows:"3",placeholder:"請輸入專案最終狀態或結果..."},null,512),[[c,Ee.value.final]])]),o("div",oe,[o("button",{type:"button",onClick:We,class:"btn btn-outline"}," 取消 "),o("button",{type:"submit",class:"btn btn-primary",disabled:xe.value},b(xe.value?"處理中...":ke.value?"新增":"更新"),9,ne)])],32)])])):n("",!0),He.value&&Je.value?(w(),s("div",{key:4,class:"modal-overlay",onClick:Oe},[o("div",{class:"modal detail-modal",onClick:a[15]||(a[15]=f(()=>{},["stop"]))},[o("div",ie,[o("h2",null,b(Je.value.project_name),1),o("button",{onClick:Oe,class:"close-btn"},"×")]),o("div",ce,[g(A,{project:Je.value,isModal:!0,onClose:Oe,onUpdated:Qe},null,8,["project"])])])])):n("",!0)]))}}),[["__scopeId","data-v-ad75b6b0"]]);export{ve as default};
