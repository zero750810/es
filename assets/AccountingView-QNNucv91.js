import{a as e,v as a,r as t,c as l,B as s,j as n,e as i,f as u,i as o,F as c,g as r,z as d,C as v,G as p,A as m,t as b,n as y,y as g,o as _}from"./vue-DD7UfKtI.js";import{u as k,a as f,b as w,_ as h}from"./index-BH4LE6s5.js";import"./vendor-C7jwa7K6.js";const j={class:"accounting"},C={class:"page-header"},A={class:"header-actions"},S={class:"tabs"},V=["onClick"],P={key:0,class:"payments-section"},U={class:"filters"},q={key:0,class:"loading"},D={key:1,class:"empty-state"},I={key:2,class:"payments-list"},T={class:"payment-header"},L={class:"payment-info"},R={class:"payment-meta"},x={key:0,class:"project-info"},N={class:"project-name"},$={class:"payment-amount"},O={class:"payment-status"},F={key:0,class:"payment-actions"},z=["onClick"],M=["onClick"],Y=["onClick"],B={key:1,class:"receivables-section"},G={class:"filters"},W={key:0,class:"loading"},E={key:1,class:"empty-state"},H={key:2,class:"receivables-list"},J={class:"receivable-header"},K={class:"receivable-info"},Q={class:"receivable-meta"},X={key:0,class:"reviewer-info"},Z={class:"reviewer-name"},ee={class:"receivable-amount"},ae={class:"receivable-status"},te={key:0,class:"receivable-actions"},le=["onClick"],se={key:2,class:"reports-section"},ne={class:"report-filters"},ie={class:"report-cards"},ue={class:"report-card"},oe={class:"amount income"},ce={class:"report-card"},re={class:"amount expense"},de={class:"report-card"},ve={class:"form-group"},pe={class:"form-group"},me=["value"],be={class:"form-group"},ye=["value"],ge={class:"form-group"},_e={class:"form-group"},ke={class:"modal-actions"},fe=["disabled"],we={class:"form-group"},he={class:"form-group"},je=["value"],Ce={class:"form-group"},Ae={class:"modal-actions"},Se=["disabled"],Ve=h(e({__name:"AccountingView",setup(e){const h=k(),Ve=f(),Pe=w(),{user:Ue,userRole:qe}=a(h),{paymentRequests:De,projectList:Ie}=a(Ve),Te=t([]),Le=l(()=>Pe.loading.value),Re=t("payments"),xe=t(""),Ne=t("created_at"),$e=t(""),Oe=t("created_at"),Fe=t((new Date).toISOString().slice(0,7)),ze=t(!1),Me=t(!1),Ye=t(!1),Be=t([]),Ge=t(0),We=t(0),Ee=[{key:"payments",label:"ä»˜æ¬¾ç”³è«‹"},{key:"receivables",label:"æ”¶æ¬¾è©³æƒ…"},{key:"reports",label:"è²¡å‹™å ±è¡¨"}],He=t({amount:0,description:"",project_id:""}),Je=t({amount:0,project_id:"",reviewer_id:"",due_date:"",description:"",status:"pending"}),Ke=l(()=>"manager"===qe.value),Qe=l(()=>"accounting"===qe.value),Xe=l(()=>Ge.value-We.value),Ze=l(()=>(Ie.value||[]).filter(e=>!e.deleted_at&&!e.final)),ea=l(()=>{let e=Te.value||[];return $e.value&&(e=e.filter(e=>"pending"===$e.value?"pending"===e.status||!e.status:"completed"!==$e.value||"completed"===e.status)),e.sort((e,a)=>"amount"===Oe.value?(a.amount||0)-(e.amount||0):new Date(a.created_at).getTime()-new Date(e.created_at).getTime()),e}),aa=l(()=>{let e=(De.value||[]).filter(e=>"paid"!==e.status);return"employee"===qe.value?e=e.filter(e=>{var a;return e.employee_id===(null==(a=Ue.value)?void 0:a.user_id)}):"accounting"===qe.value&&(e=e.filter(e=>"approved"===e.status)),xe.value&&(e=e.filter(e=>e.status===xe.value)),e.sort((e,a)=>"amount"===Ne.value?(a.amount||0)-(e.amount||0):new Date(a.created_at).getTime()-new Date(e.created_at).getTime()),e}),ta=e=>{var a;return e===(null==(a=Ue.value)?void 0:a.user_id)?"æˆ‘":"å“¡å·¥"},la=e=>new Date(e).toLocaleDateString("zh-TW"),sa=e=>({pending:"å¾…å¯©æ ¸",approved:"å·²æ ¸å‡†",paid:"å·²åŒ¯æ¬¾",rejected:"å·²æ‹’çµ•"}[e]||e),na=e=>!("pending"!==e.status||!Ke.value)||!("approved"!==e.status||!Qe.value),ia=async()=>{if(Ue.value){Ye.value=!0;try{await Ve.createPaymentRequest({employee_id:Ue.value.user_id,amount:He.value.amount,description:He.value.description,status:"pending"}),ua()}catch(e){}finally{Ye.value=!1}}},ua=()=>{ze.value=!1,He.value={amount:0,description:"",project_id:""}},oa=()=>{Me.value=!1,Je.value={amount:0,project_id:"",reviewer_id:"",due_date:"",description:"",status:"pending"}},ca=async()=>{Ye.value=!0;try{await Pe.callAPI({table:"account_receivable",action:"create",data:Je.value});const e=await Pe.callAPI({table:"account_receivable",action:"read"});e&&Array.isArray(e)&&(Te.value=e),oa()}catch(e){}finally{Ye.value=!1}},ra=e=>{if(!e)return null;const a=Ze.value.find(a=>a.id===e);return(null==a?void 0:a.project_name)||null},da=e=>{if(!e)return"ç„¡é—œè¯å°ˆæ¡ˆ";const a=Ze.value.find(a=>a.id===e);return(null==a?void 0:a.project_name)||"æœªçŸ¥å°ˆæ¡ˆ"},va=e=>({pending:"å¾…æ”¶æ¬¾",completed:"å·²æ”¶æ¬¾"}[e]||"å¾…æ”¶æ¬¾"),pa=e=>"pending"===e.status&&Qe.value,ma=async()=>{try{const e=new Date(Fe.value),a=e.getMonth(),t=e.getFullYear(),l=De.value.filter(e=>{if(!e.created_at)return!1;const l=new Date(e.created_at);return l.getMonth()===a&&l.getFullYear()===t&&("approved"===e.status||"paid"===e.status)});We.value=l.reduce((e,a)=>e+(a.amount||0),0),Ge.value=0}catch(e){Ge.value=0,We.value=0}};return s(Fe,()=>{ma()}),n(async()=>{await Promise.all([Ve.fetchPaymentRequests(),Ve.fetchProjectList()]);try{const e=await Pe.callAPI({table:"account_receivable",action:"read"});e&&Array.isArray(e)&&(Te.value=e)}catch(e){}try{const e=await Pe.callAPI({table:"staff",action:"read"});e&&Array.isArray(e)&&(Be.value=e.filter(e=>!e.deleted_at))}catch(e){}await ma()}),(e,a)=>(_(),i("div",j,[u("div",C,[a[17]||(a[17]=u("h1",null,"æœƒè¨ˆè²¡å‹™",-1)),u("div",A,[u("button",{onClick:a[0]||(a[0]=e=>ze.value=!0),class:"btn btn-primary"}," ç”³è«‹ä»˜æ¬¾ "),u("button",{onClick:a[1]||(a[1]=e=>Me.value=!0),class:"btn btn-success"}," æ–°å¢æ”¶æ¬¾ ")])]),u("div",S,[(_(),i(c,null,r(Ee,e=>u("button",{key:e.key,onClick:a=>Re.value=e.key,class:y(["tab-btn",{active:Re.value===e.key}])},b(e.label),11,V)),64))]),"payments"===Re.value?(_(),i("div",P,[u("div",U,[d(u("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>xe.value=e),class:"filter-select"},a[18]||(a[18]=[p('<option value="" data-v-9414b130>æ‰€æœ‰ç‹€æ…‹</option><option value="pending" data-v-9414b130>å¾…å¯©æ ¸</option><option value="approved" data-v-9414b130>å·²æ ¸å‡†</option><option value="paid" data-v-9414b130>å·²åŒ¯æ¬¾</option><option value="rejected" data-v-9414b130>å·²æ‹’çµ•</option>',5)]),512),[[v,xe.value]]),d(u("select",{"onUpdate:modelValue":a[3]||(a[3]=e=>Ne.value=e),class:"sort-select"},a[19]||(a[19]=[u("option",{value:"created_at"},"ä¾ç”³è«‹æ™‚é–“æ’åº",-1),u("option",{value:"amount"},"ä¾é‡‘é¡æ’åº",-1)]),512),[[v,Ne.value]])]),Le.value?(_(),i("div",q,"è¼‰å…¥ä¸­...")):0===aa.value.length?(_(),i("div",D,a[20]||(a[20]=[u("div",{class:"empty-icon"},"ğŸ’°",-1),u("p",null,"å°šç„¡ä»˜æ¬¾è¨˜éŒ„",-1)]))):(_(),i("div",I,[(_(!0),i(c,null,r(aa.value,e=>{return _(),i("div",{key:e.id,class:"payment-card"},[u("div",T,[u("div",L,[u("h3",null,b(e.description),1),u("p",R," ç”³è«‹äººï¼š"+b(ta(e.employee_id))+" â€¢ "+b(la(e.created_at)),1),ra(e.project_id)?(_(),i("div",x,[a[21]||(a[21]=u("span",{class:"project-label"},"é—œè¯å°ˆæ¡ˆï¼š",-1)),u("span",N,b(ra(e.project_id)),1)])):o("",!0)]),u("div",$," NT$ "+b((e.amount||0).toLocaleString()),1)]),u("div",O,[u("span",{class:y(["status-badge",(t=e.status,{pending:"status-pending",approved:"status-approved",paid:"status-paid",rejected:"status-rejected"}[t]||"")])},b(sa(e.status)),3),na(e)?(_(),i("div",F,["pending"===e.status&&Ke.value?(_(),i("button",{key:0,onClick:a=>(async e=>{await Ve.approvePaymentRequest(e.id)})(e),class:"btn btn-sm btn-success"}," åŒæ„ç”³è«‹ ",8,z)):o("",!0),"pending"===e.status&&Ke.value?(_(),i("button",{key:1,onClick:a=>(async e=>{await Pe.update("payment_requests",e.id,{status:"rejected",approved_at:(new Date).toISOString()}),await Ve.fetchPaymentRequests()})(e),class:"btn btn-sm btn-danger"}," æ‹’çµ• ",8,M)):o("",!0),"approved"===e.status&&Qe.value?(_(),i("button",{key:2,onClick:a=>(async e=>{await Pe.update("payment_requests",e.id,{status:"paid",paid_at:(new Date).toISOString()}),await Ve.fetchPaymentRequests()})(e),class:"btn btn-sm btn-primary"}," å®Œæˆä»˜æ¬¾ ",8,Y)):o("",!0)])):o("",!0)])]);var t}),128))]))])):"receivables"===Re.value?(_(),i("div",B,[u("div",G,[d(u("select",{"onUpdate:modelValue":a[4]||(a[4]=e=>$e.value=e),class:"filter-select"},a[22]||(a[22]=[u("option",{value:""},"æ‰€æœ‰ç‹€æ…‹",-1),u("option",{value:"pending"},"å¾…æ”¶æ¬¾",-1),u("option",{value:"completed"},"å·²æ”¶æ¬¾",-1)]),512),[[v,$e.value]]),d(u("select",{"onUpdate:modelValue":a[5]||(a[5]=e=>Oe.value=e),class:"sort-select"},a[23]||(a[23]=[u("option",{value:"created_at"},"ä¾å»ºç«‹æ™‚é–“æ’åº",-1),u("option",{value:"amount"},"ä¾é‡‘é¡æ’åº",-1)]),512),[[v,Oe.value]])]),Le.value?(_(),i("div",W,"è¼‰å…¥ä¸­...")):0===ea.value.length?(_(),i("div",E,a[24]||(a[24]=[u("div",{class:"empty-icon"},"ğŸ“ˆ",-1),u("p",null,"å°šç„¡æ”¶æ¬¾è¨˜éŒ„",-1)]))):(_(),i("div",H,[(_(!0),i(c,null,r(ea.value,e=>{return _(),i("div",{key:e.id,class:"receivable-card"},[u("div",J,[u("div",K,[u("h3",null,b(e.description||"æ”¶æ¬¾é …ç›®"),1),u("p",Q," å°ˆæ¡ˆï¼š"+b(da(e.project_id))+" â€¢ "+b(la(e.created_at)),1),e.reviewer_id?(_(),i("div",X,[a[25]||(a[25]=u("span",{class:"reviewer-label"},"å¯©æ ¸äººï¼š",-1)),u("span",Z,b(ta(e.reviewer_id)),1)])):o("",!0)]),u("div",ee," NT$ "+b((e.amount||0).toLocaleString()),1)]),u("div",ae,[u("span",{class:y(["status-badge",(t=e.status,{pending:"status-pending",completed:"status-received"}[t]||"status-pending")])},b(va(e.status)),3),pa(e)?(_(),i("div",te,["pending"===e.status&&Qe.value?(_(),i("button",{key:0,onClick:a=>(async e=>{try{await Pe.callAPI({table:"account_receivable",action:"update",data:{id:e.id,status:"completed",received_at:(new Date).toISOString()}});try{const e=await Pe.callAPI({table:"account_receivable",action:"read"});e&&Array.isArray(e)&&(Te.value=e)}catch(a){}}catch(a){}})(e),class:"btn btn-sm btn-success"}," å®Œæˆæ”¶æ¬¾ ",8,le)):o("",!0)])):o("",!0)])]);var t}),128))]))])):"reports"===Re.value?(_(),i("div",se,[u("div",ne,[d(u("input",{type:"month","onUpdate:modelValue":a[6]||(a[6]=e=>Fe.value=e),class:"month-input"},null,512),[[m,Fe.value]]),u("button",{onClick:ma,class:"btn btn-outline"},"ç”¢ç”Ÿå ±è¡¨")]),u("div",ie,[u("div",ue,[a[26]||(a[26]=u("h3",null,"æœ¬æœˆæ”¶å…¥",-1)),u("div",oe,"NT$ "+b(Ge.value.toLocaleString()),1)]),u("div",ce,[a[27]||(a[27]=u("h3",null,"æœ¬æœˆæ”¯å‡º",-1)),u("div",re,"NT$ "+b(We.value.toLocaleString()),1)]),u("div",de,[a[28]||(a[28]=u("h3",null,"æ·¨åˆ©æ½¤",-1)),u("div",{class:y(["amount",Xe.value>=0?"profit":"loss"])}," NT$ "+b(Xe.value.toLocaleString()),3)])])])):o("",!0),Me.value?(_(),i("div",{key:3,class:"modal-overlay",onClick:oa},[u("div",{class:"modal",onClick:a[12]||(a[12]=g(()=>{},["stop"]))},[u("div",{class:"modal-header"},[a[29]||(a[29]=u("h2",null,"æ–°å¢æ”¶æ¬¾è¨˜éŒ„",-1)),u("button",{onClick:oa,class:"close-btn"},"Ã—")]),u("form",{onSubmit:g(ca,["prevent"]),class:"modal-body"},[u("div",ve,[a[30]||(a[30]=u("label",null,"æ”¶æ¬¾é‡‘é¡ *",-1)),d(u("input",{"onUpdate:modelValue":a[7]||(a[7]=e=>Je.value.amount=e),type:"number",min:"1",required:"",placeholder:"è«‹è¼¸å…¥é‡‘é¡"},null,512),[[m,Je.value.amount,void 0,{number:!0}]])]),u("div",pe,[a[32]||(a[32]=u("label",null,"é—œè¯å°ˆæ¡ˆ *",-1)),d(u("select",{"onUpdate:modelValue":a[8]||(a[8]=e=>Je.value.project_id=e),class:"form-select",required:""},[a[31]||(a[31]=u("option",{value:""},"è«‹é¸æ“‡å°ˆæ¡ˆ",-1)),(_(!0),i(c,null,r(Ze.value,e=>(_(),i("option",{key:e.id,value:e.id},b(e.project_name),9,me))),128))],512),[[v,Je.value.project_id]])]),u("div",be,[a[34]||(a[34]=u("label",null,"å¯©æ ¸äºº",-1)),d(u("select",{"onUpdate:modelValue":a[9]||(a[9]=e=>Je.value.reviewer_id=e),class:"form-select"},[a[33]||(a[33]=u("option",{value:""},"è«‹é¸æ“‡å¯©æ ¸äººï¼ˆå¯é¸ï¼‰",-1)),(_(!0),i(c,null,r(Be.value,e=>(_(),i("option",{key:e.id,value:e.id},b(e.name),9,ye))),128))],512),[[v,Je.value.reviewer_id]])]),u("div",ge,[a[35]||(a[35]=u("label",null,"åˆ°æœŸæ—¥",-1)),d(u("input",{"onUpdate:modelValue":a[10]||(a[10]=e=>Je.value.due_date=e),type:"date"},null,512),[[m,Je.value.due_date]])]),u("div",_e,[a[36]||(a[36]=u("label",null,"æ”¶æ¬¾èªªæ˜",-1)),d(u("textarea",{"onUpdate:modelValue":a[11]||(a[11]=e=>Je.value.description=e),rows:"4",placeholder:"è«‹è©³ç´°èªªæ˜æ”¶æ¬¾é …ç›®..."},null,512),[[m,Je.value.description]])]),u("div",ke,[u("button",{type:"button",onClick:oa,class:"btn btn-outline"}," å–æ¶ˆ "),u("button",{type:"submit",class:"btn btn-success",disabled:Ye.value},b(Ye.value?"æäº¤ä¸­...":"æ–°å¢æ”¶æ¬¾"),9,fe)])],32)])])):o("",!0),ze.value?(_(),i("div",{key:4,class:"modal-overlay",onClick:ua},[u("div",{class:"modal",onClick:a[16]||(a[16]=g(()=>{},["stop"]))},[u("div",{class:"modal-header"},[a[37]||(a[37]=u("h2",null,"ç”³è«‹ä»˜æ¬¾",-1)),u("button",{onClick:ua,class:"close-btn"},"Ã—")]),u("form",{onSubmit:g(ia,["prevent"]),class:"modal-body"},[u("div",we,[a[38]||(a[38]=u("label",null,"ä»˜æ¬¾é‡‘é¡ *",-1)),d(u("input",{"onUpdate:modelValue":a[13]||(a[13]=e=>He.value.amount=e),type:"number",min:"1",required:"",placeholder:"è«‹è¼¸å…¥é‡‘é¡"},null,512),[[m,He.value.amount,void 0,{number:!0}]])]),u("div",he,[a[40]||(a[40]=u("label",null,"é—œè¯å°ˆæ¡ˆ",-1)),d(u("select",{"onUpdate:modelValue":a[14]||(a[14]=e=>He.value.project_id=e),class:"form-select"},[a[39]||(a[39]=u("option",{value:""},"è«‹é¸æ“‡å°ˆæ¡ˆï¼ˆå¯é¸ï¼‰",-1)),(_(!0),i(c,null,r(Ze.value,e=>(_(),i("option",{key:e.id,value:e.id},b(e.project_name),9,je))),128))],512),[[v,He.value.project_id]])]),u("div",Ce,[a[41]||(a[41]=u("label",null,"ä»˜æ¬¾èªªæ˜ *",-1)),d(u("textarea",{"onUpdate:modelValue":a[15]||(a[15]=e=>He.value.description=e),rows:"4",required:"",placeholder:"è«‹è©³ç´°èªªæ˜ä»˜æ¬¾ç”¨é€”..."},null,512),[[m,He.value.description]])]),u("div",Ae,[u("button",{type:"button",onClick:ua,class:"btn btn-outline"}," å–æ¶ˆ "),u("button",{type:"submit",class:"btn btn-primary",disabled:Ye.value},b(Ye.value?"æäº¤ä¸­...":"æäº¤ç”³è«‹"),9,Se)])],32)])])):o("",!0)]))}}),[["__scopeId","data-v-9414b130"]]);export{Ve as default};
