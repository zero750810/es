import{a,r as e,c as l,B as t,j as s,e as n,i,f as c,t as o,n as d,y as u,z as r,A as v,C as m,F as p,g as b,D as y,x as f,o as h,v as k,k as _,l as w,E as C}from"./vue-CVAoqndi.js";import{b as g,a as U,_ as V}from"./index-DxdkvUcA.js";import"./vendor-C7jwa7K6.js";const j={class:"modal-header"},x={class:"header-info"},A={class:"customer-name"},L={class:"modal-content"},I={class:"sidebar"},P={class:"card"},M={class:"card-header"},S={class:"card-content"},D={class:"form-field"},T={class:"form-field"},q={class:"form-field"},R={class:"form-field"},$=["value"],z={class:"form-actions"},B={key:1,class:"info-display-compact"},E={class:"info-grid-pairs"},N={class:"info-pair"},W={class:"info-item-compact"},F={class:"info-item-compact"},G={class:"info-pair"},H={class:"info-item-compact"},J={class:"info-pair"},K={class:"info-item-compact full-width"},O={class:"card"},Q={class:"card-header"},X={class:"card-content"},Y={key:0,class:"empty-state"},Z={key:1,class:"contact-list-compact"},aa={class:"contact-info-compact"},ea={class:"contact-main"},la={class:"contact-name"},ta={class:"contact-position"},sa={class:"contact-details-compact"},na={key:0,class:"contact-phone"},ia={key:1,class:"contact-email"},ca={class:"contact-details-compact"},oa={key:0,class:"contact-phone"},da={class:"contact-actions-compact"},ua=["onClick"],ra=["onClick"],va={class:"main-content"},ma={class:"first-row"},pa={class:"card half-width-card"},ba={class:"card-header"},ya={class:"project-stats"},fa={class:"stat-item"},ha={class:"stat-value"},ka={class:"stat-item"},_a={class:"stat-value"},wa={class:"stat-item"},Ca={class:"stat-value"},ga={class:"card-content compact-content"},Ua={key:0,class:"empty-state-compact"},Va={key:1,class:"project-list-compact"},ja={class:"project-content-compact"},xa={class:"project-name-compact"},Aa={class:"project-meta-compact"},La={class:"project-amount-compact"},Ia={class:"project-date-compact"},Pa=["onClick"],Ma={key:0,class:"show-more-compact"},Sa={class:"card half-width-card"},Da={class:"card-header"},Ta={class:"reminder-actions"},qa={class:"card-content compact-content"},Ra={key:0,class:"empty-state-compact"},$a={key:1,class:"reminder-list-compact"},za={class:"reminder-main-compact"},Ba={class:"reminder-time-compact"},Ea={class:"reminder-text-compact"},Na={class:"reminder-actions-compact"},Wa=["onClick"],Fa=["onClick"],Ga={key:0,class:"show-more-compact"},Ha={class:"second-row"},Ja={class:"card full-width-card"},Ka={class:"card-header"},Oa={class:"contact-record-actions"},Qa={class:"card-content"},Xa={key:0,class:"empty-state"},Ya={key:1,class:"timeline"},Za={class:"timeline-content"},ae={class:"timeline-header"},ee={class:"timeline-date"},le={class:"timeline-user"},te={class:"timeline-text"},se={key:0,class:"sub-modal"},ne={class:"sub-modal-content"},ie={class:"sub-modal-header"},ce={class:"form-row"},oe={class:"form-field"},de={class:"form-field"},ue={class:"form-row"},re={class:"form-field"},ve={class:"form-field"},me={key:1,class:"sub-modal"},pe={class:"sub-modal-content"},be={class:"sub-modal-header"},ye={class:"form-field"},fe=["value"],he={class:"form-field"},ke=["value"],_e={class:"form-field"},we={class:"form-actions"},Ce={key:2,class:"sub-modal"},ge={class:"sub-modal-content"},Ue={class:"sub-modal-header"},Ve={class:"form-field"},je={class:"form-field"},xe={class:"form-field"},Ae={class:"form-actions"},Le={key:3,class:"sub-modal"},Ie={class:"sub-modal-content"},Pe={class:"sub-modal-header"},Me={class:"sub-modal-body"},Se={key:0,class:"empty-state"},De={key:1,class:"completed-reminders-list"},Te={class:"reminder-main"},qe={class:"reminder-time"},Re={class:"reminder-note"},$e={class:"completion-info"},ze={key:0},Be={key:4,class:"sub-modal"},Ee={class:"sub-modal-content large-modal"},Ne={class:"sub-modal-header"},We={class:"sub-modal-body"},Fe={class:"all-records-timeline"},Ge={class:"timeline-content"},He={class:"timeline-header"},Je={class:"timeline-date"},Ke={class:"timeline-user"},Oe={class:"timeline-text"},Qe=V(a({__name:"CRMDetailModal",props:{visible:{type:Boolean},customer:{}},emits:["close","updated"],setup(a,{emit:k}){const _=a,w=k,C=g(),V=f(),Qe=U(),Xe=e(!1),Ye=e(!1),Ze=e(!1),al=e(!1),el=e(null),ll=e(!1),tl=e(!1),sl=e([]),nl=e([]),il=e([]),cl=l(()=>Qe.employee||[]),ol=l(()=>Qe.employee||[]),dl=l(()=>Qe.projectList||[]),ul=l(()=>nl.value.slice(0,3)),rl=l(()=>nl.value.slice(3)),vl=l(()=>il.value.filter(a=>!a.final)),ml=l(()=>il.value.filter(a=>a.final)),pl=l(()=>{var a;return(null==(a=_.customer)?void 0:a.id)?dl.value.filter(a=>a.crm_id===_.customer.id):[]}),bl=l(()=>{const a=pl.value;if(0===a.length)return{count:0,totalAmount:0,averageAmount:0};const e=a.reduce((a,e)=>a+(e.receivable||0),0),l=e/a.length;return{count:a.length,totalAmount:e,averageAmount:Math.round(l)}}),yl=l(()=>(Qe.tags||[]).filter(a=>"project_state"===a.type&&!a.deleted_at)),fl=a=>{if(!a)return"未設定";const e=cl.value.find(e=>e.id===a);return e?e.name:"未設定"},hl=a=>{if(!a)return"未設定";const e=ol.value.find(e=>e.id===a);return e?e.name:"未設定"},kl=e({name:"",company_id:"",address:"",sales_id:null}),_l=e({name:"",position:"",phone:"",mail:""}),wl=e({note:"",project_id:null,state:null}),Cl=e({start_time:"",end_time:"",note:""});t(()=>_.customer,async a=>{a&&(kl.value={name:a.name,company_id:a.company_id||"",address:a.address||"",sales_id:a.sales_id||null},await gl())},{immediate:!0});const gl=async()=>{if(_.customer)try{const a=await C.callAPI({table:"contact_person",action:"read",filters:{crm_id:_.customer.id}});sl.value=a||[];const e=await C.callAPI({table:"contact_record",action:"read",filters:{crm_id:_.customer.id}});e&&(nl.value=e.sort((a,e)=>new Date(e.created_at).getTime()-new Date(a.created_at).getTime()));const l=await C.callAPI({table:"reminder",action:"read",filters:{crm_id:_.customer.id}});il.value=l||[]}catch(a){}},Ul=()=>{w("close")},Vl=async()=>{if(_.customer)try{await C.callAPI({table:"crm",action:"update",data:{id:_.customer.id,...kl.value}}),Xe.value=!1,w("updated")}catch(a){alert("更新失敗，請稍後再試")}},jl=()=>{Ye.value=!1,el.value=null,_l.value={name:"",position:"",phone:"",mail:""}},xl=async()=>{if(_.customer)try{el.value?await C.callAPI({table:"contact_person",action:"update",data:{id:el.value.id,..._l.value}}):await C.callAPI({table:"contact_person",action:"create",data:{crm_id:_.customer.id,..._l.value}}),await gl(),jl()}catch(a){alert("儲存失敗，請稍後再試")}},Al=async()=>{if(_.customer)try{await C.callAPI({table:"contact_record",action:"create",data:{crm_id:_.customer.id,note:wl.value.note,user_id:1}}),wl.value.note="",Ze.value=!1,await gl()}catch(a){alert("儲存失敗，請稍後再試")}},Ll=async()=>{if(_.customer)try{await C.callAPI({table:"reminder",action:"create",data:{crm_id:_.customer.id,start_time:Cl.value.start_time,note:Cl.value.note}}),Cl.value={start_time:"",note:""},al.value=!1,await gl()}catch(a){alert("儲存失敗，請稍後再試")}};s(async()=>{Qe.employee&&0!==Qe.employee.length||await Qe.fetchEmployeeList()});const Il=a=>a?new Date(a).toLocaleString("zh-TW"):"未設定";return(a,e)=>{var l,t,s,f,k;return a.visible?(h(),n("div",{key:0,class:"modal-overlay",onClick:Ul},[c("div",{class:"modal-container",onClick:e[28]||(e[28]=u(()=>{},["stop"]))},[c("div",j,[c("div",x,[c("h2",A,o((null==(l=a.customer)?void 0:l.name)||"客戶詳情"),1)]),c("button",{onClick:e[0]||(e[0]=e=>a.$emit("close")),class:"close-button"},e[29]||(e[29]=[c("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[c("path",{d:"M18 6L6 18M6 6L18 18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1)]))]),c("div",L,[c("div",I,[c("div",P,[c("div",M,[e[30]||(e[30]=c("h3",null,"基本資料",-1)),c("button",{onClick:e[1]||(e[1]=a=>Xe.value=!Xe.value),class:d(["edit-btn",{active:Xe.value}])},o(Xe.value?"取消":"編輯"),3)]),c("div",S,[Xe.value?(h(),n("form",{key:0,onSubmit:u(Vl,["prevent"]),class:"edit-form"},[c("div",D,[e[31]||(e[31]=c("label",null,"客戶名稱 *",-1)),r(c("input",{"onUpdate:modelValue":e[2]||(e[2]=a=>kl.value.name=a),type:"text",required:""},null,512),[[v,kl.value.name]])]),c("div",T,[e[32]||(e[32]=c("label",null,"公司統編",-1)),r(c("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>kl.value.company_id=a),type:"text"},null,512),[[v,kl.value.company_id]])]),c("div",q,[e[33]||(e[33]=c("label",null,"地址",-1)),r(c("textarea",{"onUpdate:modelValue":e[4]||(e[4]=a=>kl.value.address=a),rows:"3"},null,512),[[v,kl.value.address]])]),c("div",R,[e[35]||(e[35]=c("label",null,"負責業務",-1)),r(c("select",{"onUpdate:modelValue":e[5]||(e[5]=a=>kl.value.sales_id=a)},[e[34]||(e[34]=c("option",{value:""},"請選擇負責業務",-1)),(h(!0),n(p,null,b(cl.value,a=>(h(),n("option",{key:a.id,value:a.id},o(a.name),9,$))),128))],512),[[m,kl.value.sales_id]])]),c("div",z,[c("button",{type:"button",onClick:e[6]||(e[6]=a=>Xe.value=!1),class:"btn-secondary"},"取消"),e[36]||(e[36]=c("button",{type:"submit",class:"btn-primary"},"儲存",-1))])],32)):(h(),n("div",B,[c("div",E,[c("div",N,[c("div",W,[e[37]||(e[37]=c("label",null,"客戶名稱",-1)),c("span",null,o(null==(t=a.customer)?void 0:t.name),1)]),c("div",F,[e[38]||(e[38]=c("label",null,"負責業務",-1)),c("span",null,o(fl(null==(s=a.customer)?void 0:s.sales_id)),1)])]),c("div",G,[c("div",H,[e[39]||(e[39]=c("label",null,"公司統編",-1)),c("span",null,o((null==(f=a.customer)?void 0:f.company_id)||"未設定"),1)])]),c("div",J,[c("div",K,[e[40]||(e[40]=c("label",null,"公司地址",-1)),c("span",null,o((null==(k=a.customer)?void 0:k.address)||"未設定"),1)])])])]))])]),c("div",O,[c("div",Q,[e[41]||(e[41]=c("h3",null,"聯絡人",-1)),c("button",{onClick:e[7]||(e[7]=a=>Ye.value=!0),class:"add-btn"},"新增")]),c("div",X,[0===sl.value.length?(h(),n("div",Y,e[42]||(e[42]=[c("div",{class:"empty-icon"},"👥",-1),c("p",null,"尚未新增聯絡人",-1)]))):(h(),n("div",Z,[(h(!0),n(p,null,b(sl.value,a=>(h(),n("div",{key:a.id,class:"contact-item-compact"},[c("div",aa,[c("div",ea,[c("span",la,o(a.name),1),c("span",ta,o(a.position||"職務未設定"),1)]),c("div",sa,[a.phone?(h(),n("span",na,o(a.phone),1)):i("",!0),a.mail?(h(),n("span",ia,o(a.mail),1)):i("",!0)]),c("div",ca,[a.note?(h(),n("span",oa,o(a.note),1)):i("",!0)])]),c("div",da,[c("button",{onClick:e=>(a=>{el.value=a,_l.value={name:a.name,position:a.position||"",phone:a.phone||"",mail:a.mail||""}})(a),class:"btn-icon"},"✏️",8,ua),c("button",{onClick:e=>(async a=>{if(confirm("確定要刪除此聯絡人嗎？"))try{await C.callAPI({table:"contact_person",action:"delete",data:{id:a}}),await gl()}catch(e){alert("刪除失敗，請稍後再試")}})(a.id),class:"btn-icon btn-danger"},"🗑️",8,ra)])]))),128))]))])])]),c("div",va,[c("div",ma,[c("div",pa,[c("div",ba,[e[46]||(e[46]=c("h3",null,"相關專案",-1)),c("div",ya,[c("div",fa,[e[43]||(e[43]=c("span",{class:"stat-label"},"件數",-1)),c("span",ha,o(bl.value.count),1)]),c("div",ka,[e[44]||(e[44]=c("span",{class:"stat-label"},"總金額",-1)),c("span",_a,"NT$ "+o(bl.value.totalAmount.toLocaleString()),1)]),c("div",wa,[e[45]||(e[45]=c("span",{class:"stat-label"},"平均金額",-1)),c("span",Ca,"NT$ "+o(bl.value.averageAmount.toLocaleString()),1)])])]),c("div",ga,[0===pl.value.length?(h(),n("div",Ua,e[47]||(e[47]=[c("div",{class:"empty-icon-small"},"📋",-1),c("p",null,"尚無相關專案",-1)]))):(h(),n("div",Va,[(h(!0),n(p,null,b(pl.value.slice(0,3),a=>(h(),n("div",{key:a.id,class:"project-item-compact"},[c("div",ja,[c("div",xa,o(a.project_name),1),c("div",Aa,[c("span",La,"NT$ "+o((a.receivable||0).toLocaleString()),1),c("span",Ia,o(Il(a.created_at)),1)])]),c("button",{onClick:e=>(a=>{V.push(`/project?id=${a.id}`)})(a),class:"btn-view-compact"},"查看",8,Pa)]))),128)),pl.value.length>3?(h(),n("div",Ma," 還有 "+o(pl.value.length-3)+" 個專案... ",1)):i("",!0)]))])]),c("div",Sa,[c("div",Da,[e[48]||(e[48]=c("h3",null,"提醒設定",-1)),c("div",Ta,[c("button",{onClick:e[8]||(e[8]=a=>al.value=!0),class:"add-btn"},"新增提醒"),ml.value.length>0?(h(),n("button",{key:0,onClick:e[9]||(e[9]=a=>tl.value=!0),class:"btn-completed"}," 已完成("+o(ml.value.length)+") ",1)):i("",!0)])]),c("div",qa,[0===vl.value.length?(h(),n("div",Ra,e[49]||(e[49]=[c("div",{class:"empty-icon-small"},"⏰",-1),c("p",null,"尚無提醒設定",-1)]))):(h(),n("div",$a,[(h(!0),n(p,null,b(vl.value.slice(0,3),a=>(h(),n("div",{key:a.id,class:"reminder-item-compact"},[c("div",za,[c("div",Ba,"⏰ "+o(Il(a.start_time)),1),c("div",Ea,o(a.note),1)]),c("div",Na,[c("button",{onClick:e=>(async a=>{try{const e=1;await C.callAPI({table:"reminder",action:"update",data:{id:a,final:e}}),await gl()}catch(e){alert("完成失敗，請稍後再試")}})(a.id),class:"btn-complete-compact"},"完成",8,Wa),c("button",{onClick:e=>(async a=>{if(confirm("確定要刪除此提醒嗎？"))try{await C.callAPI({table:"reminder",action:"delete",data:{id:a}}),await gl()}catch(e){alert("刪除失敗，請稍後再試")}})(a.id),class:"btn-icon-small btn-danger"},"🗑️",8,Fa)])]))),128)),vl.value.length>3?(h(),n("div",Ga,[c("span",null,"還有 "+o(vl.value.length-3)+" 個待辦",1)])):i("",!0)]))])])]),c("div",Ha,[c("div",Ja,[c("div",Ka,[e[50]||(e[50]=c("h3",null,"聯繫紀錄",-1)),c("div",Oa,[c("button",{onClick:e[10]||(e[10]=a=>Ze.value=!0),class:"add-btn"},"新增紀錄"),rl.value.length>0?(h(),n("button",{key:0,onClick:e[11]||(e[11]=a=>ll.value=!0),class:"btn-view-all"}," 查看全部("+o(nl.value.length)+") ",1)):i("",!0)])]),c("div",Qa,[0===nl.value.length?(h(),n("div",Xa,e[51]||(e[51]=[c("div",{class:"empty-icon"},"📝",-1),c("p",null,"尚無聯繫紀錄",-1)]))):(h(),n("div",Ya,[(h(!0),n(p,null,b(ul.value,a=>(h(),n("div",{key:a.id,class:"timeline-item"},[c("div",Za,[c("div",ae,[c("span",ee,o(Il(a.created_at)),1),c("span",le,o(a.user_name||"系統"),1)]),c("div",te,o(a.note),1)])]))),128))]))])])])])]),Ye.value||el.value?(h(),n("div",se,[c("div",ne,[c("div",ie,[c("h3",null,o(el.value?"編輯聯絡人":"新增聯絡人"),1),c("button",{onClick:jl,class:"close-button"},"×")]),c("form",{onSubmit:u(xl,["prevent"]),class:"sub-modal-body"},[c("div",ce,[c("div",oe,[e[52]||(e[52]=c("label",null,"姓名 *",-1)),r(c("input",{"onUpdate:modelValue":e[12]||(e[12]=a=>_l.value.name=a),type:"text",required:""},null,512),[[v,_l.value.name]])]),c("div",de,[e[53]||(e[53]=c("label",null,"職務",-1)),r(c("input",{"onUpdate:modelValue":e[13]||(e[13]=a=>_l.value.position=a),type:"text"},null,512),[[v,_l.value.position]])])]),c("div",ue,[c("div",re,[e[54]||(e[54]=c("label",null,"電話",-1)),r(c("input",{"onUpdate:modelValue":e[14]||(e[14]=a=>_l.value.phone=a),type:"tel"},null,512),[[v,_l.value.phone]])]),c("div",ve,[e[55]||(e[55]=c("label",null,"信箱",-1)),r(c("input",{"onUpdate:modelValue":e[15]||(e[15]=a=>_l.value.mail=a),type:"email"},null,512),[[v,_l.value.mail]])])]),c("div",{class:"form-actions"},[c("button",{type:"button",onClick:jl,class:"btn-secondary"},"取消"),e[56]||(e[56]=c("button",{type:"submit",class:"btn-primary"},"儲存",-1))])],32)])])):i("",!0),Ze.value?(h(),n("div",me,[c("div",pe,[c("div",be,[e[57]||(e[57]=c("h3",null,"新增聯繫紀錄",-1)),c("button",{onClick:e[16]||(e[16]=a=>Ze.value=!1),class:"close-button"},"×")]),c("form",{onSubmit:u(Al,["prevent"]),class:"sub-modal-body"},[c("div",ye,[e[59]||(e[59]=c("label",null,"關聯專案",-1)),r(c("select",{"onUpdate:modelValue":e[17]||(e[17]=a=>wl.value.project_id=a)},[e[58]||(e[58]=c("option",{value:""},"請選擇專案（可選）",-1)),(h(!0),n(p,null,b(pl.value,a=>(h(),n("option",{key:a.id,value:a.id},o(a.project_name),9,fe))),128))],512),[[m,wl.value.project_id]])]),c("div",he,[e[61]||(e[61]=c("label",null,"專案狀態",-1)),r(c("select",{"onUpdate:modelValue":e[18]||(e[18]=a=>wl.value.state=a)},[e[60]||(e[60]=c("option",{value:""},"請選擇狀態（可選）",-1)),(h(!0),n(p,null,b(yl.value,a=>(h(),n("option",{key:a.id,value:a.id},o(a.name),9,ke))),128))],512),[[m,wl.value.state]])]),c("div",_e,[e[62]||(e[62]=c("label",null,"聯繫內容 *",-1)),r(c("textarea",{"onUpdate:modelValue":e[19]||(e[19]=a=>wl.value.note=a),rows:"4",required:"",placeholder:"請輸入聯繫內容..."},null,512),[[v,wl.value.note]])]),c("div",we,[c("button",{type:"button",onClick:e[20]||(e[20]=a=>Ze.value=!1),class:"btn-secondary"},"取消"),e[63]||(e[63]=c("button",{type:"submit",class:"btn-primary"},"儲存",-1))])],32)])])):i("",!0),al.value?(h(),n("div",Ce,[c("div",ge,[c("div",Ue,[e[64]||(e[64]=c("h3",null,"新增提醒",-1)),c("button",{onClick:e[21]||(e[21]=a=>al.value=!1),class:"close-button"},"×")]),c("form",{onSubmit:u(Ll,["prevent"]),class:"sub-modal-body"},[c("div",Ve,[e[65]||(e[65]=c("label",null,"開始時間 *",-1)),r(c("input",{"onUpdate:modelValue":e[22]||(e[22]=a=>Cl.value.start_time=a),type:"datetime-local",required:""},null,512),[[v,Cl.value.start_time]])]),c("div",je,[e[66]||(e[66]=c("label",null,"結束時間",-1)),r(c("input",{"onUpdate:modelValue":e[23]||(e[23]=a=>Cl.value.end_time=a),type:"datetime-local"},null,512),[[v,Cl.value.end_time]])]),c("div",xe,[e[67]||(e[67]=c("label",null,"提醒內容 *",-1)),r(c("textarea",{"onUpdate:modelValue":e[24]||(e[24]=a=>Cl.value.note=a),rows:"3",required:"",placeholder:"請輸入提醒內容..."},null,512),[[v,Cl.value.note]])]),c("div",Ae,[c("button",{type:"button",onClick:e[25]||(e[25]=a=>al.value=!1),class:"btn-secondary"},"取消"),e[68]||(e[68]=c("button",{type:"submit",class:"btn-primary"},"儲存",-1))])],32)])])):i("",!0),tl.value?(h(),n("div",Le,[c("div",Ie,[c("div",Pe,[e[69]||(e[69]=c("h3",null,"已完成的提醒",-1)),c("button",{onClick:e[26]||(e[26]=a=>tl.value=!1),class:"close-button"},"Ｘ")]),c("div",Me,[0===ml.value.length?(h(),n("div",Se,e[70]||(e[70]=[c("div",{class:"empty-icon"},"✅",-1),c("p",null,"尚無已完成的提醒",-1)]))):(h(),n("div",De,[(h(!0),n(p,null,b(ml.value,a=>(h(),n("div",{key:a.id,class:"completed-reminder-item"},[c("div",Te,[c("div",qe,"⏰ "+o(Il(a.start_time)),1),c("div",Re,o(a.note),1),c("div",$e,[y(" 完成時間: "+o(Il(a.updated_at))+" ",1),a.final?(h(),n("span",ze,"・完成人: "+o(hl(a.final)),1)):i("",!0)])]),e[71]||(e[71]=c("div",{class:"reminder-status"},[c("span",{class:"completed-badge"},"已完成")],-1))]))),128))]))])])])):i("",!0),ll.value?(h(),n("div",Be,[c("div",Ee,[c("div",Ne,[e[72]||(e[72]=c("h3",null,"全部聯繫紀錄",-1)),c("button",{onClick:e[27]||(e[27]=a=>ll.value=!1),class:"close-button"},"×")]),c("div",We,[c("div",Fe,[(h(!0),n(p,null,b(nl.value,a=>(h(),n("div",{key:a.id,class:"timeline-item"},[e[73]||(e[73]=c("div",{class:"timeline-marker"},null,-1)),c("div",Ge,[c("div",He,[c("span",Je,o(Il(a.created_at)),1),c("span",Ke,o(a.user_name||"系統"),1)]),c("div",Oe,o(a.note),1)])]))),128))])])])])):i("",!0)])])):i("",!0)}}}),[["__scopeId","data-v-097b8e31"]]),Xe={class:"crm-list"},Ye={class:"page-header"},Ze={class:"filters"},al={key:0,class:"loading"},el={key:1,class:"empty-state"},ll={key:2,class:"crm-list-container"},tl={class:"crm-list-body"},sl=["onClick"],nl={class:"row-name"},il={class:"row-company"},cl={class:"row-address"},ol={class:"row-sales"},dl={class:"row-date"},ul={class:"modal-header"},rl={class:"form-group"},vl={class:"form-group"},ml={class:"form-group"},pl={class:"form-group"},bl=["value"],yl={class:"modal-actions"},fl=["disabled"],hl=V(a({__name:"CRMListView",setup(a){const t=U(),d=g(),{crmList:y,employee:f}=k(t),{loading:V}=k(d),j=l(()=>f.value||[]),x=e(""),A=e("name"),L=e(!1),I=e(!1),P=e(!1),M=e(!1),S=e(null),D=e(null),T=e({name:"",company_id:"",address:"",sales_id:null}),q=l(()=>{let a=y.value.filter(a=>{var e;return a.name.toLowerCase().includes(x.value.toLowerCase())||(null==(e=a.company_id)?void 0:e.toLowerCase().includes(x.value.toLowerCase()))||""});return a.sort((a,e)=>"name"===A.value?a.name.localeCompare(e.name):"created_at"===A.value?new Date(e.created_at).getTime()-new Date(a.created_at).getTime():"company_id"===A.value?(a.company_id||"").localeCompare(e.company_id||""):0),a}),R=()=>{L.value=!1,I.value=!1,T.value={name:"",company_id:"",address:"",sales_id:null},S.value=null},$=async()=>{M.value=!0;try{L.value?await t.createCRM(T.value):S.value&&await t.updateCRM(S.value.id,T.value),R()}catch(a){}finally{M.value=!1}},z=()=>{P.value=!1,D.value=null},B=a=>{if(!a)return"未設定";const e=j.value.find(e=>e.id===a);return e?e.name:"未設定"},E=async()=>{await t.fetchCRMList()};return s(async()=>{await Promise.all([t.fetchCRMList(),t.fetchEmployeeList()])}),(a,e)=>(h(),n("div",Xe,[c("div",Ye,[e[8]||(e[8]=c("h1",null,"客戶管理",-1)),c("button",{onClick:e[0]||(e[0]=a=>L.value=!0),class:"btn btn-primary"}," 新增客戶 ")]),c("div",Ze,[r(c("input",{"onUpdate:modelValue":e[1]||(e[1]=a=>x.value=a),type:"text",placeholder:"搜尋客戶名稱或公司...",class:"search-input"},null,512),[[v,x.value]]),r(c("select",{"onUpdate:modelValue":e[2]||(e[2]=a=>A.value=a),class:"sort-select"},e[9]||(e[9]=[c("option",{value:"name"},"依名稱排序",-1),c("option",{value:"created_at"},"依建立時間排序",-1),c("option",{value:"company_id"},"依公司排序",-1)]),512),[[m,A.value]])]),w(V)?(h(),n("div",al,"載入中...")):0===q.value.length?(h(),n("div",el,e[10]||(e[10]=[c("div",{class:"empty-icon"},"👥",-1),c("p",null,"尚無客戶資料",-1)]))):(h(),n("div",ll,[e[11]||(e[11]=C('<div class="crm-list-header" data-v-8e1a913f><div class="header-name" data-v-8e1a913f>客戶名稱</div><div class="header-company" data-v-8e1a913f>公司統編</div><div class="header-address" data-v-8e1a913f>地址</div><div class="header-sales" data-v-8e1a913f>負責業務</div><div class="header-date" data-v-8e1a913f>建立時間</div></div>',1)),c("div",tl,[(h(!0),n(p,null,b(q.value,a=>{return h(),n("div",{key:a.id,class:"crm-row",onClick:e=>(a=>{D.value=a,P.value=!0})(a)},[c("div",nl,o(a.name),1),c("div",il,o(a.company_id||"-"),1),c("div",cl,o(a.address||"-"),1),c("div",ol,o(B(a.sales_id)),1),c("div",dl,o((e=a.created_at,new Date(e).toLocaleDateString("zh-TW"))),1)],8,sl);var e}),128))])])),L.value||I.value?(h(),n("div",{key:3,class:"modal-overlay",onClick:R},[c("div",{class:"modal",onClick:e[7]||(e[7]=u(()=>{},["stop"]))},[c("div",ul,[c("h2",null,o(L.value?"新增客戶":"編輯客戶"),1),c("button",{onClick:R,class:"close-btn"},"×")]),c("form",{onSubmit:u($,["prevent"]),class:"modal-body"},[c("div",rl,[e[12]||(e[12]=c("label",null,"客戶名稱 *",-1)),r(c("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>T.value.name=a),type:"text",required:""},null,512),[[v,T.value.name]])]),c("div",vl,[e[13]||(e[13]=c("label",null,"公司名稱",-1)),r(c("input",{"onUpdate:modelValue":e[4]||(e[4]=a=>T.value.company_id=a),type:"text"},null,512),[[v,T.value.company_id]])]),c("div",ml,[e[14]||(e[14]=c("label",null,"地址",-1)),r(c("textarea",{"onUpdate:modelValue":e[5]||(e[5]=a=>T.value.address=a),rows:"3"},null,512),[[v,T.value.address]])]),c("div",pl,[e[16]||(e[16]=c("label",null,"負責業務",-1)),r(c("select",{"onUpdate:modelValue":e[6]||(e[6]=a=>T.value.sales_id=a)},[e[15]||(e[15]=c("option",{value:""},"請選擇負責業務",-1)),(h(!0),n(p,null,b(j.value,a=>(h(),n("option",{key:a.id,value:a.id},o(a.name),9,bl))),128))],512),[[m,T.value.sales_id]])]),c("div",yl,[c("button",{type:"button",onClick:R,class:"btn btn-outline"}," 取消 "),c("button",{type:"submit",class:"btn btn-primary",disabled:M.value},o(M.value?"處理中...":L.value?"新增":"更新"),9,fl)])],32)])])):i("",!0),_(Qe,{visible:P.value,customer:D.value,onClose:z,onUpdated:E},null,8,["visible","customer"])]))}}),[["__scopeId","data-v-8e1a913f"]]);export{hl as default};
