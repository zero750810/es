import{a as e,v as a,r as l,c as t,j as u,e as s,f as o,i as n,z as c,A as r,C as i,F as v,g as d,l as p,t as m,y as _,n as f,x as y,o as b}from"./vue-Cvy1YwU9.js";import{a as g,b as j,_ as w}from"./index-DNTCz2Zq.js";import"./vendor-C7jwa7K6.js";const h={class:"project-list"},k={class:"page-header"},x={class:"filters"},L=["value"],C=["value"],V=["value"],U={key:0,class:"loading"},P={key:1,class:"empty-state"},T={key:2,class:"project-grid"},D=["onClick"],F={class:"project-header"},S={class:"header-badges"},A={key:0,class:"project-tag"},E={class:"project-info"},M={class:"info-row"},q={class:"info-row"},Y={class:"info-row"},$={class:"amount"},z={class:"modal-header"},B={class:"form-group"},I={class:"form-group"},N={class:"searchable-select"},R={key:0,class:"dropdown-list"},G=["onMousedown"],H={key:0,class:"dropdown-empty"},J={class:"form-group"},K=["value"],O={class:"form-group"},Q=["value"],W={class:"form-group"},X=["value"],Z={class:"form-group"},ee={class:"modal-actions"},ae=["disabled"],le=w(e({__name:"ProjectListView",setup(e){const w=y(),le=g(),te=j(),{projectList:ue,crmList:se,tagList:oe}=a(le),{loading:ne}=a(te),ce=l(""),re=l(""),ie=l(""),ve=l(""),de=l(""),pe=l(!1),me=l(!1),_e=l(!1),fe=l(null),ye=t(()=>le.employee||[]),be=t(()=>oe.value.filter(e=>"project"===e.type)||[]),ge=t(()=>oe.value.filter(e=>"project_state"===e.type)||[]),je=l(""),we=l(!1),he=l(null),ke=t(()=>je.value?se.value.filter(e=>e.name.toLowerCase().includes(je.value.toLowerCase())):se.value),xe=t(()=>{const e=new Set;return ue.value.forEach(a=>{a.tag_course&&e.add(a.tag_course)}),Array.from(e).sort()}),Le=t(()=>{const e=new Set;return ue.value.forEach(a=>{if(a.created_at){const l=new Date(a.created_at).getFullYear();e.add(l)}}),Array.from(e).sort((e,a)=>a-e)}),Ce=l({project_name:"",crm_id:"",tag_course:"",project_state:"",executor_id:"",receivable:0}),Ve=t(()=>{let e=ue.value.filter(e=>{const a=e.project_name.toLowerCase().includes(ce.value.toLowerCase()),l=!re.value||e.status===re.value,t=!ie.value||e.executor_id===ie.value,u=!ve.value||e.tag_course===ve.value;let s=!0;if(de.value&&e.created_at){s=new Date(e.created_at).getFullYear()===de.value}return a&&l&&t&&u&&s});return e.sort((e,a)=>new Date(a.created_at).getTime()-new Date(e.created_at).getTime()),e}),Ue=e=>{const a=se.value.find(a=>a.id===e);return(null==a?void 0:a.name)||"未指定"},Pe=e=>{if(!e)return"未指定";const a=ye.value.find(a=>a.id===e);return a?a.name:e},Te=()=>{setTimeout(()=>{we.value=!1,he.value||(je.value="",Ce.value.crm_id="")},200)},De=()=>{pe.value=!1,me.value=!1,Ce.value={project_name:"",crm_id:"",tag_course:"",project_state:"",executor_id:"",receivable:0},je.value="",he.value=null,we.value=!1,fe.value=null},Fe=async()=>{_e.value=!0;try{pe.value?await le.createProject(Ce.value):fe.value&&(await te.update("project",fe.value.id,Ce.value),await le.fetchProjectList()),De()}catch(e){}finally{_e.value=!1}};return u(async()=>{await Promise.all([le.fetchProjectList(),le.fetchCRMList(),le.fetchEmployeeList(),le.fetchTagList()])}),(e,a)=>(b(),s("div",h,[o("div",k,[a[14]||(a[14]=o("h1",null,"專案管理",-1)),o("button",{onClick:a[0]||(a[0]=e=>pe.value=!0),class:"btn btn-primary"}," 新增專案 ")]),o("div",x,[c(o("input",{"onUpdate:modelValue":a[1]||(a[1]=e=>ce.value=e),type:"text",placeholder:"搜尋專案名稱...",class:"search-input"},null,512),[[r,ce.value]]),c(o("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>re.value=e),class:"filter-select"},a[15]||(a[15]=[o("option",{value:""},"所有狀態",-1),o("option",{value:"planning"},"規劃中",-1),o("option",{value:"executing"},"執行中",-1),o("option",{value:"completed"},"已完成",-1)]),512),[[i,re.value]]),c(o("select",{"onUpdate:modelValue":a[3]||(a[3]=e=>ie.value=e),class:"filter-select"},[a[16]||(a[16]=o("option",{value:""},"所有負責人",-1)),(b(!0),s(v,null,d(ye.value,e=>(b(),s("option",{key:e.id,value:e.name},m(e.name),9,L))),128))],512),[[i,ie.value]]),c(o("select",{"onUpdate:modelValue":a[4]||(a[4]=e=>ve.value=e),class:"filter-select"},[a[17]||(a[17]=o("option",{value:""},"所有專案標籤",-1)),(b(!0),s(v,null,d(xe.value,e=>(b(),s("option",{key:e,value:e},m(e),9,C))),128))],512),[[i,ve.value]]),c(o("select",{"onUpdate:modelValue":a[5]||(a[5]=e=>de.value=e),class:"filter-select"},[a[18]||(a[18]=o("option",{value:""},"所有年份",-1)),(b(!0),s(v,null,d(Le.value,e=>(b(),s("option",{key:e,value:e},m(e),9,V))),128))],512),[[i,de.value]])]),p(ne)?(b(),s("div",U,"載入中...")):0===Ve.value.length?(b(),s("div",P,a[19]||(a[19]=[o("div",{class:"empty-icon"},"📂",-1),o("p",null,"尚無專案資料",-1)]))):(b(),s("div",T,[(b(!0),s(v,null,d(Ve.value,e=>(b(),s("div",{key:e.id,class:"project-card",onClick:a=>(e=>{w.push(`/project/${e.id}`)})(e)},[o("div",F,[o("h3",null,m(e.project_name),1),o("div",S,[o("span",{class:f(["project-status","status-executing"])},m("執行中"),3),e.tag_course?(b(),s("span",A,m(e.tag_course),1)):n("",!0)])]),o("div",E,[o("div",M,[a[20]||(a[20]=o("span",{class:"label"},"客戶：",-1)),o("span",null,m(Ue(e.crm_id)),1)]),o("div",q,[a[21]||(a[21]=o("span",{class:"label"},"負責人：",-1)),o("span",null,m(Pe(e.executor_id)),1)]),o("div",Y,[a[22]||(a[22]=o("span",{class:"label"},"應收金額：",-1)),o("span",$,"NT$ "+m(e.receivable.toLocaleString()),1)])])],8,D))),128))])),pe.value||me.value?(b(),s("div",{key:3,class:"modal-overlay",onClick:De},[o("div",{class:"modal",onClick:a[13]||(a[13]=_(()=>{},["stop"]))},[o("div",z,[o("h2",null,m(pe.value?"新增專案":"編輯專案"),1),o("button",{onClick:De,class:"close-btn"},"×")]),o("form",{onSubmit:_(Fe,["prevent"]),class:"modal-body"},[o("div",B,[a[23]||(a[23]=o("label",null,"專案名稱 *",-1)),c(o("input",{"onUpdate:modelValue":a[6]||(a[6]=e=>Ce.value.project_name=e),type:"text",required:""},null,512),[[r,Ce.value.project_name]])]),o("div",I,[a[24]||(a[24]=o("label",null,"客戶 *",-1)),o("div",N,[c(o("input",{"onUpdate:modelValue":a[7]||(a[7]=e=>je.value=e),onFocus:a[8]||(a[8]=e=>we.value=!0),onBlur:Te,type:"text",placeholder:"輸入客戶名稱搜尋...",required:""},null,544),[[r,je.value]]),we.value?(b(),s("div",R,[(b(!0),s(v,null,d(ke.value,e=>(b(),s("div",{key:e.id,onMousedown:a=>(e=>{he.value=e,Ce.value.crm_id=e.id,je.value=e.name,we.value=!1})(e),class:"dropdown-item"},m(e.name),41,G))),128)),0===ke.value.length?(b(),s("div",H," 找不到符合的客戶 ")):n("",!0)])):n("",!0)])]),o("div",J,[a[26]||(a[26]=o("label",null,"活動類型",-1)),c(o("select",{"onUpdate:modelValue":a[9]||(a[9]=e=>Ce.value.tag_course=e)},[a[25]||(a[25]=o("option",{value:""},"請選擇活動類型",-1)),(b(!0),s(v,null,d(be.value,e=>(b(),s("option",{key:e.id,value:e.name},m(e.name),9,K))),128))],512),[[i,Ce.value.tag_course]])]),o("div",O,[a[28]||(a[28]=o("label",null,"專案狀態",-1)),c(o("select",{"onUpdate:modelValue":a[10]||(a[10]=e=>Ce.value.project_state=e)},[a[27]||(a[27]=o("option",{value:""},"請選擇專案狀態",-1)),(b(!0),s(v,null,d(ge.value,e=>(b(),s("option",{key:e.id,value:e.name},m(e.name),9,Q))),128))],512),[[i,Ce.value.project_state]])]),o("div",W,[a[30]||(a[30]=o("label",null,"負責人",-1)),c(o("select",{"onUpdate:modelValue":a[11]||(a[11]=e=>Ce.value.executor_id=e)},[a[29]||(a[29]=o("option",{value:""},"請選擇負責人",-1)),(b(!0),s(v,null,d(ye.value,e=>(b(),s("option",{key:e.id,value:e.name},m(e.name),9,X))),128))],512),[[i,Ce.value.executor_id]])]),o("div",Z,[a[31]||(a[31]=o("label",null,"應收金額",-1)),c(o("input",{"onUpdate:modelValue":a[12]||(a[12]=e=>Ce.value.receivable=e),type:"number",min:"0"},null,512),[[r,Ce.value.receivable,void 0,{number:!0}]])]),o("div",ee,[o("button",{type:"button",onClick:De,class:"btn btn-outline"}," 取消 "),o("button",{type:"submit",class:"btn btn-primary",disabled:_e.value},m(_e.value?"處理中...":pe.value?"新增":"更新"),9,ae)])],32)])])):n("",!0)]))}}),[["__scopeId","data-v-38be9610"]]);export{le as default};
