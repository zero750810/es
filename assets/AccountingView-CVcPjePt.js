import{a as e,v as a,c as l,r as t,B as i,j as n,e as c,f as o,i as s,F as r,g as d,z as u,C as v,A as p,t as y,n as m,y as _,o as b}from"./vue-CVAoqndi.js";import{u as f,a as g,b as k,_ as j}from"./index-__4lFO6p.js";import"./vendor-C7jwa7K6.js";const w={class:"accounting"},h={class:"page-header"},A={class:"header-actions"},S={class:"tabs"},I=["onClick"],C={key:0,class:"payments-section"},D={class:"filters"},P={key:0,class:"loading"},x={key:1,class:"empty-state"},L={key:2,class:"payments-list"},T={class:"payment-header"},V={class:"payment-info"},U={class:"payment-title"},$={class:"status-actions"},F={key:0,class:"payment-actions"},M=["onClick"],N=["onClick"],O=["onClick"],Y={key:0,class:"project-info"},q={class:"project-name"},z={key:0,class:"project-label"},R={key:1,class:"project-name"},B={key:2,class:"project-label"},W={key:3,class:"project-name"},E={key:4,class:"project-label"},G={key:5,class:"project-name"},H={class:"payment-amount"},J={key:1,class:"receivables-section"},K={class:"filters"},Q={key:0,class:"loading"},X={key:1,class:"empty-state"},Z={key:2,class:"receivables-list"},ee={class:"receivable-header"},ae={class:"receivable-info"},le={class:"receivable-title"},te={key:0,class:"receivable-actions"},ie=["onClick"],ne={key:0,class:"project-info"},ce={class:"project-name"},oe={class:"receivable-amount"},se={key:2,class:"reports-section"},re={class:"report-filters"},de={class:"report-cards"},ue={class:"report-card"},ve={class:"amount income"},pe={class:"report-card"},ye={class:"amount expense"},me={class:"report-card"},_e={key:0,class:"monthly-details"},be={class:"detail-section"},fe={key:0,class:"empty-message"},ge={key:1,class:"detail-list"},ke={class:"item-info"},je={class:"item-title"},we={class:"item-meta"},he={key:0,class:"project-tag"},Ae={class:"date-tag"},Se={class:"item-amount expense"},Ie={class:"detail-section"},Ce={key:0,class:"empty-message"},De={key:1,class:"detail-list"},Pe={class:"item-info"},xe={class:"item-title"},Le={class:"item-meta"},Te={key:0,class:"project-tag"},Ve={class:"date-tag"},Ue={class:"item-amount income"},$e={class:"form-group"},Fe={class:"form-group"},Me=["value"],Ne={class:"form-group"},Oe={class:"modal-actions"},Ye=["disabled"],qe={class:"form-group"},ze={class:"form-group"},Re=["value"],Be={class:"form-group"},We={class:"modal-actions"},Ee=["disabled"],Ge=j(e({__name:"AccountingView",setup(e){const j=f(),Ge=g(),He=k(),{user:Je,userRole:Ke}=a(j),{projectList:Qe,crmList:Xe,supplier:Ze}=a(Ge),ea=l(()=>Ze.value||[]),aa=t([]),la=t([]),ta=l(()=>He.loading.value),ia=t("payments"),na=t(""),ca=t("created_at"),oa=t(""),sa=t("created_at"),ra=t((new Date).toISOString().slice(0,7)),da=t(!1),ua=t(!1),va=t(!1),pa=t([]),ya=t(0),ma=t(0),_a=[{key:"payments",label:"付款申請"},{key:"receivables",label:"收款詳情"},{key:"reports",label:"財務報表"}],ba=t({money:0,note:"",project_id:"",executor_id:1}),fa=t({money:0,project_id:"",executor_id:1,note:""}),ga=l(()=>!!Je.value),ka=l(()=>!!Je.value),ja=l(()=>ya.value-ma.value),wa=l(()=>(Qe.value||[]).filter(e=>!e.deleted_at)),ha=l(()=>{let e=(la.value||[]).filter(e=>!e.deleted_at&&!e.final_id);return oa.value&&(e=e.filter(e=>"pending"===oa.value?!e.final_id:"completed"!==oa.value||e.final_id)),e.sort((e,a)=>"amount"===sa.value?(a.money||0)-(e.money||0):new Date(a.created_at).getTime()-new Date(e.created_at).getTime()),e}),Aa=l(()=>{let e=(aa.value||[]).filter(e=>!e.deleted_at&&!e.final_id);return"employee"===Ke.value?e=e.filter(e=>{var a;return e.executor_id===(null==(a=Je.value)?void 0:a.id)}):"accounting"===Ke.value&&(e=e.filter(e=>e.reviewer_id&&!e.final_id)),na.value&&(e=e.filter(e=>"pending"===na.value?!e.reviewer_id&&!e.final_id:"approved"===na.value?e.reviewer_id&&!e.final_id:"rejected"!==na.value||e.rejected_at)),e.sort((e,a)=>"amount"===ca.value?(a.money||0)-(e.money||0):new Date(a.created_at).getTime()-new Date(e.created_at).getTime()),e}),Sa=e=>{var a,l;if(!e)return"未知";if(e.toString()===(null==(l=null==(a=Je.value)?void 0:a.id)?void 0:l.toString()))return"我";const t=pa.value.find(a=>a.id.toString()===e.toString());return(null==t?void 0:t.name)||"員工"},Ia=e=>new Date(e).toLocaleDateString("zh-TW"),Ca=e=>e.reviewer_id||e.final_id?e.reviewer_id&&!e.final_id?"status-approved":e.reviewer_id&&e.final_id?"status-paid":"status-pending":"status-pending",Da=e=>e.reviewer_id||e.final_id?e.reviewer_id&&!e.final_id?"已審核待付款":e.reviewer_id&&e.final_id?"已付款":"待審核":"待審核",Pa=e=>!!e&&(!(e.reviewer_id||e.final_id||!ga.value)||!(!e.reviewer_id||e.final_id||!ka.value)),xa=async()=>{var e;va.value=!0;try{const a={money:ba.value.money,note:ba.value.note||null,executor_id:(null==(e=Je.value)?void 0:e.id)||1};ba.value.project_id&&(a.project_id=ba.value.project_id),await He.callAPI({table:"account_payable",action:"create",data:a});const l=await He.callAPI({table:"account_payable",action:"read"});l&&Array.isArray(l)&&(aa.value=l),La()}catch(a){alert("申請提交失敗，請稍後再試")}finally{va.value=!1}},La=()=>{var e;da.value=!1,ba.value={money:0,note:"",project_id:"",executor_id:(null==(e=Je.value)?void 0:e.id)||1}},Ta=()=>{var e;ua.value=!1,fa.value={money:0,project_id:"",executor_id:(null==(e=Je.value)?void 0:e.id)||1,note:""}},Va=async()=>{var e;va.value=!0;try{const a={money:fa.value.money,note:fa.value.note||null,executor_id:(null==(e=Je.value)?void 0:e.id)||1};fa.value.project_id&&(a.project_id=fa.value.project_id),await He.callAPI({table:"account_receivable",action:"create",data:a});const l=await He.callAPI({table:"account_receivable",action:"read"});l&&Array.isArray(l)&&(la.value=l),Ta()}catch(a){}finally{va.value=!1}},Ua=e=>{if(!e)return null;const a=wa.value.find(a=>a.id===e);return(null==a?void 0:a.project_name)||null},$a=e=>{var a;if(!e)return null;const l=wa.value.find(a=>a.id===e);if(!(null==l?void 0:l.crm_id))return null;const t=null==(a=Xe.value)?void 0:a.find(e=>e.id.toString()===l.crm_id.toString());return(null==t?void 0:t.name)||null},Fa=e=>{var a;if(!e)return null;const l=null==(a=ea.value)?void 0:a.find(a=>a.id.toString()===e.toString());return(null==l?void 0:l.name)||null},Ma=async()=>{try{const e=new Date(ra.value),a=e.getMonth(),l=e.getFullYear(),t=aa.value.filter(e=>{if(!e.created_at||!e.final_id)return!1;const t=new Date(e.created_at);return t.getMonth()===a&&t.getFullYear()===l});ma.value=t.reduce((e,a)=>e+(a.money||0),0);const i=la.value.filter(e=>{if(!e.created_at||!e.final_id)return!1;const t=new Date(e.created_at);return t.getMonth()===a&&t.getFullYear()===l});ya.value=i.reduce((e,a)=>e+(a.money||0),0)}catch(e){ya.value=0,ma.value=0}};i(ra,()=>{Ma()});const Na=l(()=>{if(!ra.value)return[];const e=new Date(ra.value),a=e.getFullYear(),l=e.getMonth();return aa.value.filter(e=>{if(!e.final_id)return!1;const t=new Date(e.updated_at);return t.getFullYear()===a&&t.getMonth()===l})}),Oa=l(()=>{if(!ra.value)return[];const e=new Date(ra.value),a=e.getFullYear(),l=e.getMonth();return la.value.filter(e=>{if(!e.final_id)return!1;const t=new Date(e.updated_at);return t.getFullYear()===a&&t.getMonth()===l})});return n(async()=>{var e;(null==(e=Je.value)?void 0:e.id)&&(ba.value.executor_id=Je.value.id,fa.value.executor_id=Je.value.id),await Promise.all([Ge.fetchProjectList(),Ge.fetchCRMList(),Ge.fetchSupplierList()]);try{const e=await He.callAPI({table:"account_payable",action:"read"});e&&Array.isArray(e)&&(aa.value=e)}catch(a){}try{const e=await He.callAPI({table:"account_receivable",action:"read"});e&&Array.isArray(e)&&(la.value=e)}catch(a){}try{const e=await He.callAPI({table:"staff",action:"read"});e&&Array.isArray(e)&&(pa.value=e.filter(e=>!e.deleted_at))}catch(a){}await Ma()}),(e,a)=>(b(),c("div",w,[o("div",h,[a[15]||(a[15]=o("h1",null,"會計財務",-1)),o("div",A,[o("button",{onClick:a[0]||(a[0]=e=>da.value=!0),class:"btn btn-primary"}," 申請付款 "),o("button",{onClick:a[1]||(a[1]=e=>ua.value=!0),class:"btn btn-success"}," 新增收款 ")])]),o("div",S,[(b(),c(r,null,d(_a,e=>o("button",{key:e.key,onClick:a=>ia.value=e.key,class:m(["tab-btn",{active:ia.value===e.key}])},y(e.label),11,I)),64))]),"payments"===ia.value?(b(),c("div",C,[o("div",D,[u(o("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>na.value=e),class:"filter-select"},a[16]||(a[16]=[o("option",{value:""},"所有狀態",-1),o("option",{value:"pending"},"待審核",-1),o("option",{value:"approved"},"已審核待付款",-1),o("option",{value:"rejected"},"已拒絕",-1)]),512),[[v,na.value]]),u(o("select",{"onUpdate:modelValue":a[3]||(a[3]=e=>ca.value=e),class:"sort-select"},a[17]||(a[17]=[o("option",{value:"created_at"},"依申請時間排序",-1),o("option",{value:"amount"},"依金額排序",-1)]),512),[[v,ca.value]])]),ta.value?(b(),c("div",P,"載入中...")):0===Aa.value.length?(b(),c("div",x,a[18]||(a[18]=[o("div",{class:"empty-icon"},"💰",-1),o("p",null,"尚無付款記錄",-1)]))):(b(),c("div",L,[(b(!0),c(r,null,d(Aa.value,e=>(b(),c("div",{key:e.id,class:"payment-card"},[o("div",T,[o("div",V,[o("div",U,[o("h3",null,y(Ia(e.created_at))+" "+y(e.note||"付款申請")+"　",1),o("div",$,[o("span",{class:m(["status-badge",Ca(e)])},y(Da(e)),3),Pa(e)?(b(),c("div",F,[e.reviewer_id||e.final_id||!ga.value?s("",!0):(b(),c("button",{key:0,onClick:a=>(async e=>{var a;try{await He.callAPI({table:"account_payable",action:"update",data:{id:e.id,reviewer_id:(null==(a=Je.value)?void 0:a.id)||1,updated_at:(new Date).toISOString()}});const l=await He.callAPI({table:"account_payable",action:"read"});l&&Array.isArray(l)&&(aa.value=l)}catch(l){}})(e),class:"btn btn-sm btn-success"}," 同意申請 ",8,M)),e.reviewer_id||e.final_id||!ga.value?s("",!0):(b(),c("button",{key:1,onClick:a=>(async e=>{var a;try{await He.callAPI({table:"account_payable",action:"update",data:{id:e.id,reviewer_id:(null==(a=Je.value)?void 0:a.id)||1,rejected_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}});const l=await He.callAPI({table:"account_payable",action:"read"});l&&Array.isArray(l)&&(aa.value=l)}catch(l){}})(e),class:"btn btn-sm btn-danger"}," 拒絕 ",8,N)),e.reviewer_id&&!e.final_id&&ka.value?(b(),c("button",{key:2,onClick:a=>(async e=>{var a;try{await He.callAPI({table:"account_payable",action:"update",data:{id:e.id,final_id:(null==(a=Je.value)?void 0:a.id)||1,updated_at:(new Date).toISOString()}});const l=await He.callAPI({table:"account_payable",action:"read"});l&&Array.isArray(l)&&(aa.value=l)}catch(l){}})(e),class:"btn btn-sm btn-primary"}," 完成付款 ",8,O)):s("",!0)])):s("",!0)])]),e.project_id||e.executor_id?(b(),c("div",Y,[a[19]||(a[19]=o("span",{class:"project-label"},"申請人：",-1)),o("span",q,y(Sa(e.executor_id)),1),e.project_id?(b(),c("span",z,"　關聯專案：")):s("",!0),e.project_id?(b(),c("span",R,y(Ua(e.project_id)),1)):s("",!0),e.project_id?(b(),c("span",B,"　客戶：")):s("",!0),e.project_id?(b(),c("span",W,y($a(e.project_id)),1)):s("",!0),e.supplier_id?(b(),c("span",E,"　供應商：")):s("",!0),e.supplier_id?(b(),c("span",G,y(Fa(e.supplier_id)),1)):s("",!0)])):s("",!0)]),o("div",H," NT$ "+y((e.money||0).toLocaleString()),1)])]))),128))]))])):"receivables"===ia.value?(b(),c("div",J,[o("div",K,[u(o("select",{"onUpdate:modelValue":a[4]||(a[4]=e=>oa.value=e),class:"filter-select"},a[20]||(a[20]=[o("option",{value:""},"所有狀態",-1),o("option",{value:"pending"},"待收款",-1),o("option",{value:"completed"},"已收款",-1)]),512),[[v,oa.value]]),u(o("select",{"onUpdate:modelValue":a[5]||(a[5]=e=>sa.value=e),class:"sort-select"},a[21]||(a[21]=[o("option",{value:"created_at"},"依建立時間排序",-1),o("option",{value:"amount"},"依金額排序",-1)]),512),[[v,sa.value]])]),ta.value?(b(),c("div",Q,"載入中...")):0===ha.value.length?(b(),c("div",X,a[22]||(a[22]=[o("div",{class:"empty-icon"},"📈",-1),o("p",null,"尚無收款記錄",-1)]))):(b(),c("div",Z,[(b(!0),c(r,null,d(ha.value,e=>(b(),c("div",{key:e.id,class:"receivable-card"},[o("div",ee,[o("div",ae,[o("div",le,[o("h3",null,y(Ia(e.created_at))+" "+y(e.note||"收款項目")+"　",1),e.final_id?s("",!0):(b(),c("div",te,[o("button",{onClick:a=>(async e=>{var a;try{if(await He.callAPI({table:"account_receivable",action:"update",data:{id:e.id,final_id:(null==(a=Je.value)?void 0:a.id)||1,updated_at:(new Date).toISOString()}}),e.project_id)try{await He.callAPI({table:"project",action:"update",data:{id:e.project_id,state:4,updated_at:(new Date).toISOString()}})}catch(l){}try{const e=await He.callAPI({table:"account_receivable",action:"read"});e&&Array.isArray(e)&&(la.value=e)}catch(t){}alert("收款完成！關聯專案狀態已自動更新為結案。")}catch(t){alert("收款處理失敗，請稍後再試")}})(e),class:"btn btn-sm btn-success"}," 完成收款 ",8,ie)]))]),e.project_id?(b(),c("div",ne,[a[23]||(a[23]=o("span",{class:"project-label"},"專案：",-1)),o("span",ce,y(Ua(e.project_id)),1)])):s("",!0)]),o("div",oe," NT$ "+y((e.money||0).toLocaleString()),1)])]))),128))]))])):"reports"===ia.value?(b(),c("div",se,[o("div",re,[u(o("input",{type:"month","onUpdate:modelValue":a[6]||(a[6]=e=>ra.value=e),class:"month-input"},null,512),[[p,ra.value]]),o("button",{onClick:Ma,class:"btn btn-outline"},"產生報表")]),o("div",de,[o("div",ue,[a[24]||(a[24]=o("h3",null,"本月收入",-1)),o("div",ve,"NT$ "+y(ya.value.toLocaleString()),1)]),o("div",pe,[a[25]||(a[25]=o("h3",null,"本月支出",-1)),o("div",ye,"NT$ "+y(ma.value.toLocaleString()),1)]),o("div",me,[a[26]||(a[26]=o("h3",null,"淨利潤",-1)),o("div",{class:m(["amount",ja.value>=0?"profit":"loss"])}," NT$ "+y(ja.value.toLocaleString()),3)])]),ra.value?(b(),c("div",_e,[o("div",be,[o("h4",null,"📤 本月付款明細 ("+y(Na.value.length)+" 筆)",1),0===Na.value.length?(b(),c("div",fe," 本月無付款記錄 ")):(b(),c("div",ge,[(b(!0),c(r,null,d(Na.value,e=>(b(),c("div",{key:`payment-${e.id}`,class:"detail-item"},[o("div",ke,[o("div",je,y(e.note||"付款項目"),1),o("div",we,[Ua(e.project_id)?(b(),c("span",he,y(Ua(e.project_id)),1)):s("",!0),o("span",Ae,y(Ia(e.updated_at)),1)])]),o("div",Se," -NT$ "+y(e.money.toLocaleString()),1)]))),128))]))]),o("div",Ie,[o("h4",null,"📥 本月收款明細 ("+y(Oa.value.length)+" 筆)",1),0===Oa.value.length?(b(),c("div",Ce," 本月無收款記錄 ")):(b(),c("div",De,[(b(!0),c(r,null,d(Oa.value,e=>(b(),c("div",{key:`receivable-${e.id}`,class:"detail-item"},[o("div",Pe,[o("div",xe,y(e.note||"收款項目"),1),o("div",Le,[Ua(e.project_id)?(b(),c("span",Te,y(Ua(e.project_id)),1)):s("",!0),o("span",Ve,y(Ia(e.updated_at)),1)])]),o("div",Ue," +NT$ "+y(e.money.toLocaleString()),1)]))),128))]))])])):s("",!0)])):s("",!0),ua.value?(b(),c("div",{key:3,class:"modal-overlay",onClick:Ta},[o("div",{class:"modal",onClick:a[10]||(a[10]=_(()=>{},["stop"]))},[o("div",{class:"modal-header"},[a[27]||(a[27]=o("h2",null,"新增收款記錄",-1)),o("button",{onClick:Ta,class:"close-btn"},"×")]),o("form",{onSubmit:_(Va,["prevent"]),class:"modal-body"},[o("div",$e,[a[28]||(a[28]=o("label",null,"收款金額 *",-1)),u(o("input",{"onUpdate:modelValue":a[7]||(a[7]=e=>fa.value.money=e),type:"number",min:"1",required:"",placeholder:"請輸入金額"},null,512),[[p,fa.value.money,void 0,{number:!0}]])]),o("div",Fe,[a[30]||(a[30]=o("label",null,"關聯專案 *",-1)),u(o("select",{"onUpdate:modelValue":a[8]||(a[8]=e=>fa.value.project_id=e),class:"form-select",required:""},[a[29]||(a[29]=o("option",{value:""},"請選擇專案",-1)),(b(!0),c(r,null,d(wa.value,e=>(b(),c("option",{key:e.id,value:e.id},y(e.project_name),9,Me))),128))],512),[[v,fa.value.project_id]])]),o("div",Ne,[a[31]||(a[31]=o("label",null,"收款說明",-1)),u(o("textarea",{"onUpdate:modelValue":a[9]||(a[9]=e=>fa.value.note=e),rows:"4",placeholder:"請詳細說明收款項目..."},null,512),[[p,fa.value.note]])]),o("div",Oe,[o("button",{type:"button",onClick:Ta,class:"btn btn-outline"}," 取消 "),o("button",{type:"submit",class:"btn btn-success",disabled:va.value},y(va.value?"提交中...":"新增收款"),9,Ye)])],32)])])):s("",!0),da.value?(b(),c("div",{key:4,class:"modal-overlay",onClick:La},[o("div",{class:"modal",onClick:a[14]||(a[14]=_(()=>{},["stop"]))},[o("div",{class:"modal-header"},[a[32]||(a[32]=o("h2",null,"申請付款",-1)),o("button",{onClick:La,class:"close-btn"},"×")]),o("form",{onSubmit:_(xa,["prevent"]),class:"modal-body"},[o("div",qe,[a[33]||(a[33]=o("label",null,"付款金額 *",-1)),u(o("input",{"onUpdate:modelValue":a[11]||(a[11]=e=>ba.value.money=e),type:"number",min:"1",required:"",placeholder:"請輸入金額"},null,512),[[p,ba.value.money,void 0,{number:!0}]])]),o("div",ze,[a[35]||(a[35]=o("label",null,"關聯專案",-1)),u(o("select",{"onUpdate:modelValue":a[12]||(a[12]=e=>ba.value.project_id=e),class:"form-select"},[a[34]||(a[34]=o("option",{value:""},"請選擇專案（可選）",-1)),(b(!0),c(r,null,d(wa.value,e=>(b(),c("option",{key:e.id,value:e.id},y(e.project_name),9,Re))),128))],512),[[v,ba.value.project_id]])]),o("div",Be,[a[36]||(a[36]=o("label",null,"付款說明 *",-1)),u(o("textarea",{"onUpdate:modelValue":a[13]||(a[13]=e=>ba.value.note=e),rows:"4",required:"",placeholder:"請詳細說明付款用途..."},null,512),[[p,ba.value.note]])]),o("div",We,[o("button",{type:"button",onClick:La,class:"btn btn-outline"}," 取消 "),o("button",{type:"submit",class:"btn btn-primary",disabled:va.value},y(va.value?"提交中...":"提交申請"),9,Ee)])],32)])])):s("",!0)]))}}),[["__scopeId","data-v-20a67015"]]);export{Ge as default};
