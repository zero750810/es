import{a as e,v as a,r as l,c as t,j as u,e as o,f as s,i as n,z as c,A as r,C as i,F as v,g as d,l as p,t as m,y as f,n as _,x as y,o as b}from"./vue-DD7UfKtI.js";import{a as g,b as j,_ as w}from"./index-BH4LE6s5.js";import"./vendor-C7jwa7K6.js";const h={class:"project-list"},k={class:"page-header"},x={class:"filters"},L=["value"],C=["value"],V=["value"],U={key:0,class:"loading"},P={key:1,class:"empty-state"},T={key:2,class:"project-grid"},D=["onClick"],F={class:"project-header"},S={class:"header-badges"},A={key:0,class:"project-tag"},E={class:"project-info"},M={class:"info-row"},q={class:"info-row"},Y={class:"info-row"},$={class:"amount"},z={class:"modal-header"},B={class:"form-group"},I={class:"form-group"},N={class:"searchable-select"},R={key:0,class:"dropdown-list"},G=["onMousedown"],H={key:0,class:"dropdown-empty"},J={class:"form-group"},K=["value"],O={class:"form-group"},Q=["value"],W={class:"form-group"},X=["value"],Z={class:"form-group"},ee={class:"form-group"},ae={class:"modal-actions"},le=["disabled"],te=w(e({__name:"ProjectListView",setup(e){const w=y(),te=g(),ue=j(),{projectList:oe,crmList:se,tagList:ne}=a(te),{loading:ce}=a(ue),re=l(""),ie=l(""),ve=l(""),de=l(""),pe=l(""),me=l(!1),fe=l(!1),_e=l(!1),ye=l(null),be=t(()=>te.employee||[]),ge=t(()=>ne.value.filter(e=>"project"===e.type)||[]),je=t(()=>ne.value.filter(e=>"project_state"===e.type)||[]),we=l(""),he=l(!1),ke=l(null),xe=t(()=>we.value?se.value.filter(e=>e.name.toLowerCase().includes(we.value.toLowerCase())):se.value),Le=t(()=>{const e=new Set;return oe.value.forEach(a=>{a.tag_course&&e.add(a.tag_course)}),Array.from(e).sort()}),Ce=t(()=>{const e=new Set;return oe.value.forEach(a=>{if(a.created_at){const l=new Date(a.created_at).getFullYear();e.add(l)}}),Array.from(e).sort((e,a)=>a-e)}),Ve=l({project_name:"",crm_id:"",tag_course:"",project_state:"",executor_id:"",receivable:0,final:""}),Ue=t(()=>{let e=oe.value.filter(e=>{const a=e.project_name.toLowerCase().includes(re.value.toLowerCase()),l=!ie.value||e.status===ie.value,t=!ve.value||e.executor_id===ve.value,u=!de.value||e.tag_course===de.value;let o=!0;if(pe.value&&e.created_at){o=new Date(e.created_at).getFullYear()===pe.value}return a&&l&&t&&u&&o});return e.sort((e,a)=>new Date(a.created_at).getTime()-new Date(e.created_at).getTime()),e}),Pe=e=>{const a=se.value.find(a=>a.id===e);return(null==a?void 0:a.name)||"未指定"},Te=e=>{if(!e)return"未指定";const a=be.value.find(a=>a.id===e);return a?a.name:e},De=()=>{setTimeout(()=>{he.value=!1,ke.value||(we.value="",Ve.value.crm_id="")},200)},Fe=()=>{me.value=!1,fe.value=!1,Ve.value={project_name:"",crm_id:"",tag_course:"",project_state:"",executor_id:"",receivable:0,final:""},we.value="",ke.value=null,he.value=!1,ye.value=null},Se=async()=>{_e.value=!0;try{me.value?await te.createProject(Ve.value):ye.value&&(await ue.update("project",ye.value.id,Ve.value),await te.fetchProjectList()),Fe()}catch(e){}finally{_e.value=!1}};return u(async()=>{await Promise.all([te.fetchProjectList(),te.fetchCRMList(),te.fetchEmployeeList(),te.fetchTagList()])}),(e,a)=>(b(),o("div",h,[s("div",k,[a[15]||(a[15]=s("h1",null,"專案管理",-1)),s("button",{onClick:a[0]||(a[0]=e=>me.value=!0),class:"btn btn-primary"}," 新增專案 ")]),s("div",x,[c(s("input",{"onUpdate:modelValue":a[1]||(a[1]=e=>re.value=e),type:"text",placeholder:"搜尋專案名稱...",class:"search-input"},null,512),[[r,re.value]]),c(s("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>ie.value=e),class:"filter-select"},a[16]||(a[16]=[s("option",{value:""},"所有狀態",-1),s("option",{value:"planning"},"規劃中",-1),s("option",{value:"executing"},"執行中",-1),s("option",{value:"completed"},"已完成",-1)]),512),[[i,ie.value]]),c(s("select",{"onUpdate:modelValue":a[3]||(a[3]=e=>ve.value=e),class:"filter-select"},[a[17]||(a[17]=s("option",{value:""},"所有負責人",-1)),(b(!0),o(v,null,d(be.value,e=>(b(),o("option",{key:e.id,value:e.name},m(e.name),9,L))),128))],512),[[i,ve.value]]),c(s("select",{"onUpdate:modelValue":a[4]||(a[4]=e=>de.value=e),class:"filter-select"},[a[18]||(a[18]=s("option",{value:""},"所有專案標籤",-1)),(b(!0),o(v,null,d(Le.value,e=>(b(),o("option",{key:e,value:e},m(e),9,C))),128))],512),[[i,de.value]]),c(s("select",{"onUpdate:modelValue":a[5]||(a[5]=e=>pe.value=e),class:"filter-select"},[a[19]||(a[19]=s("option",{value:""},"所有年份",-1)),(b(!0),o(v,null,d(Ce.value,e=>(b(),o("option",{key:e,value:e},m(e),9,V))),128))],512),[[i,pe.value]])]),p(ce)?(b(),o("div",U,"載入中...")):0===Ue.value.length?(b(),o("div",P,a[20]||(a[20]=[s("div",{class:"empty-icon"},"📂",-1),s("p",null,"尚無專案資料",-1)]))):(b(),o("div",T,[(b(!0),o(v,null,d(Ue.value,e=>(b(),o("div",{key:e.id,class:"project-card",onClick:a=>(e=>{w.push(`/project/${e.id}`)})(e)},[s("div",F,[s("h3",null,m(e.project_name),1),s("div",S,[s("span",{class:_(["project-status","status-executing"])},m("執行中"),3),e.tag_course?(b(),o("span",A,m(e.tag_course),1)):n("",!0)])]),s("div",E,[s("div",M,[a[21]||(a[21]=s("span",{class:"label"},"客戶：",-1)),s("span",null,m(Pe(e.crm_id)),1)]),s("div",q,[a[22]||(a[22]=s("span",{class:"label"},"負責人：",-1)),s("span",null,m(Te(e.executor_id)),1)]),s("div",Y,[a[23]||(a[23]=s("span",{class:"label"},"應收金額：",-1)),s("span",$,"NT$ "+m(e.receivable.toLocaleString()),1)])])],8,D))),128))])),me.value||fe.value?(b(),o("div",{key:3,class:"modal-overlay",onClick:Fe},[s("div",{class:"modal",onClick:a[14]||(a[14]=f(()=>{},["stop"]))},[s("div",z,[s("h2",null,m(me.value?"新增專案":"編輯專案"),1),s("button",{onClick:Fe,class:"close-btn"},"×")]),s("form",{onSubmit:f(Se,["prevent"]),class:"modal-body"},[s("div",B,[a[24]||(a[24]=s("label",null,"專案名稱 *",-1)),c(s("input",{"onUpdate:modelValue":a[6]||(a[6]=e=>Ve.value.project_name=e),type:"text",required:""},null,512),[[r,Ve.value.project_name]])]),s("div",I,[a[25]||(a[25]=s("label",null,"客戶 *",-1)),s("div",N,[c(s("input",{"onUpdate:modelValue":a[7]||(a[7]=e=>we.value=e),onFocus:a[8]||(a[8]=e=>he.value=!0),onBlur:De,type:"text",placeholder:"輸入客戶名稱搜尋...",required:""},null,544),[[r,we.value]]),he.value?(b(),o("div",R,[(b(!0),o(v,null,d(xe.value,e=>(b(),o("div",{key:e.id,onMousedown:a=>(e=>{ke.value=e,Ve.value.crm_id=e.id,we.value=e.name,he.value=!1})(e),class:"dropdown-item"},m(e.name),41,G))),128)),0===xe.value.length?(b(),o("div",H," 找不到符合的客戶 ")):n("",!0)])):n("",!0)])]),s("div",J,[a[27]||(a[27]=s("label",null,"活動類型",-1)),c(s("select",{"onUpdate:modelValue":a[9]||(a[9]=e=>Ve.value.tag_course=e)},[a[26]||(a[26]=s("option",{value:""},"請選擇活動類型",-1)),(b(!0),o(v,null,d(ge.value,e=>(b(),o("option",{key:e.id,value:e.name},m(e.name),9,K))),128))],512),[[i,Ve.value.tag_course]])]),s("div",O,[a[29]||(a[29]=s("label",null,"專案狀態",-1)),c(s("select",{"onUpdate:modelValue":a[10]||(a[10]=e=>Ve.value.project_state=e)},[a[28]||(a[28]=s("option",{value:""},"請選擇專案狀態",-1)),(b(!0),o(v,null,d(je.value,e=>(b(),o("option",{key:e.id,value:e.name},m(e.name),9,Q))),128))],512),[[i,Ve.value.project_state]])]),s("div",W,[a[31]||(a[31]=s("label",null,"負責人",-1)),c(s("select",{"onUpdate:modelValue":a[11]||(a[11]=e=>Ve.value.executor_id=e)},[a[30]||(a[30]=s("option",{value:""},"請選擇負責人",-1)),(b(!0),o(v,null,d(be.value,e=>(b(),o("option",{key:e.id,value:e.name},m(e.name),9,X))),128))],512),[[i,Ve.value.executor_id]])]),s("div",Z,[a[32]||(a[32]=s("label",null,"應收金額",-1)),c(s("input",{"onUpdate:modelValue":a[12]||(a[12]=e=>Ve.value.receivable=e),type:"number",min:"0"},null,512),[[r,Ve.value.receivable,void 0,{number:!0}]])]),s("div",ee,[a[33]||(a[33]=s("label",null,"最終狀態",-1)),c(s("textarea",{"onUpdate:modelValue":a[13]||(a[13]=e=>Ve.value.final=e),rows:"3",placeholder:"請輸入專案最終狀態或結果..."},null,512),[[r,Ve.value.final]])]),s("div",ae,[s("button",{type:"button",onClick:Fe,class:"btn btn-outline"}," 取消 "),s("button",{type:"submit",class:"btn btn-primary",disabled:_e.value},m(_e.value?"處理中...":me.value?"新增":"更新"),9,le)])],32)])])):n("",!0)]))}}),[["__scopeId","data-v-bf1aa557"]]);export{te as default};
