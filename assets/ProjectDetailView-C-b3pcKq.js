import{a as e,s as a,c as t,r as l,B as n,l as i,f as u,F as o,j as s,y as r,g as c,n as d,t as v,h as m,z as p,A as b,C as y,E as _,k as f,D as k,G as h,o as g}from"./vue-B-cAkLc6.js";import{a as w,u as C,b as I,_ as j}from"./index-BVk54o67.js";import"./vendor-C7jwa7K6.js";const S={class:"project-content"},A={class:"project-info-card"},P={class:"info-header"},D={class:"state-badge"},L={class:"header-actions"},N={class:"info-grid"},x={class:"info-item"},V={class:"info-item"},U={class:"info-item"},$={class:"info-item"},q={class:"info-item"},O={class:"main-content-grid"},T={class:"left-column"},M={class:"content-card"},Q={class:"card-header"},B={key:0,class:"empty-state"},z={key:1,class:"reminders-compact"},E={class:"reminder-main"},F={class:"reminder-time"},R={class:"reminder-note"},W={class:"reminder-actions"},G=["onClick"],H=["onClick"],J={key:2,class:"reminder-form-compact"},K={class:"form-header"},X={class:"form-row"},Y={class:"form-field"},Z={class:"form-field"},ee={class:"form-field"},ae={class:"form-actions"},te={type:"submit",class:"btn btn-primary"},le={class:"content-card"},ne={class:"card-header"},ie={key:0,class:"empty-state"},ue={key:1,class:"contact-records-compact"},oe={class:"record-main"},se={class:"record-date"},re={class:"record-note"},ce={key:0,class:"record-state"},de={class:"record-actions"},ve=["onClick"],me=["onClick"],pe={key:2,class:"contact-record-form-compact"},be={class:"form-header"},ye={class:"form-field"},_e=["value"],fe={class:"form-field"},ke={class:"form-actions"},he={type:"submit",class:"btn btn-primary"},ge={class:"right-column"},we={class:"content-card"},Ce={class:"card-header"},Ie={class:"header-actions-group"},je={key:0,class:"empty-state"},Se={key:1},Ae={class:"details-table"},Pe={class:"td-item"},De={key:0},Le={class:"td-note"},Ne={key:1},xe={class:"td-amount"},Ve={key:0,class:"amount-negative"},Ue={key:1,class:"amount-na"},$e={class:"td-amount"},qe={key:0,class:"amount-negative"},Oe={key:1,class:"amount-na"},Te={class:"td-amount"},Me={key:0,class:"amount-positive"},Qe={key:1,class:"amount-na"},Be={class:"td-actions"},ze=["onClick"],Ee={class:"cost-summary"},Fe={class:"summary-item"},Re={class:"amount-negative"},We={class:"summary-item"},Ge={class:"amount-positive"},He={class:"summary-item total"},Je={key:1,class:"loading"},Ke={class:"form-group"},Xe={class:"form-group"},Ye={class:"searchable-select"},Ze={key:0,class:"dropdown-list"},ea=["onMousedown"],aa={key:0,class:"dropdown-empty"},ta={class:"form-group"},la=["value"],na={class:"form-group"},ia={class:"form-group"},ua={class:"modal-actions"},oa=["disabled"],sa={class:"modal-header"},ra={class:"form-group"},ca=["value"],da={class:"form-group"},va=["value"],ma={class:"form-group"},pa={key:0,class:"form-group"},ba={key:1,class:"form-group"},ya={class:"form-group"},_a={class:"modal-actions"},fa=["disabled"],ka={class:"modal-body"},ha={class:"equipment-return-section"},ga={key:0,class:"empty-state"},wa={key:1,class:"return-items"},Ca={class:"item-info"},Ia={class:"item-name"},ja={class:"item-type"},Sa={class:"item-outbound"},Aa={class:"item-return"},Pa=["for"],Da=["id","onUpdate:modelValue","max"],La={class:"modal-body"},Na={class:"inventory-check-section"},xa={key:0,class:"empty-state"},Va={key:1,class:"inventory-items"},Ua={class:"item-info"},$a={class:"item-name"},qa={class:"item-note"},Oa={class:"item-info"},Ta={class:"item-name"},Ma={class:"item-status"},Qa=["id","value"],Ba=["for"],za=j(e({__name:"ProjectDetailView",props:{visible:{type:Boolean,default:!0},projectId:{default:null},project:{default:null},isModal:{type:Boolean,default:!1}},emits:["close","updated"],setup(e,{emit:j}){const za=e,Ea=j,Fa=w(),Ra=C(),Wa=I(),{crmList:Ga,inventoryList:Ha,supplier:Ja,employee:Ka,tags:Xa}=a(Fa),Ya=t(()=>Ja.value||[]),Za=t(()=>Ka.value||[]),et=t(()=>(Xa.value||[]).filter(e=>"project"===e.type)),at=t(()=>(Xa.value||[]).filter(e=>"project_state"===e.type)),tt=l([{value:0,name:"接洽中",description:"與客戶進行初步接觸洽談",color:"#6b7280"},{value:1,name:"執行中",description:"專案正在執行進行中",color:"#3b82f6"},{value:2,name:"執行中(出貨)",description:"專案執行中，準備出貨",color:"#f59e0b"},{value:3,name:"待請款",description:"專案完成，等待請款",color:"#10b981"},{value:4,name:"結案",description:"專案已完成並結案",color:"#059669"},{value:5,name:"未接成",description:"專案未能達成協議",color:"#ef4444"}]),lt=l(!1),nt=l({checkedItems:[],notes:""}),it=l(!1),ut=l([]),ot=t(()=>za.project?za.project.id:za.projectId),st=l(null),rt=l([]),ct=l([]),dt=l([]),vt=l(!1),mt=l(!1),pt=l(!1),bt=l(!1),yt=l(!1),_t=l(null),ft=l(null),kt=l(null),ht=l(!1),gt=l({supplier_id:null,inventory_id:null,pay:0,receivable:0,inventory_number:0,note:""}),wt=l({project_name:"",crm_id:"",tag_course:"",d_day:"",receivable:0}),Ct=l({start_time:"",end_time:"",note:""}),It=l({note:"",state:null}),jt=l(""),St=l(!1),At=l(null),Pt=t(()=>{if(!Ga||!Ga.value)return[];const e=Ga.value||[];return jt.value?e.filter(e=>e.name.toLowerCase().includes(jt.value.toLowerCase())):e}),Dt=t(()=>rt.value.reduce((e,a)=>e+a.pay,0)),Lt=t(()=>{var e;return((null==(e=st.value)?void 0:e.receivable)||0)-Dt.value}),Nt=t(()=>rt.value.filter(e=>e.inventory_id)),xt=e=>{const a=Ga.value.find(a=>a.id==Number(e));return(null==a?void 0:a.name)||"未指定"},Vt=e=>{if(!e)return"未指定";const a=Za.value.find(a=>a.id===e);return a?a.name:e},Ut=e=>{if(!e)return"未指定";const a=Ha.value.find(a=>String(a.id)===String(e));return(null==a?void 0:a.name)||`庫存ID: ${e}`},$t=e=>{if(!e)return"未指定";const a=Ya.value.find(a=>a.id===Number(e));return a?a.name:`供應商ID: ${e}`},qt=e=>{if(!e)return"未分類";if("number"==typeof e||/^\d+$/.test(e.toString())){const a=et.value.find(a=>a.id===Number(e));return a?a.name:`標籤ID: ${e}`}const a=et.value.find(a=>a.name===e);return a?a.name:e},Ot=e=>{const a=tt.value.find(a=>a.value===e);return a?a.name:"未設定"},Tt=async e=>{if(!st.value||!(e=>{if(!st.value)return!1;const a=st.value.state||0;if(4===a||5===a)return!1;switch(e){case 0:case 2:return 1===a;case 1:return 0===a;case 3:return 2===a;case 4:return 3===a;case 5:return 0===a||1===a;default:return!1}})(e))return;const a=st.value.state||0,t=Ot(e);if(2!==e){if(confirm(`確定要將專案狀態變更為「${t}」嗎？`))try{await Wa.callAPI({table:"project",action:"update",data:{id:st.value.id,state:e,updated_at:(new Date).toISOString()}}),st.value.state=e,await Mt(a,e)}catch(l){alert("狀態更新失敗，請稍後再試")}}else lt.value=!0},Mt=async(e,a)=>{var t,l;if(st.value&&e!==a)try{if(3===a&&st.value.receivable>0){await Wa.callAPI({table:"account_receivable",action:"create",data:{project_id:st.value.id,executor_id:(null==(t=Ra.user)?void 0:t.id)||1,money:st.value.receivable,note:`專案：${st.value.project_name} 應收款項`}});for(const e of rt.value)if(e.supplier_id&&e.pay>0){const a=Ya.value.find(a=>a.id===e.supplier_id),t=(null==a?void 0:a.name)||`供應商ID:${e.supplier_id}`;await Wa.callAPI({table:"account_payable",action:"create",data:{project_id:st.value.id,supplier_id:e.supplier_id,executor_id:(null==(l=Ra.user)?void 0:l.id)||1,money:e.pay,note:t}})}}if(4===a)try{const e=await Wa.callAPI({table:"reminder",action:"read",filters:{project_id:st.value.id}});if(e&&Array.isArray(e)&&e.length>0)for(const a of e)a.final||await Wa.callAPI({table:"reminder",action:"update",data:{id:a.id,final:1,updated_at:(new Date).toISOString()}})}catch(n){}}catch(i){}},Qt=()=>{lt.value=!1,nt.value={checkedItems:[],notes:""}},Bt=async()=>{var e;if(st.value)if(Nt.value.length>0&&nt.value.checkedItems.length!==Nt.value.length)alert("請確認所有庫存品項後再繼續");else try{for(const a of Nt.value){const t=a.inventory_number||1;await Wa.callAPI({table:"inventory_adjustment",action:"create",data:{inventory_id:a.inventory_id,adjust_quantity:-t,executor_id:(null==(e=Ra.user)?void 0:e.id)||1,type:"out",project_id:st.value.id,created_at:(new Date).toISOString()}}),await Et(a.inventory_id,-t,!0)}await Wa.callAPI({table:"project",action:"update",data:{id:st.value.id,state:2,updated_at:(new Date).toISOString()}}),st.value.state=2,Qt()}catch(a){alert("出貨確認失敗，請稍後再試")}},zt=e=>new Date(e).toLocaleString("zh-TW"),Et=async(e,a,t)=>{try{const l=Ha.value.find(a=>a.id==e);if(!l)return;const n=l.consumables||!1;let i={};i=t?n?{total_stock:Math.max(0,(l.total_stock||0)+a),now_stock:Math.max(0,(l.now_stock||0)+a)}:{now_stock:Math.max(0,(l.now_stock||0)+a)}:n?{total_stock:(l.total_stock||0)+a,now_stock:(l.now_stock||0)+a}:{now_stock:(l.now_stock||0)+a},await Wa.callAPI({table:"inventory",action:"update",data:{id:e,...i,updated_at:(new Date).toISOString()}})}catch(l){}},Ft=()=>{if(!st.value)return;let e=st.value.tag_course||"";if(e&&!/^\d+$/.test(e.toString())){const a=et.value.find(a=>a.name===e);e=a?a.id:""}if(wt.value={project_name:st.value.project_name,crm_id:st.value.crm_id,tag_course:e,d_day:st.value.d_day?new Date(st.value.d_day).toISOString().slice(0,16):"",receivable:st.value.receivable},st.value){const e=Ga.value.find(e=>e.id==Number(st.value.crm_id));e&&(At.value=e,jt.value=e.name)}mt.value=!0},Rt=()=>{vt.value=!0},Wt=()=>{vt.value=!1,pt.value=!1,ft.value=null,gt.value={supplier_id:null,inventory_id:null,pay:0,receivable:0,inventory_number:0,note:""}},Gt=()=>{mt.value=!1,wt.value={project_name:"",crm_id:"",tag_course:"",d_day:"",receivable:0},jt.value="",At.value=null,St.value=!1},Ht=async()=>{if(st.value){ht.value=!0;try{if(ft.value){await Wa.callAPI({table:"project_detail",action:"update",data:{id:ft.value.id,...gt.value}});const e=rt.value.findIndex(e=>e.id===ft.value.id);-1!==e&&(rt.value[e]={...ft.value,...gt.value})}else{const e={supplier_id:gt.value.supplier_id?Number(gt.value.supplier_id):null,inventory_id:gt.value.inventory_id?Number(gt.value.inventory_id):null,pay:Number(gt.value.pay)||0,receivable:Number(gt.value.receivable)||0,inventory_number:Number(gt.value.inventory_number)||0,note:gt.value.note||null,project_id:Number(st.value.id)},a=await Wa.callAPI({table:"project_detail",action:"create",data:e});a&&rt.value.push(a)}Wt()}catch(e){alert("儲存失敗，請稍後再試")}finally{ht.value=!1}}},Jt=async()=>{if(st.value){ht.value=!0;try{const e={id:Number(st.value.id),project_name:wt.value.project_name,crm_id:Number(wt.value.crm_id),tag_course:wt.value.tag_course?Number(wt.value.tag_course):null,d_day:wt.value.d_day?new Date(wt.value.d_day).toISOString():null,receivable:Number(wt.value.receivable)||0,updated_at:(new Date).toISOString()};await Wa.callAPI({table:"project",action:"update",data:e}),st.value={...st.value,...wt.value},Gt(),Ea("updated")}catch(e){alert("更新失敗，請稍後再試")}finally{ht.value=!1}}},Kt=async()=>{if(st.value)try{_t.value?await Wa.callAPI({table:"reminder",action:"update",data:{id:_t.value.id,...Ct.value}}):await Wa.callAPI({table:"reminder",action:"create",data:{project_id:st.value.id,...Ct.value}}),await nl(),Xt()}catch(e){alert("儲存失敗，請稍後再試")}},Xt=()=>{bt.value=!1,_t.value=null,Ct.value={start_time:"",end_time:"",note:""}},Yt=async()=>{if(st.value)try{kt.value?await Wa.callAPI({table:"contact_record",action:"update",data:{id:kt.value.id,...It.value}}):await Wa.callAPI({table:"contact_record",action:"create",data:{project_id:st.value.id,...It.value}}),await il(),Zt()}catch(e){alert("儲存失敗，請稍後再試")}},Zt=()=>{yt.value=!1,kt.value=null,It.value={note:"",state:null}},el=()=>{setTimeout(()=>{St.value=!1,At.value||(jt.value="",wt.value.crm_id="")},200)},al=async()=>{if(st.value){ut.value=[];for(const e of rt.value)if(e.inventory_id){const a=Ha.value.find(a=>a.id==e.inventory_id);a&&ut.value.push({id:e.id,inventoryId:e.inventory_id,inventoryName:a.name,isConsumable:a.consumables||!1,outboundQuantity:e.inventory_number||0,returnQuantity:a.consumables?0:e.inventory_number||0})}it.value=!0}},tl=()=>{it.value=!1,ut.value=[]},ll=async()=>{var e;if(st.value)try{for(const a of ut.value)a.returnQuantity>0&&(await Wa.callAPI({table:"inventory_adjustment",action:"create",data:{inventory_id:a.inventoryId,adjust_quantity:a.returnQuantity,executor_id:(null==(e=Ra.user)?void 0:e.id)||1,type:"in",project_id:st.value.id,created_at:(new Date).toISOString()}}),await Et(a.inventoryId,a.returnQuantity,!1));await Wa.callAPI({table:"project",action:"update",data:{id:st.value.id,state:3,updated_at:(new Date).toISOString()}}),st.value.state=3,await Mt(2,3),tl()}catch(a){alert("設備入庫失敗，請稍後再試")}},nl=async()=>{if(ot.value)try{const e=await Wa.callAPI({table:"reminder",action:"read",filters:{project_id:ot.value}});e&&Array.isArray(e)&&(ct.value=e)}catch(e){}},il=async()=>{if(ot.value)try{const e=await Wa.callAPI({table:"contact_record",action:"read",filters:{project_id:ot.value}});e&&Array.isArray(e)&&(dt.value=e.sort((e,a)=>new Date(a.created_at).getTime()-new Date(e.created_at).getTime()))}catch(e){}},ul=async()=>{if(!ot.value)return;const e=await Wa.query("project","*",{id:ot.value});e&&e.length>0&&(st.value=e[0]);const a=await Wa.query("project_detail","*",{project_id:ot.value});a&&(rt.value=a),await nl(),await il()},ol=()=>{Ea("close")};return n(()=>za.project,e=>{e&&(st.value=e)},{immediate:!0}),n(()=>za.projectId,async()=>{ot.value&&!za.project&&await ul()},{immediate:!0}),n(()=>za.visible,async e=>{e&&ot.value&&await Promise.all([ul(),Fa.fetchCRMList(),Fa.fetchInventoryList(),Fa.fetchSupplierList(),Fa.fetchEmployeeList(),Fa.fetchTagList()])}),i(async()=>{await Promise.all([Fa.fetchCRMList(),Fa.fetchInventoryList(),Fa.fetchSupplierList(),Fa.fetchEmployeeList(),Fa.fetchTagList()]),ot.value&&await ul()}),(e,a)=>{return g(),u(o,null,[e.visible?(g(),u("div",{key:0,class:"modal-overlay",onClick:ol},[st.value?(g(),u("div",{key:0,class:"project-detail-modal",onClick:a[12]||(a[12]=r(()=>{},["stop"]))},[c("div",S,[c("div",A,[c("div",P,[c("div",{class:d(["state-display","state-"+(st.value.state||0)])},[a[30]||(a[30]=c("h3",null,"專案資訊",-1)),c("span",D,v(Ot(st.value.state||0)),1)],2),c("div",L,[0===st.value.state?(g(),u(o,{key:0},[c("button",{onClick:a[0]||(a[0]=e=>Tt(1)),class:"btn btn-sm btn-blue"},"開始執行"),c("button",{onClick:a[1]||(a[1]=e=>Tt(5)),class:"btn btn-sm btn-red"},"未接成")],64)):3===st.value.state?(g(),u("button",{key:1,onClick:a[2]||(a[2]=e=>Tt(4)),class:"btn btn-sm btn-green"},"結案")):s("",!0),c("button",{onClick:Ft,class:"btn btn-primary"},"編輯專案"),c("button",{onClick:a[3]||(a[3]=a=>e.$emit("close")),class:"close-button"},a[31]||(a[31]=[c("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[c("path",{d:"M18 6L6 18M6 6L18 18",stroke:"currentColor","stroke-width":"2","stroke-linecap":"round"})],-1)]))])]),c("div",N,[c("div",x,[a[32]||(a[32]=c("label",null,"專案名稱",-1)),c("span",null,v(st.value.project_name),1)]),c("div",V,[a[33]||(a[33]=c("label",null,"客戶",-1)),c("span",null,v(xt(st.value.crm_id)),1)]),c("div",U,[a[34]||(a[34]=c("label",null,"執行時間",-1)),c("span",null,v((t=st.value.created_at,new Date(t).toLocaleDateString("zh-TW"))),1)]),c("div",$,[a[35]||(a[35]=c("label",null,"負責人",-1)),c("span",null,v(Vt(st.value.executor_id)),1)]),c("div",q,[a[36]||(a[36]=c("label",null,"專案分類",-1)),c("span",null,v(qt(st.value.tag_course)),1)])])]),c("div",O,[c("div",T,[c("div",M,[c("div",Q,[a[37]||(a[37]=c("h3",null,"專案提醒",-1)),c("button",{onClick:a[4]||(a[4]=e=>bt.value=!0),class:"btn btn-sm btn-primary"},"新增提醒")]),0===ct.value.length?(g(),u("div",B,a[38]||(a[38]=[c("p",null,"尚無專案提醒",-1)]))):(g(),u("div",z,[(g(!0),u(o,null,m(ct.value,e=>(g(),u("div",{key:e.id,class:"reminder-compact"},[c("div",E,[c("div",F,v(zt(e.start_time)),1),c("div",R,v(e.note),1)]),c("div",W,[c("button",{onClick:a=>(e=>{_t.value=e,Ct.value={start_time:new Date(e.start_time).toISOString().slice(0,16),end_time:e.end_time?new Date(e.end_time).toISOString().slice(0,16):"",note:e.note}})(e),class:"btn-icon"},"✏️",8,G),c("button",{onClick:a=>(async e=>{if(confirm("確定要刪除此提醒嗎？"))try{await Wa.callAPI({table:"reminder",action:"delete",data:{id:e}}),await nl()}catch(a){alert("刪除失敗，請稍後再試")}})(e.id),class:"btn-icon"},"🗑️",8,H)])]))),128))])),bt.value||_t.value?(g(),u("div",J,[c("div",K,[c("h4",null,v(_t.value?"編輯提醒":"新增提醒"),1),c("button",{onClick:Xt,class:"btn-icon"},"✕")]),c("form",{onSubmit:r(Kt,["prevent"]),class:"form-grid"},[c("div",X,[c("div",Y,[a[39]||(a[39]=c("label",null,"開始時間 *",-1)),p(c("input",{"onUpdate:modelValue":a[5]||(a[5]=e=>Ct.value.start_time=e),type:"datetime-local",required:""},null,512),[[b,Ct.value.start_time]])]),c("div",Z,[a[40]||(a[40]=c("label",null,"結束時間",-1)),p(c("input",{"onUpdate:modelValue":a[6]||(a[6]=e=>Ct.value.end_time=e),type:"datetime-local"},null,512),[[b,Ct.value.end_time]])])]),c("div",ee,[a[41]||(a[41]=c("label",null,"提醒內容 *",-1)),p(c("textarea",{"onUpdate:modelValue":a[7]||(a[7]=e=>Ct.value.note=e),rows:"2",required:"",placeholder:"請輸入提醒內容..."},null,512),[[b,Ct.value.note]])]),c("div",ae,[c("button",{type:"button",onClick:Xt,class:"btn btn-outline"},"取消"),c("button",te,v(_t.value?"更新":"新增"),1)])],32)])):s("",!0)]),c("div",le,[c("div",ne,[a[42]||(a[42]=c("h3",null,"聯繫紀錄",-1)),c("button",{onClick:a[8]||(a[8]=e=>yt.value=!0),class:"btn btn-sm btn-primary"},"新增紀錄")]),0===dt.value.length?(g(),u("div",ie,a[43]||(a[43]=[c("p",null,"尚無聯繫紀錄",-1)]))):(g(),u("div",ue,[(g(!0),u(o,null,m(dt.value,e=>(g(),u("div",{key:e.id,class:"contact-record-compact"},[c("div",oe,[c("div",se,v(zt(e.created_at)),1),c("div",re,v(e.note),1),e.state?(g(),u("div",ce,"狀態："+v(Ot(e.state)),1)):s("",!0)]),c("div",de,[c("button",{onClick:a=>(e=>{kt.value=e,It.value={note:e.note||"",state:e.state||null}})(e),class:"btn-icon"},"✏️",8,ve),c("button",{onClick:a=>(async e=>{if(confirm("確定要刪除此聯繫紀錄嗎？"))try{await Wa.callAPI({table:"contact_record",action:"delete",data:{id:e}}),await il()}catch(a){alert("刪除失敗，請稍後再試")}})(e.id),class:"btn-icon"},"🗑️",8,me)])]))),128))])),yt.value||kt.value?(g(),u("div",pe,[c("div",be,[c("h4",null,v(kt.value?"編輯聯繫紀錄":"新增聯繫紀錄"),1),c("button",{onClick:Zt,class:"btn-icon"},"✕")]),c("form",{onSubmit:r(Yt,["prevent"]),class:"form-grid"},[c("div",ye,[a[45]||(a[45]=c("label",null,"專案狀態",-1)),p(c("select",{"onUpdate:modelValue":a[9]||(a[9]=e=>It.value.state=e)},[a[44]||(a[44]=c("option",{value:""},"請選擇狀態（可選）",-1)),(g(!0),u(o,null,m(at.value,e=>(g(),u("option",{key:e.id,value:e.id},v(e.name),9,_e))),128))],512),[[y,It.value.state]])]),c("div",fe,[a[46]||(a[46]=c("label",null,"聯繫內容 *",-1)),p(c("textarea",{"onUpdate:modelValue":a[10]||(a[10]=e=>It.value.note=e),rows:"3",required:"",placeholder:"請輸入聯繫內容..."},null,512),[[b,It.value.note]])]),c("div",ke,[c("button",{type:"button",onClick:Zt,class:"btn btn-outline"},"取消"),c("button",he,v(kt.value?"更新":"新增"),1)])],32)])):s("",!0)])]),c("div",ge,[c("div",we,[c("div",Ce,[a[47]||(a[47]=c("h3",null,"專案明細",-1)),c("div",Ie,[1===st.value.state?(g(),u("button",{key:0,onClick:a[11]||(a[11]=e=>Tt(2)),class:"btn btn-sm btn-orange"}," 活動出貨 ")):s("",!0),2===st.value.state?(g(),u("button",{key:1,onClick:al,class:"btn btn-sm btn-orange"}," 活動完成,設備入庫 ")):s("",!0),c("button",{onClick:Rt,class:"btn btn-sm btn-primary"},"新增明細")])]),0===rt.value.length?(g(),u("div",je,a[48]||(a[48]=[c("p",null,"尚無專案明細",-1)]))):(g(),u("div",Se,[c("div",Ae,[a[49]||(a[49]=_('<div class="table-header" data-v-49493f00><div class="th-item" data-v-49493f00>項目</div><div class="th-amount" data-v-49493f00>報價金額</div><div class="th-amount" data-v-49493f00>支出金額</div><div class="th-amount" data-v-49493f00>數量</div><div class="th-actions" data-v-49493f00>操作</div></div>',1)),(g(!0),u(o,null,m(rt.value,e=>(g(),u("div",{key:e.id,class:"table-row"},[c("div",Pe,[e.supplier_id?(g(),u("span",De,[k(v($t(e.supplier_id)),1),c("div",Le,v(e.note||"-"),1)])):e.inventory_id?(g(),u("span",Ne,v(Ut(e.inventory_id)),1)):s("",!0)]),c("div",xe,[e.supplier_id&&e.receivable?(g(),u("span",Ve," NT$ "+v(e.receivable.toLocaleString()),1)):(g(),u("span",Ue,"-"))]),c("div",$e,[e.supplier_id&&e.pay?(g(),u("span",qe," NT$ "+v(e.pay.toLocaleString()),1)):(g(),u("span",Oe,"-"))]),c("div",Te,[e.inventory_id&&e.inventory_number?(g(),u("span",Me,v(e.inventory_number),1)):(g(),u("span",Qe,"-"))]),c("div",Be,[c("button",{onClick:a=>(e=>{ft.value=e,gt.value={supplier_id:e.supplier_id?Number(e.supplier_id):null,inventory_id:e.inventory_id?Number(e.inventory_id):null,pay:e.pay||0,receivable:e.receivable||0,inventory_number:e.inventory_number||0,note:e.note||""},pt.value=!0})(e),class:"btn-icon"},"✏️",8,ze)])]))),128))]),c("div",Ee,[c("div",Fe,[a[50]||(a[50]=c("span",null,"總支出：",-1)),c("span",Re,"NT$ "+v(Dt.value.toLocaleString()),1)]),c("div",We,[a[51]||(a[51]=c("span",null,"應收金額：",-1)),c("span",Ge,"NT$ "+v((st.value.receivable||0).toLocaleString()),1)]),c("div",He,[a[52]||(a[52]=c("span",null,"淨利潤：",-1)),c("span",{class:d(Lt.value>=0?"amount-positive":"amount-negative")}," NT$ "+v(Lt.value.toLocaleString()),3)])])]))])])])])])):(g(),u("div",Je," 載入中... "))])):s("",!0),mt.value?(g(),u("div",{key:1,class:"modal-overlay",onClick:Gt},[c("div",{class:"modal",onClick:a[19]||(a[19]=r(()=>{},["stop"]))},[c("div",{class:"modal-header"},[a[53]||(a[53]=c("h2",null,"編輯專案",-1)),c("button",{onClick:Gt,class:"close-btn"},"×")]),c("form",{onSubmit:r(Jt,["prevent"]),class:"modal-body"},[c("div",Ke,[a[54]||(a[54]=c("label",null,"專案名稱 *",-1)),p(c("input",{"onUpdate:modelValue":a[13]||(a[13]=e=>wt.value.project_name=e),type:"text",required:""},null,512),[[b,wt.value.project_name]])]),c("div",Xe,[a[55]||(a[55]=c("label",null,"客戶 *",-1)),c("div",Ye,[p(c("input",{"onUpdate:modelValue":a[14]||(a[14]=e=>jt.value=e),onFocus:a[15]||(a[15]=e=>St.value=!0),onBlur:el,type:"text",placeholder:"輸入客戶名稱搜尋...",required:""},null,544),[[b,jt.value]]),St.value?(g(),u("div",Ze,[(g(!0),u(o,null,m(Pt.value,e=>(g(),u("div",{key:e.id,onMousedown:a=>(e=>{At.value=e,wt.value.crm_id=e.id,jt.value=e.name,St.value=!1})(e),class:"dropdown-item"},v(e.name),41,ea))),128)),0===Pt.value.length?(g(),u("div",aa," 找不到符合的客戶 ")):s("",!0)])):s("",!0)])]),c("div",ta,[a[57]||(a[57]=c("label",null,"活動類型",-1)),p(c("select",{"onUpdate:modelValue":a[16]||(a[16]=e=>wt.value.tag_course=e)},[a[56]||(a[56]=c("option",{value:""},"請選擇活動類型",-1)),(g(!0),u(o,null,m(et.value,e=>(g(),u("option",{key:e.id,value:e.id},v(e.name),9,la))),128))],512),[[y,wt.value.tag_course]])]),c("div",na,[a[58]||(a[58]=c("label",null,"活動時間",-1)),p(c("input",{"onUpdate:modelValue":a[17]||(a[17]=e=>wt.value.d_day=e),type:"datetime-local"},null,512),[[b,wt.value.d_day]])]),c("div",ia,[a[59]||(a[59]=c("label",null,"應收金額",-1)),p(c("input",{"onUpdate:modelValue":a[18]||(a[18]=e=>wt.value.receivable=e),type:"number",min:"0"},null,512),[[b,wt.value.receivable,void 0,{number:!0}]])]),c("div",ua,[c("button",{type:"button",onClick:Gt,class:"btn btn-outline"}," 取消 "),c("button",{type:"submit",class:"btn btn-primary",disabled:ht.value},v(ht.value?"更新中...":"更新"),9,oa)])],32)])])):s("",!0),vt.value||pt.value?(g(),u("div",{key:2,class:"modal-overlay",onClick:Wt},[c("div",{class:"modal",onClick:a[26]||(a[26]=r(()=>{},["stop"]))},[c("div",sa,[c("h2",null,v(ft.value?"編輯專案明細":"新增專案明細"),1),c("button",{onClick:Wt,class:"close-btn"},"×")]),c("form",{onSubmit:r(Ht,["prevent"]),class:"modal-body"},[c("div",ra,[a[61]||(a[61]=c("label",null,"供應商",-1)),p(c("select",{"onUpdate:modelValue":a[20]||(a[20]=e=>gt.value.supplier_id=e)},[a[60]||(a[60]=c("option",{value:""},"請選擇供應商",-1)),(g(!0),u(o,null,m(Ya.value,e=>(g(),u("option",{key:e.id,value:e.id},v(e.name),9,ca))),128))],512),[[y,gt.value.supplier_id]])]),c("div",da,[a[63]||(a[63]=c("label",null,"庫存品項",-1)),p(c("select",{"onUpdate:modelValue":a[21]||(a[21]=e=>gt.value.inventory_id=e)},[a[62]||(a[62]=c("option",{value:""},"請選擇庫存品項",-1)),(g(!0),u(o,null,m(f(Ha),e=>(g(),u("option",{key:e.id,value:e.id},v(e.name),9,va))),128))],512),[[y,gt.value.inventory_id]])]),c("div",ma,[a[64]||(a[64]=c("label",null,"報價金額",-1)),p(c("input",{"onUpdate:modelValue":a[22]||(a[22]=e=>gt.value.receivable=e),type:"number",min:"0",placeholder:"客戶報價金額"},null,512),[[b,gt.value.receivable,void 0,{number:!0}]])]),gt.value.inventory_id?(g(),u("div",pa,[a[65]||(a[65]=c("label",null,"使用數量 *",-1)),p(c("input",{"onUpdate:modelValue":a[23]||(a[23]=e=>gt.value.inventory_number=e),type:"number",min:"1",required:""},null,512),[[b,gt.value.inventory_number,void 0,{number:!0}]])])):s("",!0),gt.value.supplier_id&&!gt.value.inventory_id?(g(),u("div",ba,[a[66]||(a[66]=c("label",null,"支出金額 *",-1)),p(c("input",{"onUpdate:modelValue":a[24]||(a[24]=e=>gt.value.pay=e),type:"number",min:"0",required:""},null,512),[[b,gt.value.pay,void 0,{number:!0}]])])):s("",!0),c("div",ya,[a[67]||(a[67]=c("label",null,"備註",-1)),p(c("textarea",{"onUpdate:modelValue":a[25]||(a[25]=e=>gt.value.note=e),rows:"3"},null,512),[[b,gt.value.note]])]),c("div",_a,[c("button",{type:"button",onClick:Wt,class:"btn btn-outline"}," 取消 "),c("button",{type:"submit",class:"btn btn-primary",disabled:ht.value},v(ht.value?ft.value?"更新中...":"新增中...":ft.value?"更新":"新增"),9,fa)])],32)])])):s("",!0),it.value?(g(),u("div",{key:3,class:"modal-overlay",onClick:tl},[c("div",{class:"modal equipment-return-modal",onClick:a[27]||(a[27]=r(()=>{},["stop"]))},[c("div",{class:"modal-header"},[a[68]||(a[68]=c("h2",null,"設備入庫",-1)),c("button",{onClick:tl,class:"close-btn"},"×")]),c("div",ka,[a[71]||(a[71]=c("div",{class:"return-notice"},[c("h4",null,"📦 設備歸還"),c("p",null,"活動完成，請確認歸還的設備數量：")],-1)),c("div",ha,[a[70]||(a[70]=c("h4",null,"庫存品項歸還",-1)),0===ut.value.length?(g(),u("div",ga,a[69]||(a[69]=[c("p",null,"此專案無庫存品項需要歸還",-1)]))):(g(),u("div",wa,[(g(!0),u(o,null,m(ut.value,e=>(g(),u("div",{key:e.id,class:"return-item"},[c("div",Ca,[c("div",Ia,v(e.inventoryName),1),c("div",ja,[c("span",{class:d(e.isConsumable?"consumable-badge":"equipment-badge")},v(e.isConsumable?"耗材":"設備"),3)]),c("div",Sa,"出庫數量："+v(e.outboundQuantity),1)]),c("div",Aa,[c("label",{for:`return-${e.id}`},"歸還數量：",8,Pa),p(c("input",{id:`return-${e.id}`,"onUpdate:modelValue":a=>e.returnQuantity=a,type:"number",min:0,max:(e.isConsumable,e.outboundQuantity),class:"return-input"},null,8,Da),[[b,e.returnQuantity,void 0,{number:!0}]])])]))),128))]))]),c("div",{class:"modal-actions"},[c("button",{type:"button",onClick:tl,class:"btn btn-outline"}," 取消 "),c("button",{onClick:ll,class:"btn btn-primary"}," 確認入庫 ")])])])])):s("",!0),lt.value?(g(),u("div",{key:4,class:"modal-overlay",onClick:Qt},[c("div",{class:"modal shipping-modal",onClick:a[29]||(a[29]=r(()=>{},["stop"]))},[c("div",{class:"modal-header"},[a[72]||(a[72]=c("h2",null,"出貨檢查",-1)),c("button",{onClick:Qt,class:"close-btn"},"×")]),c("div",La,[c("div",Na,[0===Nt.value.length?(g(),u("div",xa,a[73]||(a[73]=[c("p",null,"此專案尚無關聯的庫存品項",-1)]))):(g(),u("div",Va,[(g(!0),u(o,null,m(Nt.value,e=>(g(),u("div",{key:e.id,class:"inventory-item"},[c("div",Ua,[c("div",$a,v(Ut(e.inventory_id)),1),c("div",qa,v(e.note||"-"),1)]),c("div",Oa,[c("div",Ta,"數量:"+v(e.inventory_number),1)]),c("div",Ma,[p(c("input",{type:"checkbox",id:`check-${e.id}`,"onUpdate:modelValue":a[28]||(a[28]=e=>nt.value.checkedItems=e),value:e.id},null,8,Qa),[[h,nt.value.checkedItems]]),c("label",{for:`check-${e.id}`},"已確認",8,Ba)])]))),128))]))]),c("div",{class:"modal-actions"},[c("button",{type:"button",onClick:Qt,class:"btn btn-outline"}," 取消 "),c("button",{onClick:Bt,class:"btn btn-primary"}," 確認出貨 ")])])])])):s("",!0)],64);var t}}}),[["__scopeId","data-v-49493f00"]]);export{za as default};
