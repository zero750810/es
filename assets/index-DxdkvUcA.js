const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/DashboardView-KUxd3fSA.js","assets/vue-CVAoqndi.js","assets/vendor-C7jwa7K6.js","assets/DashboardView-GZF-2WWU.css","assets/LoginView-riuDJJep.js","assets/LoginView-Cl_EipnB.css","assets/CRMListView-Cl_ePKre.js","assets/CRMListView-BQNjGP9A.css","assets/CRMDetailView-DLGEdc_w.js","assets/CRMDetailView-BG4aKxMd.css","assets/ProjectListView-C8teUH10.js","assets/ProjectDetailView-DBgfvn61.js","assets/ProjectDetailView-CWf49nOI.css","assets/ProjectListView-BFoi-uq7.css","assets/InventoryView-0Tt808fH.js","assets/InventoryView-U51k3zaL.css","assets/AccountingView-CQetyHyO.js","assets/AccountingView-BPzt1JRj.css","assets/EmployeeView-gzlvNaHc.js","assets/EmployeeView-gxxrCCDC.css","assets/SupplierView-rPa9qqaD.js","assets/SupplierView-zPfCcM0x.css","assets/SettingsView-Bauws5nA.js","assets/SettingsView-iQT32yoK.css","assets/NotFoundView-DZ8-RQQN.js","assets/NotFoundView-CHNnA2bW.css"])))=>i.map(i=>d[i]);
import{d as e,r as t,c as a,a as r,u as n,b as s,e as i,o as l,f as o,F as c,g as u,h as d,n as p,w as m,i as h,t as y,j as v,k as f,l as _,R as g,m as w,p as b,q as I,s as A}from"./vue-CVAoqndi.js";import{c as P,_ as R}from"./vendor-C7jwa7K6.js";function E(e,t){var a;return e="object"==typeof(a=e)&&null!==a?e:Object.create(null),new Proxy(e,{get:(e,a,r)=>"key"===a?Reflect.get(e,a,r):Reflect.get(e,a,r)||Reflect.get(t,a,r)})}function j(e,{storage:t,serializer:a,key:r,debug:n}){try{const n=null==t?void 0:t.getItem(r);n&&e.$patch(null==a?void 0:a.deserialize(n))}catch(s){}}function L(e,{storage:t,serializer:a,key:r,paths:n,debug:s}){try{const s=Array.isArray(n)?function(e,t){return t.reduce((t,a)=>{const r=a.split(".");return function(e,t,a){return t.slice(0,-1).reduce((e,t)=>/^(__proto__)$/.test(t)?{}:e[t]=e[t]||{},e)[t[t.length-1]]=a,e}(t,r,function(e,t){return t.reduce((e,t)=>null==e?void 0:e[t],e)}(e,r))},{})}(e,n):e;t.setItem(r,a.serialize(s))}catch(i){}}!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const a of e)if("childList"===a.type)for(const e of a.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var O=function(e={}){return t=>{const{auto:a=!1}=e,{options:{persist:r=a},store:n,pinia:s}=t;if(!r)return;if(!(n.$id in s.state.value)){const e=s._s.get(n.$id.replace("__hot:",""));return void(e&&Promise.resolve().then(()=>e.$persist()))}const i=(Array.isArray(r)?r.map(t=>E(t,e)):[E(r,e)]).map(function(e,t){return a=>{var r;try{const{storage:n=localStorage,beforeRestore:s,afterRestore:i,serializer:l={serialize:JSON.stringify,deserialize:JSON.parse},key:o=t.$id,paths:c=null,debug:u=!1}=a;return{storage:n,beforeRestore:s,afterRestore:i,serializer:l,key:(null!=(r=e.key)?r:e=>e)("string"==typeof o?o:o(t.$id)),paths:c,debug:u}}catch(n){return a.debug,null}}}(e,n)).filter(Boolean);n.$persist=()=>{i.forEach(e=>{L(n.$state,e)})},n.$hydrate=({runHooks:e=!0}={})=>{i.forEach(a=>{const{beforeRestore:r,afterRestore:s}=a;e&&(null==r||r(t)),j(n,a),e&&(null==s||s(t))})},i.forEach(e=>{const{beforeRestore:a,afterRestore:r}=e;null==a||a(t),j(n,e),null==r||r(t),n.$subscribe((t,a)=>{L(a,e)},{detached:!0})})}}();const D=P("https://yuyxhxsrvbpauvadrppc.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl1eXhoeHNydmJwYXV2YWRycHBjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwODQzNTQsImV4cCI6MjA2ODY2MDM1NH0.VLz_X7N2gisz59c2taxxT-WN_TNT2ayfaIYUAj_yS4A",{auth:{autoRefreshToken:!0,persistSession:!1,detectSessionInUrl:!1,flowType:"pkce"},global:{headers:{"X-Client-Info":"supabase-js-web"}},db:{schema:"public"}}),S={1:"employee",2:"manager",3:"accounting",4:"inventory_manager"},q=e("auth",()=>{const e=t(null),r=t(null),n=a(()=>!!r.value),s=a(()=>{var t;return(null==(t=e.value)?void 0:t.role)&&S[e.value.role]||null});let i=!1;return setTimeout(()=>{i||(i=!0,D.auth.onAuthStateChange(async(t,a)=>{if("INITIAL_SESSION"!==t)if("SIGNED_OUT"===t)r.value=null,e.value=null;else if("SIGNED_IN"===t&&a){r.value=a;try{const{data:t}=await D.from("staff").select("*").eq("mail",a.user.email).single();e.value=t}catch(n){}}else"TOKEN_REFRESHED"===t&&a&&(r.value=a)}))},1e3),{user:e,session:r,isAuthenticated:n,userRole:s,login:async(t,a)=>{Date.now();const n=D.auth.signInWithPassword({email:t,password:a}).then(e=>e),s=new Promise((e,t)=>{setTimeout(()=>{t(new Error("Login timeout after 30 seconds"))},3e4)}),{data:i,error:l}=await Promise.race([n,s]);if(l)throw l;if(r.value=i.session,i.user)try{Date.now();const{data:a,error:r}=await D.from("staff").select("*").eq("mail",t).is("deleted_at",null).single();if(r)throw new Error(`找不到員工資料: ${r.message}`);e.value=a}catch(o){throw await D.auth.signOut(),r.value=null,o}return i},logout:async()=>{await D.auth.signOut(),e.value=null,r.value=null},checkAuth:async()=>{if(r.value&&e.value){const e=Date.now()/1e3;if((r.value.expires_at||0)>e)return!0}try{const{data:{session:a},error:n}=await D.auth.getSession();if(n)return!(!r.value&&!e.value||n.message.includes("invalid"))||(r.value=null,e.value=null,!1);if(a){if(r.value=a,!e.value)try{const t=a.user.email,{data:r,error:n}=await D.from("staff").select("*").eq("mail",t).is("deleted_at",null).single();!n&&r&&(e.value=r)}catch(t){}return!0}return r.value=null,e.value=null,!1}catch(a){return a.message&&a.message.includes("invalid")?(r.value=null,e.value=null,!1):!(!r.value&&!e.value)}}}},{persist:{key:"auth-store",storage:localStorage,paths:["user","session"],serializer:{serialize:e=>{var t;const a={...e};if(null==(t=a.session)?void 0:t.expires_at){const e=1e3*a.session.expires_at;Date.now()>e&&(a.session=null,a.user=null)}return JSON.stringify(a)},deserialize:e=>{var t;try{const a=JSON.parse(e);if(null==(t=a.session)?void 0:t.expires_at){const e=1e3*a.session.expires_at;Date.now()>e&&(a.session=null,a.user=null)}return a}catch(a){return{user:null,session:null}}}},beforeRestore:e=>{},afterRestore:e=>{}}});function V(){const e=t(!1),a=t(null),r=async t=>{e.value=!0,a.value=null;try{const{data:e,error:r}=await t();return r?(a.value=r.message||"發生未知錯誤",null):e}catch(r){return a.value=r instanceof Error?r.message:"發生未知錯誤",null}finally{e.value=!1}},n=async(e,t,a)=>r(async()=>{let r=D.from(e).select(t||"*");return a&&Object.entries(a).forEach(([e,t])=>{r=r.eq(e,t)}),r}),s=async(e,t)=>r(()=>D.from(e).insert(t).select().single()),i=async(e,t,a)=>r(()=>D.from(e).update(a).eq("id",t).select().single()),l=async(e,t)=>null!==await r(()=>D.from(e).delete().eq("id",t));return{loading:e,error:a,query:n,insert:s,update:i,remove:l,getReminders:async()=>n("reminders","*",{completed:!1}),markReminderDone:async(e,t)=>i("reminders",t,{completed:!0,completed_at:(new Date).toISOString()}),callAPI:async e=>{const{table:t,action:a,data:r,filters:o,select:c}=e;switch(a){case"create":return s(t,r);case"read":return n(t,c,o);case"update":if(!(null==r?void 0:r.id))throw new Error("Update action requires data.id");const{id:e,...u}=r;return i(t,e,u);case"delete":if(!(null==r?void 0:r.id))throw new Error("Delete action requires data.id");return l(t,r.id);default:throw new Error(`Unsupported action: ${a}`)}}}}const k=e("data",()=>{const e=V(),a=t([]),r=t([]),n=t(null),s=t([]),i=t(null),l=t([]),o=t([]),c=t([]),u=t([]),d=t([]),p=t([]),m=async()=>{try{const t=await e.callAPI({table:"reminder",action:"read"});t&&(a.value=t)}catch(t){}},h=async()=>{try{const t=await e.callAPI({table:"crm",action:"read"});t&&(r.value=t)}catch(t){}},y=async()=>{try{const t=await e.callAPI({table:"project",action:"read"});t&&(s.value=t)}catch(t){}},v=async()=>{try{const t=await e.callAPI({table:"inventory",action:"read"});t&&(l.value=t)}catch(t){}},f=async()=>{try{const t=await e.callAPI({table:"account_receivable",action:"read"});t&&(o.value=t)}catch(t){}},_=async()=>{try{const t=await e.callAPI({table:"account_payable",action:"read"});return t&&(c.value=t),t||[]}catch(t){return[]}},g=f,w=async()=>{try{const t=await e.callAPI({table:"supplier",action:"read"});t&&(u.value=t)}catch(t){}},b=async()=>{var t,a;try{const t=await e.callAPI({table:"staff",action:"read"});t&&(d.value=t)}catch(r){((null==(t=r.message)?void 0:t.includes("401"))||(null==(a=r.message)?void 0:a.includes("Unauthorized")))&&(d.value=[])}},I=async()=>{try{const t=await e.callAPI({table:"tag",action:"read"});t&&(p.value=t)}catch(t){}};return{reminders:a,crmList:r,currentCRM:n,projectList:s,currentProject:i,inventoryList:l,paymentRequests:o,accountPayable:c,supplier:u,employee:d,tags:p,refreshReminders:m,markReminderComplete:async(t,r)=>{await e.markReminderDone(t,r)&&(a.value=a.value.filter(e=>{var a;return!(e.type===t&&(null==(a=e.modal_payload)?void 0:a.id)===r)}))},fetchCRMList:h,createCRM:async t=>{try{const a=await e.callAPI({table:"crm",action:"create",data:t});return a?(r.value.push(a),a):null}catch(a){return null}},updateCRM:async(t,a)=>{try{const n=await e.callAPI({table:"crm",action:"update",data:{id:t,...a}});if(n){const e=r.value.findIndex(e=>e.id===t);return-1!==e&&(r.value[e]=n),n}return null}catch(n){return null}},fetchProjectList:y,createProject:async t=>{try{const a=await e.callAPI({table:"project",action:"create",data:t});return a?(s.value.push(a),a):null}catch(a){return null}},fetchInventoryList:v,updateInventory:async(t,a,r,n)=>{try{const n=l.value.find(e=>e.id===t);if(!n)return!1;const s="out"===r?-a:a,i=(n.total_stock||0)+s,o=await e.callAPI({table:"inventory",action:"update",data:{id:t,total_stock:i,updated_at:(new Date).toISOString()}});return o&&(await e.callAPI({table:"inventory_adjustment",action:"create",data:{inventory_id:t,type:r,adjust_quantity:s,created_at:(new Date).toISOString()}}),await v()),!!o}catch(s){return!1}},fetchAccountReceivable:f,fetchAccountPayable:_,createAccountReceivable:async t=>{try{const a=await e.callAPI({table:"account_receivable",action:"create",data:t});return a?(o.value.push(a),a):null}catch(a){return null}},updateAccountReceivable:async(t,a)=>{try{const r=await e.callAPI({table:"account_receivable",action:"update",data:{id:t,...a}});if(r){const e=o.value.findIndex(e=>e.id===t);-1!==e&&(o.value[e]=r)}return r}catch(r){return null}},fetchPaymentRequests:g,createPaymentRequest:async t=>{try{const a=await e.callAPI({table:"payment_request",action:"create",data:t});return a&&await g(),a}catch(a){throw a}},refreshData:async()=>{try{await Promise.all([h(),y(),v(),f(),_(),w(),b(),I(),m()])}catch(e){}},fetchSupplierList:w,fetchEmployeeList:b,fetchTagList:I}},{persist:{key:"data-store",storage:localStorage,paths:["crmList","projectList","inventoryList","supplier","employee","tags"]}}),T={class:"bottom-navigation"},N={class:"nav-container"},z={class:"nav-icon"},x={class:"nav-label"},C={key:0,class:"nav-badge"},M=(e,t)=>{const a=e.__vccOpts||e;for(const[r,n]of t)a[r]=n;return a},$=M(r({__name:"BottomNavigation",setup(e){const t=n(),r=k(),v=a(()=>{var e,t;return(null==(t=null==(e=r.crmReminder)?void 0:e.filter(e=>!e.completed))?void 0:t.length)||0}),f=a(()=>[{path:"/",label:"工作台",badge:v.value>0?v.value:void 0},{path:"/crm",label:"客戶管理"},{path:"/project",label:"專案管理"},{path:"/inventory",label:"庫存管理"},{path:"/employee",label:"員工資料"},{path:"/supplier",label:"供應商"},{path:"/accounting",label:"會計財務"},{path:"/settings",label:"設定"}]);return(e,a)=>{const r=s("router-link");return l(),i("nav",T,[o("div",N,[(l(!0),i(c,null,u(f.value,e=>{return l(),d(r,{key:e.path,to:e.path,class:p(["nav-item",{"nav-item--active":(a=e.path,"/"===a?"/"===t.path:t.path.startsWith(a))}])},{default:m(()=>[o("div",z,y(e.icon),1),o("span",x,y(e.label),1),e.badge?(l(),i("div",C,y(e.badge),1)):h("",!0)]),_:2},1032,["to","class"]);var a}),128))])])}}}),[["__scopeId","data-v-4247c86f"]]),J={id:"app"},U=r({__name:"App",setup(e){const t=n(),r=q();v(async()=>{await new Promise(e=>setTimeout(e,100));try{await r.checkAuth()}catch(e){}});const s=a(()=>{const e=["/login"].some(e=>t.path.startsWith(e));return(r.isAuthenticated||r.session||r.user)&&!e});return(e,t)=>(l(),i("div",J,[f(_(g)),s.value?(l(),d($,{key:0})):h("",!0)]))}}),X=w({history:b("/es/"),routes:[{path:"/",name:"dashboard",component:()=>R(()=>import("./DashboardView-KUxd3fSA.js"),__vite__mapDeps([0,1,2,3])),meta:{requiresAuth:!0}},{path:"/login",name:"login",component:()=>R(()=>import("./LoginView-riuDJJep.js"),__vite__mapDeps([4,1,2,5])),meta:{requiresAuth:!1}},{path:"/crm",name:"crm-list",component:()=>R(()=>import("./CRMListView-Cl_ePKre.js"),__vite__mapDeps([6,1,2,7])),meta:{requiresAuth:!0}},{path:"/crm/:id",name:"crm-detail",component:()=>R(()=>import("./CRMDetailView-DLGEdc_w.js"),__vite__mapDeps([8,1,2,9])),meta:{requiresAuth:!0}},{path:"/project",name:"project-list",component:()=>R(()=>import("./ProjectListView-C8teUH10.js"),__vite__mapDeps([10,1,11,2,12,13])),meta:{requiresAuth:!0}},{path:"/project/:id",name:"project-detail",component:()=>R(()=>import("./ProjectDetailView-DBgfvn61.js"),__vite__mapDeps([11,1,2,12])),meta:{requiresAuth:!0}},{path:"/inventory",name:"inventory",component:()=>R(()=>import("./InventoryView-0Tt808fH.js"),__vite__mapDeps([14,1,2,15])),meta:{requiresAuth:!0}},{path:"/accounting",name:"accounting",component:()=>R(()=>import("./AccountingView-CQetyHyO.js"),__vite__mapDeps([16,1,2,17])),meta:{requiresAuth:!0}},{path:"/employee",name:"employee",component:()=>R(()=>import("./EmployeeView-gzlvNaHc.js"),__vite__mapDeps([18,1,2,19])),meta:{requiresAuth:!0}},{path:"/supplier",name:"supplier",component:()=>R(()=>import("./SupplierView-rPa9qqaD.js"),__vite__mapDeps([20,1,2,21])),meta:{requiresAuth:!0}},{path:"/settings",name:"settings",component:()=>R(()=>import("./SettingsView-Bauws5nA.js"),__vite__mapDeps([22,1,2,23])),meta:{requiresAuth:!0}},{path:"/:pathMatch(.*)*",name:"not-found",component:()=>R(()=>import("./NotFoundView-DZ8-RQQN.js"),__vite__mapDeps([24,1,2,25]))}]});X.beforeEach(async(e,t,a)=>{try{const t=q();if(e.meta.requiresAuth&&!t.isAuthenticated&&(t.session||t.user||await new Promise(e=>setTimeout(e,50)),await t.checkAuth()),e.meta.requiresAuth&&!t.isAuthenticated)return void a("/login");if("login"===e.name&&t.isAuthenticated)return void a("/");if(e.meta.roles&&t.user){const r=t.user.role;if(!e.meta.roles.includes(r))return void a("/")}a()}catch(r){"login"!==e.name&&"test"!==e.name?a("/login"):a()}});const Y=I(U),F=A();F.use(O),Y.use(F),Y.use(X),Y.mount("#app");export{M as _,k as a,V as b,D as s,q as u};
