import{a as e,v as a,r as t,c as l,B as s,j as n,e as i,f as u,i as c,F as o,g as r,z as d,C as v,G as p,A as m,t as y,n as b,y as g,o as k}from"./vue-Cvy1YwU9.js";import{u as _,a as f,b as h,_ as w}from"./index-m2nXL6kR.js";import"./vendor-BV1FDJi5.js";const j={class:"accounting"},C={class:"page-header"},S={class:"tabs"},D=["onClick"],q={key:0,class:"payments-section"},P={class:"filters"},T={key:0,class:"loading"},A={key:1,class:"empty-state"},V={key:2,class:"payments-list"},I={class:"payment-header"},L={class:"payment-info"},U={class:"payment-meta"},R={key:0,class:"project-info"},N={class:"project-name"},$={class:"payment-amount"},x={class:"payment-status"},O={key:0,class:"payment-actions"},F=["onClick"],z=["onClick"],M=["onClick"],Y={key:1,class:"receivables-section"},B={class:"filters"},G={key:0,class:"loading"},W={key:1,class:"empty-state"},E={key:2,class:"receivables-list"},H={class:"receivable-header"},J={class:"receivable-info"},K={class:"receivable-meta"},Q={key:0,class:"reviewer-info"},X={class:"reviewer-name"},Z={class:"receivable-amount"},ee={class:"receivable-status"},ae={key:0,class:"receivable-actions"},te=["onClick"],le={key:2,class:"reports-section"},se={class:"report-filters"},ne={class:"report-cards"},ie={class:"report-card"},ue={class:"amount income"},ce={class:"report-card"},oe={class:"amount expense"},re={class:"report-card"},de={class:"form-group"},ve={class:"form-group"},pe=["value"],me={class:"form-group"},ye={class:"modal-actions"},be=["disabled"],ge=w(e({__name:"AccountingView",setup(e){const w=_(),ge=f(),ke=h(),{user:_e,userRole:fe}=a(w),{paymentRequests:he,projectList:we}=a(ge),je=t([]),Ce=l(()=>ke.loading.value),Se=t("payments"),De=t(""),qe=t("created_at"),Pe=t(""),Te=t("created_at"),Ae=t((new Date).toISOString().slice(0,7)),Ve=t(!1),Ie=t(!1),Le=t(0),Ue=t(0),Re=[{key:"payments",label:"付款申請"},{key:"receivables",label:"收款詳情"},{key:"reports",label:"財務報表"}],Ne=t({amount:0,description:"",project_id:""}),$e=l(()=>"manager"===fe.value),xe=l(()=>"accounting"===fe.value),Oe=l(()=>Le.value-Ue.value),Fe=l(()=>(we.value||[]).filter(e=>!e.deleted_at&&!e.final)),ze=l(()=>{let e=je.value||[];return Pe.value&&(e=e.filter(e=>"pending"===Pe.value?"pending"===e.status||!e.status:"completed"!==Pe.value||"completed"===e.status)),e.sort((e,a)=>"amount"===Te.value?(a.amount||0)-(e.amount||0):new Date(a.created_at).getTime()-new Date(e.created_at).getTime()),e}),Me=l(()=>{let e=(he.value||[]).filter(e=>"paid"!==e.status);return"employee"===fe.value?e=e.filter(e=>{var a;return e.employee_id===(null==(a=_e.value)?void 0:a.user_id)}):"accounting"===fe.value&&(e=e.filter(e=>"approved"===e.status)),De.value&&(e=e.filter(e=>e.status===De.value)),e.sort((e,a)=>"amount"===qe.value?(a.amount||0)-(e.amount||0):new Date(a.created_at).getTime()-new Date(e.created_at).getTime()),e}),Ye=e=>{var a;return e===(null==(a=_e.value)?void 0:a.user_id)?"我":"員工"},Be=e=>new Date(e).toLocaleDateString("zh-TW"),Ge=e=>({pending:"待審核",approved:"已核准",paid:"已匯款",rejected:"已拒絕"}[e]||e),We=e=>!("pending"!==e.status||!$e.value)||!("approved"!==e.status||!xe.value),Ee=async()=>{if(_e.value){Ie.value=!0;try{await ge.createPaymentRequest({employee_id:_e.value.user_id,amount:Ne.value.amount,description:Ne.value.description,status:"pending"}),He()}catch(e){}finally{Ie.value=!1}}},He=()=>{Ve.value=!1,Ne.value={amount:0,description:"",project_id:""}},Je=e=>{if(!e)return null;const a=Fe.value.find(a=>a.id===e);return(null==a?void 0:a.project_name)||null},Ke=e=>{if(!e)return"無關聯專案";const a=Fe.value.find(a=>a.id===e);return(null==a?void 0:a.project_name)||"未知專案"},Qe=e=>({pending:"待收款",completed:"已收款"}[e]||"待收款"),Xe=e=>"pending"===e.status&&xe.value,Ze=async()=>{try{const e=new Date(Ae.value),a=e.getMonth(),t=e.getFullYear(),l=he.value.filter(e=>{if(!e.created_at)return!1;const l=new Date(e.created_at);return l.getMonth()===a&&l.getFullYear()===t&&("approved"===e.status||"paid"===e.status)});Ue.value=l.reduce((e,a)=>e+(a.amount||0),0),Le.value=0}catch(e){Le.value=0,Ue.value=0}};return s(Ae,()=>{Ze()}),n(async()=>{await Promise.all([ge.fetchPaymentRequests(),ge.fetchProjectList()]);try{const e=await ke.callAPI({table:"account_receivable",action:"read"});e&&Array.isArray(e)&&(je.value=e)}catch(e){}await Ze()}),(e,a)=>(k(),i("div",j,[u("div",C,[a[10]||(a[10]=u("h1",null,"會計財務",-1)),u("button",{onClick:a[0]||(a[0]=e=>Ve.value=!0),class:"btn btn-primary"}," 申請付款 ")]),u("div",S,[(k(),i(o,null,r(Re,e=>u("button",{key:e.key,onClick:a=>Se.value=e.key,class:b(["tab-btn",{active:Se.value===e.key}])},y(e.label),11,D)),64))]),"payments"===Se.value?(k(),i("div",q,[u("div",P,[d(u("select",{"onUpdate:modelValue":a[1]||(a[1]=e=>De.value=e),class:"filter-select"},a[11]||(a[11]=[p('<option value="" data-v-c806c16d>所有狀態</option><option value="pending" data-v-c806c16d>待審核</option><option value="approved" data-v-c806c16d>已核准</option><option value="paid" data-v-c806c16d>已匯款</option><option value="rejected" data-v-c806c16d>已拒絕</option>',5)]),512),[[v,De.value]]),d(u("select",{"onUpdate:modelValue":a[2]||(a[2]=e=>qe.value=e),class:"sort-select"},a[12]||(a[12]=[u("option",{value:"created_at"},"依申請時間排序",-1),u("option",{value:"amount"},"依金額排序",-1)]),512),[[v,qe.value]])]),Ce.value?(k(),i("div",T,"載入中...")):0===Me.value.length?(k(),i("div",A,a[13]||(a[13]=[u("div",{class:"empty-icon"},"💰",-1),u("p",null,"尚無付款記錄",-1)]))):(k(),i("div",V,[(k(!0),i(o,null,r(Me.value,e=>{return k(),i("div",{key:e.id,class:"payment-card"},[u("div",I,[u("div",L,[u("h3",null,y(e.description),1),u("p",U," 申請人："+y(Ye(e.employee_id))+" • "+y(Be(e.created_at)),1),Je(e.project_id)?(k(),i("div",R,[a[14]||(a[14]=u("span",{class:"project-label"},"關聯專案：",-1)),u("span",N,y(Je(e.project_id)),1)])):c("",!0)]),u("div",$," NT$ "+y((e.amount||0).toLocaleString()),1)]),u("div",x,[u("span",{class:b(["status-badge",(t=e.status,{pending:"status-pending",approved:"status-approved",paid:"status-paid",rejected:"status-rejected"}[t]||"")])},y(Ge(e.status)),3),We(e)?(k(),i("div",O,["pending"===e.status&&$e.value?(k(),i("button",{key:0,onClick:a=>(async e=>{await ge.approvePaymentRequest(e.id)})(e),class:"btn btn-sm btn-success"}," 同意申請 ",8,F)):c("",!0),"pending"===e.status&&$e.value?(k(),i("button",{key:1,onClick:a=>(async e=>{await ke.update("payment_requests",e.id,{status:"rejected",approved_at:(new Date).toISOString()}),await ge.fetchPaymentRequests()})(e),class:"btn btn-sm btn-danger"}," 拒絕 ",8,z)):c("",!0),"approved"===e.status&&xe.value?(k(),i("button",{key:2,onClick:a=>(async e=>{await ke.update("payment_requests",e.id,{status:"paid",paid_at:(new Date).toISOString()}),await ge.fetchPaymentRequests()})(e),class:"btn btn-sm btn-primary"}," 完成付款 ",8,M)):c("",!0)])):c("",!0)])]);var t}),128))]))])):"receivables"===Se.value?(k(),i("div",Y,[u("div",B,[d(u("select",{"onUpdate:modelValue":a[3]||(a[3]=e=>Pe.value=e),class:"filter-select"},a[15]||(a[15]=[u("option",{value:""},"所有狀態",-1),u("option",{value:"pending"},"待收款",-1),u("option",{value:"completed"},"已收款",-1)]),512),[[v,Pe.value]]),d(u("select",{"onUpdate:modelValue":a[4]||(a[4]=e=>Te.value=e),class:"sort-select"},a[16]||(a[16]=[u("option",{value:"created_at"},"依建立時間排序",-1),u("option",{value:"amount"},"依金額排序",-1)]),512),[[v,Te.value]])]),Ce.value?(k(),i("div",G,"載入中...")):0===ze.value.length?(k(),i("div",W,a[17]||(a[17]=[u("div",{class:"empty-icon"},"📈",-1),u("p",null,"尚無收款記錄",-1)]))):(k(),i("div",E,[(k(!0),i(o,null,r(ze.value,e=>{return k(),i("div",{key:e.id,class:"receivable-card"},[u("div",H,[u("div",J,[u("h3",null,y(e.description||"收款項目"),1),u("p",K," 專案："+y(Ke(e.project_id))+" • "+y(Be(e.created_at)),1),e.reviewer_id?(k(),i("div",Q,[a[18]||(a[18]=u("span",{class:"reviewer-label"},"審核人：",-1)),u("span",X,y(Ye(e.reviewer_id)),1)])):c("",!0)]),u("div",Z," NT$ "+y((e.amount||0).toLocaleString()),1)]),u("div",ee,[u("span",{class:b(["status-badge",(t=e.status,{pending:"status-pending",completed:"status-received"}[t]||"status-pending")])},y(Qe(e.status)),3),Xe(e)?(k(),i("div",ae,["pending"===e.status&&xe.value?(k(),i("button",{key:0,onClick:a=>(async e=>{try{await ke.callAPI({table:"account_receivable",action:"update",data:{id:e.id,status:"completed",received_at:(new Date).toISOString()}});try{const e=await ke.callAPI({table:"account_receivable",action:"read"});e&&Array.isArray(e)&&(je.value=e)}catch(a){}}catch(a){}})(e),class:"btn btn-sm btn-success"}," 完成收款 ",8,te)):c("",!0)])):c("",!0)])]);var t}),128))]))])):"reports"===Se.value?(k(),i("div",le,[u("div",se,[d(u("input",{type:"month","onUpdate:modelValue":a[5]||(a[5]=e=>Ae.value=e),class:"month-input"},null,512),[[m,Ae.value]]),u("button",{onClick:Ze,class:"btn btn-outline"},"產生報表")]),u("div",ne,[u("div",ie,[a[19]||(a[19]=u("h3",null,"本月收入",-1)),u("div",ue,"NT$ "+y(Le.value.toLocaleString()),1)]),u("div",ce,[a[20]||(a[20]=u("h3",null,"本月支出",-1)),u("div",oe,"NT$ "+y(Ue.value.toLocaleString()),1)]),u("div",re,[a[21]||(a[21]=u("h3",null,"淨利潤",-1)),u("div",{class:b(["amount",Oe.value>=0?"profit":"loss"])}," NT$ "+y(Oe.value.toLocaleString()),3)])])])):c("",!0),Ve.value?(k(),i("div",{key:3,class:"modal-overlay",onClick:He},[u("div",{class:"modal",onClick:a[9]||(a[9]=g(()=>{},["stop"]))},[u("div",{class:"modal-header"},[a[22]||(a[22]=u("h2",null,"申請付款",-1)),u("button",{onClick:He,class:"close-btn"},"×")]),u("form",{onSubmit:g(Ee,["prevent"]),class:"modal-body"},[u("div",de,[a[23]||(a[23]=u("label",null,"付款金額 *",-1)),d(u("input",{"onUpdate:modelValue":a[6]||(a[6]=e=>Ne.value.amount=e),type:"number",min:"1",required:"",placeholder:"請輸入金額"},null,512),[[m,Ne.value.amount,void 0,{number:!0}]])]),u("div",ve,[a[25]||(a[25]=u("label",null,"關聯專案",-1)),d(u("select",{"onUpdate:modelValue":a[7]||(a[7]=e=>Ne.value.project_id=e),class:"form-select"},[a[24]||(a[24]=u("option",{value:""},"請選擇專案（可選）",-1)),(k(!0),i(o,null,r(Fe.value,e=>(k(),i("option",{key:e.id,value:e.id},y(e.project_name),9,pe))),128))],512),[[v,Ne.value.project_id]])]),u("div",me,[a[26]||(a[26]=u("label",null,"付款說明 *",-1)),d(u("textarea",{"onUpdate:modelValue":a[8]||(a[8]=e=>Ne.value.description=e),rows:"4",required:"",placeholder:"請詳細說明付款用途..."},null,512),[[m,Ne.value.description]])]),u("div",ye,[u("button",{type:"button",onClick:He,class:"btn btn-outline"}," 取消 "),u("button",{type:"submit",class:"btn btn-primary",disabled:Ie.value},y(Ie.value?"提交中...":"提交申請"),9,be)])],32)])])):c("",!0)]))}}),[["__scopeId","data-v-c806c16d"]]);export{ge as default};
