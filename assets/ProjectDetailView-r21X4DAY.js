import{a as e,v as a,c as l,r as t,j as i,e as n,f as u,i as s,t as o,G as d,F as r,g as c,n as v,y as m,z as p,A as b,C as y,l as _,u as f,o as k}from"./vue-Cvy1YwU9.js";import{a as g,b as h,_ as j}from"./index-m2nXL6kR.js";import"./vendor-BV1FDJi5.js";const C={key:0,class:"project-detail"},w={class:"detail-header"},S={class:"project-info-card"},I={class:"info-grid"},L={class:"info-item"},V={class:"info-item"},x={class:"info-item"},U={class:"info-item"},N={class:"info-item"},P={class:"amount"},A={class:"info-item"},D={class:"main-content-grid"},T={class:"content-card"},$={key:0,class:"empty-state"},q={key:1},z={class:"details-table"},O={class:"td-item"},W={key:0},E={key:1},F={class:"td-amount"},G={key:0,class:"amount-negative"},M={key:1,class:"amount-na"},R={class:"td-note"},B={class:"td-actions"},H=["onClick"],J={class:"cost-summary"},K={class:"summary-item"},Q={class:"amount-negative"},X={class:"summary-item"},Y={class:"amount-positive"},Z={class:"summary-item total"},ee={class:"content-card"},ae={class:"card-header"},le={key:0,class:"empty-state"},te={key:1,class:"reminders-compact"},ie={class:"reminder-main"},ne={class:"reminder-time"},ue={class:"reminder-note"},se={class:"reminder-actions"},oe=["onClick"],de=["onClick"],re={key:2,class:"reminder-form-compact"},ce={class:"form-header"},ve={class:"form-row"},me={class:"form-field"},pe={class:"form-field"},be={class:"form-field"},ye={class:"form-actions"},_e={type:"submit",class:"btn btn-primary"},fe={class:"form-group"},ke={class:"form-group"},ge=["value"],he={class:"form-group"},je=["value"],Ce={class:"form-group"},we=["value"],Se={class:"form-group"},Ie=["value"],Le={class:"form-group"},Ve={class:"modal-actions"},xe=["disabled"],Ue={class:"modal-header"},Ne={class:"form-group"},Pe=["value"],Ae={class:"form-group"},De=["value"],Te={class:"form-group"},$e={class:"form-group"},qe={class:"modal-actions"},ze=["disabled"],Oe={key:1,class:"loading"},We=j(e({__name:"ProjectDetailView",setup(e){const j=f(),We=g(),Ee=h(),{crmList:Fe,inventoryList:Ge,supplier:Me,employee:Re,tags:Be}=a(We),He=l(()=>Me.value||[]),Je=l(()=>Re.value||[]),Ke=l(()=>(Be.value||[]).filter(e=>"project"===e.type)),Qe=l(()=>(Be.value||[]).filter(e=>"project_state"===e.type)),Xe=t(null),Ye=t([]),Ze=t([]),ea=t(!1),aa=t(!1),la=t(!1),ta=t(!1),ia=t(null),na=t(null),ua=t(!1),sa=t({supplier_id:null,inventory_id:null,pay:0,note:""}),oa=t({project_name:"",crm_id:"",tag_course:"",project_state:"",executor_id:"",receivable:0,final:""}),da=t({start_time:"",end_time:"",note:""}),ra=l(()=>Ye.value.reduce((e,a)=>e+a.pay,0)),ca=l(()=>{var e;return((null==(e=Xe.value)?void 0:e.receivable)||0)-ra.value}),va=e=>{const a=Fe.value.find(a=>a.id===e);return(null==a?void 0:a.name)||"æœªæŒ‡å®š"},ma=e=>{if(!e)return"æœªæŒ‡å®š";const a=Je.value.find(a=>a.id===e);return a?a.name:e},pa=e=>{if(!e)return"æœªæŒ‡å®š";const a=Ge.value.find(a=>String(a.id)===String(e));return(null==a?void 0:a.name)||`åº«å­˜ID: ${e}`},ba=e=>{if(!e)return"æœªæŒ‡å®š";const a=He.value.find(a=>a.id===Number(e));return a?a.name:`ä¾›æ‡‰å•†ID: ${e}`},ya=e=>new Date(e).toLocaleString("zh-TW"),_a=()=>{Xe.value&&(oa.value={project_name:Xe.value.project_name,crm_id:Xe.value.crm_id,tag_course:Xe.value.tag_course||"",project_state:Xe.value.project_state||"",executor_id:Xe.value.executor_id||"",receivable:Xe.value.receivable,final:Xe.value.final||""},aa.value=!0)},fa=()=>{ea.value=!0},ka=()=>{ea.value=!1,la.value=!1,na.value=null,sa.value={supplier_id:null,inventory_id:null,pay:0,note:""}},ga=()=>{aa.value=!1,oa.value={project_name:"",crm_id:"",tag_course:"",project_state:"",executor_id:"",receivable:0,final:""}},ha=async()=>{if(Xe.value){ua.value=!0;try{if(na.value){await Ee.callAPI({table:"project_detail",action:"update",data:{id:na.value.id,...sa.value}});const e=Ye.value.findIndex(e=>e.id===na.value.id);-1!==e&&(Ye.value[e]={...na.value,...sa.value})}else{const e={supplier_id:sa.value.supplier_id?Number(sa.value.supplier_id):null,inventory_id:sa.value.inventory_id?Number(sa.value.inventory_id):null,pay:Number(sa.value.pay)||0,note:sa.value.note||null,project_id:Number(Xe.value.id)},a=await Ee.callAPI({table:"project_detail",action:"create",data:e});a&&Ye.value.push(a)}ka()}catch(e){alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}finally{ua.value=!1}}},ja=async()=>{if(Xe.value){ua.value=!0;try{await Ee.callAPI({table:"project",action:"update",data:{id:Xe.value.id,...oa.value}}),Xe.value={...Xe.value,...oa.value},ga(),alert("å°ˆæ¡ˆæ›´æ–°æˆåŠŸ")}catch(e){alert("æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}finally{ua.value=!1}}},Ca=async()=>{if(Xe.value)try{ia.value?await Ee.callAPI({table:"reminder",action:"update",data:{id:ia.value.id,...da.value}}):await Ee.callAPI({table:"reminder",action:"create",data:{project_id:Xe.value.id,...da.value}}),await Sa(),wa()}catch(e){alert("å„²å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}},wa=()=>{ta.value=!1,ia.value=null,da.value={start_time:"",end_time:"",note:""}},Sa=async()=>{const e=j.params.id;try{const a=await Ee.callAPI({table:"reminder",action:"read",filters:{project_id:e}});a&&(Ze.value=a)}catch(a){}},Ia=async()=>{const e=j.params.id,a=await Ee.query("project","*",{id:e});a&&a.length>0&&(Xe.value=a[0]);const l=await Ee.query("project_detail","*",{project_id:e});l&&(Ye.value=l),await Sa()};return i(async()=>{await Promise.all([Ia(),We.fetchCRMList(),We.fetchInventoryList(),We.fetchSupplierList(),We.fetchEmployeeList(),We.fetchTagList()])}),(e,a)=>{return Xe.value?(k(),n("div",C,[u("div",w,[u("button",{onClick:a[0]||(a[0]=a=>e.$router.back()),class:"back-btn"}," â† è¿”å› "),u("h1",null,o(Xe.value.project_name),1),u("button",{onClick:_a,class:"btn btn-primary"}," ç·¨è¼¯å°ˆæ¡ˆ ")]),u("div",S,[u("div",{class:"info-header"},[a[17]||(a[17]=u("h3",null,"å°ˆæ¡ˆè³‡è¨Š",-1)),u("button",{onClick:_a,class:"btn btn-primary"},"ç·¨è¼¯å°ˆæ¡ˆ")]),u("div",I,[u("div",L,[a[18]||(a[18]=u("label",null,"å°ˆæ¡ˆåç¨±",-1)),u("span",null,o(Xe.value.project_name),1)]),u("div",V,[a[19]||(a[19]=u("label",null,"å®¢æˆ¶",-1)),u("span",null,o(va(Xe.value.crm_id)),1)]),u("div",x,[a[20]||(a[20]=u("label",null,"èª²ç¨‹æ¨™ç±¤",-1)),u("span",null,o(Xe.value.tag_course||"-"),1)]),u("div",U,[a[21]||(a[21]=u("label",null,"è² è²¬äºº",-1)),u("span",null,o(ma(Xe.value.executor_id)),1)]),u("div",N,[a[22]||(a[22]=u("label",null,"æ‡‰æ”¶é‡‘é¡",-1)),u("span",P,"NT$ "+o(Xe.value.receivable.toLocaleString()),1)]),u("div",A,[a[23]||(a[23]=u("label",null,"å»ºç«‹æ™‚é–“",-1)),u("span",null,o((l=Xe.value.created_at,new Date(l).toLocaleDateString("zh-TW"))),1)])])]),u("div",D,[u("div",T,[u("div",{class:"card-header"},[a[24]||(a[24]=u("h3",null,"å°ˆæ¡ˆæ˜ç´°",-1)),u("button",{onClick:fa,class:"btn btn-sm btn-primary"},"æ–°å¢æ˜ç´°")]),0===Ye.value.length?(k(),n("div",$,a[25]||(a[25]=[u("p",null,"å°šç„¡å°ˆæ¡ˆæ˜ç´°",-1)]))):(k(),n("div",q,[u("div",z,[a[26]||(a[26]=d('<div class="table-header" data-v-09dc91da><div class="th-item" data-v-09dc91da>é …ç›®</div><div class="th-amount" data-v-09dc91da>é‡‘é¡</div><div class="th-note" data-v-09dc91da>å‚™è¨»</div><div class="th-actions" data-v-09dc91da>æ“ä½œ</div></div>',1)),(k(!0),n(r,null,c(Ye.value,e=>(k(),n("div",{key:e.id,class:"table-row"},[u("div",O,[e.supplier_id?(k(),n("span",W,"ä¾›æ‡‰å•†ï¼š"+o(ba(e.supplier_id)),1)):e.inventory_id?(k(),n("span",E,"åº«å­˜ï¼š"+o(pa(e.inventory_id)),1)):s("",!0)]),u("div",F,[e.supplier_id&&e.pay?(k(),n("span",G," NT$ "+o(e.pay.toLocaleString()),1)):(k(),n("span",M,"-"))]),u("div",R,o(e.note||"-"),1),u("div",B,[u("button",{onClick:a=>(e=>{na.value=e,sa.value={supplier_id:e.supplier_id?Number(e.supplier_id):null,inventory_id:e.inventory_id?Number(e.inventory_id):null,pay:e.pay||0,note:e.note||""},la.value=!0})(e),class:"btn-icon"},"âœï¸",8,H)])]))),128))]),u("div",J,[u("div",K,[a[27]||(a[27]=u("span",null,"ç¸½æ”¯å‡ºï¼š",-1)),u("span",Q,"NT$ "+o(ra.value.toLocaleString()),1)]),u("div",X,[a[28]||(a[28]=u("span",null,"æ‡‰æ”¶é‡‘é¡ï¼š",-1)),u("span",Y,"NT$ "+o((Xe.value.receivable||0).toLocaleString()),1)]),u("div",Z,[a[29]||(a[29]=u("span",null,"æ·¨åˆ©æ½¤ï¼š",-1)),u("span",{class:v(ca.value>=0?"amount-positive":"amount-negative")}," NT$ "+o(ca.value.toLocaleString()),3)])])]))]),u("div",ee,[u("div",ae,[a[30]||(a[30]=u("h3",null,"å°ˆæ¡ˆæé†’",-1)),u("button",{onClick:a[1]||(a[1]=e=>ta.value=!0),class:"btn btn-sm btn-primary"},"æ–°å¢æé†’")]),0===Ze.value.length?(k(),n("div",le,a[31]||(a[31]=[u("p",null,"å°šç„¡å°ˆæ¡ˆæé†’",-1)]))):(k(),n("div",te,[(k(!0),n(r,null,c(Ze.value,e=>(k(),n("div",{key:e.id,class:"reminder-compact"},[u("div",ie,[u("div",ne,o(ya(e.start_time)),1),u("div",ue,o(e.note),1)]),u("div",se,[u("button",{onClick:a=>(e=>{ia.value=e,da.value={start_time:new Date(e.start_time).toISOString().slice(0,16),end_time:e.end_time?new Date(e.end_time).toISOString().slice(0,16):"",note:e.note}})(e),class:"btn-icon"},"âœï¸",8,oe),u("button",{onClick:a=>(async e=>{if(confirm("ç¢ºå®šè¦åˆªé™¤æ­¤æé†’å—ï¼Ÿ"))try{await Ee.callAPI({table:"reminder",action:"delete",data:{id:e}}),await Sa()}catch(a){alert("åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦")}})(e.id),class:"btn-icon"},"ğŸ—‘ï¸",8,de)])]))),128))])),ta.value||ia.value?(k(),n("div",re,[u("div",ce,[u("h4",null,o(ia.value?"ç·¨è¼¯æé†’":"æ–°å¢æé†’"),1),u("button",{onClick:wa,class:"btn-icon"},"âœ•")]),u("form",{onSubmit:m(Ca,["prevent"]),class:"form-grid"},[u("div",ve,[u("div",me,[a[32]||(a[32]=u("label",null,"é–‹å§‹æ™‚é–“ *",-1)),p(u("input",{"onUpdate:modelValue":a[2]||(a[2]=e=>da.value.start_time=e),type:"datetime-local",required:""},null,512),[[b,da.value.start_time]])]),u("div",pe,[a[33]||(a[33]=u("label",null,"çµæŸæ™‚é–“",-1)),p(u("input",{"onUpdate:modelValue":a[3]||(a[3]=e=>da.value.end_time=e),type:"datetime-local"},null,512),[[b,da.value.end_time]])])]),u("div",be,[a[34]||(a[34]=u("label",null,"æé†’å…§å®¹ *",-1)),p(u("textarea",{"onUpdate:modelValue":a[4]||(a[4]=e=>da.value.note=e),rows:"2",required:"",placeholder:"è«‹è¼¸å…¥æé†’å…§å®¹..."},null,512),[[b,da.value.note]])]),u("div",ye,[u("button",{type:"button",onClick:wa,class:"btn btn-outline"},"å–æ¶ˆ"),u("button",_e,o(ia.value?"æ›´æ–°":"æ–°å¢"),1)])],32)])):s("",!0)])]),aa.value?(k(),n("div",{key:0,class:"modal-overlay",onClick:ga},[u("div",{class:"modal",onClick:a[11]||(a[11]=m(()=>{},["stop"]))},[u("div",{class:"modal-header"},[a[35]||(a[35]=u("h2",null,"ç·¨è¼¯å°ˆæ¡ˆ",-1)),u("button",{onClick:ga,class:"close-btn"},"Ã—")]),u("form",{onSubmit:m(ja,["prevent"]),class:"modal-body"},[u("div",fe,[a[36]||(a[36]=u("label",null,"å°ˆæ¡ˆåç¨± *",-1)),p(u("input",{"onUpdate:modelValue":a[5]||(a[5]=e=>oa.value.project_name=e),type:"text",required:""},null,512),[[b,oa.value.project_name]])]),u("div",ke,[a[38]||(a[38]=u("label",null,"å®¢æˆ¶ *",-1)),p(u("select",{"onUpdate:modelValue":a[6]||(a[6]=e=>oa.value.crm_id=e),required:""},[a[37]||(a[37]=u("option",{value:""},"è«‹é¸æ“‡å®¢æˆ¶",-1)),(k(!0),n(r,null,c(_(Fe),e=>(k(),n("option",{key:e.id,value:e.id},o(e.name),9,ge))),128))],512),[[y,oa.value.crm_id]])]),u("div",he,[a[40]||(a[40]=u("label",null,"æ´»å‹•é¡å‹",-1)),p(u("select",{"onUpdate:modelValue":a[7]||(a[7]=e=>oa.value.tag_course=e)},[a[39]||(a[39]=u("option",{value:""},"è«‹é¸æ“‡æ´»å‹•é¡å‹",-1)),(k(!0),n(r,null,c(Ke.value,e=>(k(),n("option",{key:e.id,value:e.name},o(e.name),9,je))),128))],512),[[y,oa.value.tag_course]])]),u("div",Ce,[a[42]||(a[42]=u("label",null,"å°ˆæ¡ˆç‹€æ…‹",-1)),p(u("select",{"onUpdate:modelValue":a[8]||(a[8]=e=>oa.value.project_state=e)},[a[41]||(a[41]=u("option",{value:""},"è«‹é¸æ“‡å°ˆæ¡ˆç‹€æ…‹",-1)),(k(!0),n(r,null,c(Qe.value,e=>(k(),n("option",{key:e.id,value:e.name},o(e.name),9,we))),128))],512),[[y,oa.value.project_state]])]),u("div",Se,[a[44]||(a[44]=u("label",null,"è² è²¬äºº",-1)),p(u("select",{"onUpdate:modelValue":a[9]||(a[9]=e=>oa.value.executor_id=e)},[a[43]||(a[43]=u("option",{value:""},"è«‹é¸æ“‡è² è²¬äºº",-1)),(k(!0),n(r,null,c(Je.value,e=>(k(),n("option",{key:e.id,value:e.id},o(e.name),9,Ie))),128))],512),[[y,oa.value.executor_id]])]),u("div",Le,[a[45]||(a[45]=u("label",null,"æ‡‰æ”¶é‡‘é¡",-1)),p(u("input",{"onUpdate:modelValue":a[10]||(a[10]=e=>oa.value.receivable=e),type:"number",min:"0"},null,512),[[b,oa.value.receivable,void 0,{number:!0}]])]),u("div",Ve,[u("button",{type:"button",onClick:ga,class:"btn btn-outline"}," å–æ¶ˆ "),u("button",{type:"submit",class:"btn btn-primary",disabled:ua.value},o(ua.value?"æ›´æ–°ä¸­...":"æ›´æ–°"),9,xe)])],32)])])):s("",!0),ea.value||la.value?(k(),n("div",{key:1,class:"modal-overlay",onClick:ka},[u("div",{class:"modal",onClick:a[16]||(a[16]=m(()=>{},["stop"]))},[u("div",Ue,[u("h2",null,o(na.value?"ç·¨è¼¯å°ˆæ¡ˆæ˜ç´°":"æ–°å¢å°ˆæ¡ˆæ˜ç´°"),1),u("button",{onClick:ka,class:"close-btn"},"Ã—")]),u("form",{onSubmit:m(ha,["prevent"]),class:"modal-body"},[u("div",Ne,[a[47]||(a[47]=u("label",null,"ä¾›æ‡‰å•†",-1)),p(u("select",{"onUpdate:modelValue":a[12]||(a[12]=e=>sa.value.supplier_id=e)},[a[46]||(a[46]=u("option",{value:""},"è«‹é¸æ“‡ä¾›æ‡‰å•†",-1)),(k(!0),n(r,null,c(He.value,e=>(k(),n("option",{key:e.id,value:e.id},o(e.name),9,Pe))),128))],512),[[y,sa.value.supplier_id]])]),u("div",Ae,[a[49]||(a[49]=u("label",null,"åº«å­˜å“é …",-1)),p(u("select",{"onUpdate:modelValue":a[13]||(a[13]=e=>sa.value.inventory_id=e)},[a[48]||(a[48]=u("option",{value:""},"è«‹é¸æ“‡åº«å­˜å“é …",-1)),(k(!0),n(r,null,c(_(Ge),e=>(k(),n("option",{key:e.id,value:e.id},o(e.name),9,De))),128))],512),[[y,sa.value.inventory_id]])]),u("div",Te,[a[50]||(a[50]=u("label",null,"æ”¯å‡ºé‡‘é¡ *",-1)),p(u("input",{"onUpdate:modelValue":a[14]||(a[14]=e=>sa.value.pay=e),type:"number",min:"0",required:""},null,512),[[b,sa.value.pay,void 0,{number:!0}]])]),u("div",$e,[a[51]||(a[51]=u("label",null,"å‚™è¨»",-1)),p(u("textarea",{"onUpdate:modelValue":a[15]||(a[15]=e=>sa.value.note=e),rows:"3"},null,512),[[b,sa.value.note]])]),u("div",qe,[u("button",{type:"button",onClick:ka,class:"btn btn-outline"}," å–æ¶ˆ "),u("button",{type:"submit",class:"btn btn-primary",disabled:ua.value},o(ua.value?na.value?"æ›´æ–°ä¸­...":"æ–°å¢ä¸­...":na.value?"æ›´æ–°":"æ–°å¢"),9,ze)])],32)])])):s("",!0)])):(k(),n("div",Oe," è¼‰å…¥ä¸­... "));var l}}}),[["__scopeId","data-v-09dc91da"]]);export{We as default};
